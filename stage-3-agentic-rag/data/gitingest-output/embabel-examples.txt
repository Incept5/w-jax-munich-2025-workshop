Directory structure:
â””â”€â”€ embabel-embabel-agent-examples/
    â”œâ”€â”€ README.md
    â”œâ”€â”€ README.zh-CN.md
    â”œâ”€â”€ docker-compose.yml
    â”œâ”€â”€ LICENSE
    â”œâ”€â”€ mvnw
    â”œâ”€â”€ mvnw.cmd
    â”œâ”€â”€ pom.xml
    â”œâ”€â”€ books/
    â”‚   â””â”€â”€ cane_toad_adventures-a_fun_guide_for_kids.md
    â”œâ”€â”€ examples-common/
    â”‚   â”œâ”€â”€ pom.xml
    â”‚   â””â”€â”€ src/
    â”‚       â””â”€â”€ main/
    â”‚           â””â”€â”€ kotlin/
    â”‚               â””â”€â”€ com/
    â”‚                   â””â”€â”€ embabel/
    â”‚                       â””â”€â”€ example/
    â”‚                           â”œâ”€â”€ common/
    â”‚                           â”‚   â””â”€â”€ InMemoryCrudRepository.kt
    â”‚                           â””â”€â”€ horoscope/
    â”‚                               â””â”€â”€ HoroscopeService.kt
    â”œâ”€â”€ examples-java/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ pom.xml
    â”‚   â””â”€â”€ src/
    â”‚       â”œâ”€â”€ main/
    â”‚       â”‚   â”œâ”€â”€ java/
    â”‚       â”‚   â”‚   â””â”€â”€ com/
    â”‚       â”‚   â”‚       â””â”€â”€ embabel/
    â”‚       â”‚   â”‚           â””â”€â”€ example/
    â”‚       â”‚   â”‚               â”œâ”€â”€ JavaAgentShellApplication.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ JavaAgentSimpleShellApplication.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ JavaMcpServerApplication.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ crew/
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ README.md
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ bookwriter/
    â”‚       â”‚   â”‚               â”‚       â”œâ”€â”€ README.md
    â”‚       â”‚   â”‚               â”‚       â””â”€â”€ BookWriter.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ factchecker/
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ FactChecker.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ handoff/
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ Handoff.java
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ Subagents.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ horoscope/
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ Horoscope.java
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ StarNewsFinder.java
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ StarPerson.java
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ Starry.java
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ Writeup.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ injection/
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ InjectedComponent.java
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ JokeShellCommands.java
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ travel/
    â”‚       â”‚   â”‚               â”‚       â”œâ”€â”€ ActivitySummarizer.java
    â”‚       â”‚   â”‚               â”‚       â”œâ”€â”€ DummyTravelActivityReportingService.java
    â”‚       â”‚   â”‚               â”‚       â”œâ”€â”€ TravelerActivityReport.java
    â”‚       â”‚   â”‚               â”‚       â”œâ”€â”€ TravellerActivity.java
    â”‚       â”‚   â”‚               â”‚       â””â”€â”€ Trip.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ pydantic/
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ README.md
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ banksupport/
    â”‚       â”‚   â”‚               â”‚       â”œâ”€â”€ README.md
    â”‚       â”‚   â”‚               â”‚       â”œâ”€â”€ InMemoryCustomerRepository.java
    â”‚       â”‚   â”‚               â”‚       â”œâ”€â”€ SupportAgent.java
    â”‚       â”‚   â”‚               â”‚       â””â”€â”€ SupportAgentShellCommands.java
    â”‚       â”‚   â”‚               â”œâ”€â”€ repeatuntil/
    â”‚       â”‚   â”‚               â”‚   â”œâ”€â”€ GoatWriterConfig.java
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ ReviseStoryUntilSatisfied.java
    â”‚       â”‚   â”‚               â””â”€â”€ wikipedia/
    â”‚       â”‚   â”‚                   â”œâ”€â”€ ResearchSubject.java
    â”‚       â”‚   â”‚                   â””â”€â”€ WikiAgent.java
    â”‚       â”‚   â””â”€â”€ resources/
    â”‚       â”‚       â”œâ”€â”€ application-observability.yml
    â”‚       â”‚       â”œâ”€â”€ application.properties
    â”‚       â”‚       â”œâ”€â”€ application.yml
    â”‚       â”‚       â””â”€â”€ prompts/
    â”‚       â”‚           â””â”€â”€ factchecker/
    â”‚       â”‚               â””â”€â”€ consolidate_assertions.jinja
    â”‚       â””â”€â”€ test/
    â”‚           â””â”€â”€ java/
    â”‚               â””â”€â”€ com/
    â”‚                   â””â”€â”€ embabel/
    â”‚                       â””â”€â”€ example/
    â”‚                           â”œâ”€â”€ horoscope/
    â”‚                           â”‚   â””â”€â”€ StarNewsFinderTest.java
    â”‚                           â””â”€â”€ injection/
    â”‚                               â”œâ”€â”€ InjectedComponentTest.java
    â”‚                               â””â”€â”€ travel/
    â”‚                                   â””â”€â”€ ActivitySummarizerTest.java
    â”œâ”€â”€ examples-kotlin/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ pom.xml
    â”‚   â””â”€â”€ src/
    â”‚       â”œâ”€â”€ main/
    â”‚       â”‚   â”œâ”€â”€ kotlin/
    â”‚       â”‚   â”‚   â””â”€â”€ com/
    â”‚       â”‚   â”‚       â””â”€â”€ embabel/
    â”‚       â”‚   â”‚           â””â”€â”€ example/
    â”‚       â”‚   â”‚               â”œâ”€â”€ KotlinAgentMcpServerApplication.kt
    â”‚       â”‚   â”‚               â”œâ”€â”€ KotlinAgentShellApplication.kt
    â”‚       â”‚   â”‚               â”œâ”€â”€ KotlinAgentSimpleShellApplication.kt
    â”‚       â”‚   â”‚               â”œâ”€â”€ factchecker/
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ factChecker.kt
    â”‚       â”‚   â”‚               â”œâ”€â”€ horoscope/
    â”‚       â”‚   â”‚               â”‚   â””â”€â”€ StarNewsFinder.kt
    â”‚       â”‚   â”‚               â””â”€â”€ researcher/
    â”‚       â”‚   â”‚                   â””â”€â”€ Researcher.kt
    â”‚       â”‚   â””â”€â”€ resources/
    â”‚       â”‚       â”œâ”€â”€ application-observability.yml
    â”‚       â”‚       â””â”€â”€ application.properties
    â”‚       â””â”€â”€ test/
    â”‚           â””â”€â”€ kotlin/
    â”‚               â””â”€â”€ com/
    â”‚                   â””â”€â”€ embabel/
    â”‚                       â””â”€â”€ example/
    â”‚                           â””â”€â”€ horoscope/
    â”‚                               â””â”€â”€ StarNewsFinderTest.kt
    â”œâ”€â”€ scripts/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ java/
    â”‚   â”‚   â”œâ”€â”€ mcp_server.cmd
    â”‚   â”‚   â”œâ”€â”€ mcp_server.sh
    â”‚   â”‚   â”œâ”€â”€ shell.cmd
    â”‚   â”‚   â””â”€â”€ shell.sh
    â”‚   â”œâ”€â”€ kotlin/
    â”‚   â”‚   â”œâ”€â”€ mcp_server.cmd
    â”‚   â”‚   â”œâ”€â”€ mcp_server.sh
    â”‚   â”‚   â”œâ”€â”€ shell.cmd
    â”‚   â”‚   â””â”€â”€ shell.sh
    â”‚   â””â”€â”€ support/
    â”‚       â”œâ”€â”€ agent.bat
    â”‚       â”œâ”€â”€ agent.sh
    â”‚       â”œâ”€â”€ check_env.bat
    â”‚       â”œâ”€â”€ check_env.sh
    â”‚       â”œâ”€â”€ shell_template.bat
    â”‚       â””â”€â”€ shell_template.sh
    â”œâ”€â”€ .embabel/
    â”‚   â””â”€â”€ make_scripts_executable.cmd
    â”œâ”€â”€ .github/
    â”‚   â””â”€â”€ workflows/
    â”‚       â””â”€â”€ maven.yml
    â””â”€â”€ .mvn/
        â””â”€â”€ wrapper/
            â””â”€â”€ maven-wrapper.properties

================================================
FILE: README.md
================================================
# ğŸ¤– Embabel Agent Examples

<img align="left" src="https://github.com/embabel/embabel-agent/blob/main/embabel-agent-api/images/315px-Meister_der_Weltenchronik_001.jpg?raw=true" width="180">


![Build](https://github.com/embabel/embabel-agent-examples/actions/workflows/maven.yml/badge.svg)

[//]: # ([![Quality Gate Status]&#40;https://sonarcloud.io/api/project_badges/measure?project=embabel_embabel-agent&metric=alert_status&token=d275d89d09961c114b8317a4796f84faf509691c&#41;]&#40;https://sonarcloud.io/summary/new_code?id=embabel_embabel-agent&#41;)

[//]: # ([![Bugs]&#40;https://sonarcloud.io/api/project_badges/measure?project=embabel_embabel-agent&metric=bugs&#41;]&#40;https://sonarcloud.io/summary/new_code?id=embabel_embabel-agent&#41;)

![Kotlin](https://img.shields.io/badge/kotlin-%237F52FF.svg?style=for-the-badge&logo=kotlin&logoColor=white)
![Java](https://img.shields.io/badge/java-%23ED8B00.svg?style=for-the-badge&logo=openjdk&logoColor=white)
![Spring](https://img.shields.io/badge/spring-%236DB33F.svg?style=for-the-badge&logo=spring&logoColor=white)
![Apache Tomcat](https://img.shields.io/badge/apache%20tomcat-%23F8DC75.svg?style=for-the-badge&logo=apache-tomcat&logoColor=black)
![Apache Maven](https://img.shields.io/badge/Apache%20Maven-C71A36?style=for-the-badge&logo=Apache%20Maven&logoColor=white)
![ChatGPT](https://img.shields.io/badge/chatGPT-74aa9c?style=for-the-badge&logo=openai&logoColor=white)
![Jinja](https://img.shields.io/badge/jinja-white.svg?style=for-the-badge&logo=jinja&logoColor=black)
![JSON](https://img.shields.io/badge/JSON-000?logo=json&logoColor=fff)
![GitHub Actions](https://img.shields.io/badge/github%20actions-%232671E5.svg?style=for-the-badge&logo=githubactions&logoColor=white)
![SonarQube](https://img.shields.io/badge/SonarQube-black?style=for-the-badge&logo=sonarqube&logoColor=4E9BCD)
![Docker](https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white)
![IntelliJ IDEA](https://img.shields.io/badge/IntelliJIDEA-000000.svg?style=for-the-badge&logo=intellij-idea&logoColor=white)

&nbsp;&nbsp;&nbsp;&nbsp;

**English** Â· [ç®€ä½“ä¸­æ–‡](./README.zh-CN.md)

Learn agentic AI development with **Spring Framework** and **Java** or **Kotlin**. These examples demonstrate building
intelligent agents that can plan, execute workflows, use tools, and interact with humans.

> This repository uses the latest Embabel snapshots to illustrate current best practice, whereas
> the [Java](https://github.com/embabel/java-agent-template)
> and [Kotlin](https://github.com/embabel/kotlin-agent-template)
> template repositories s use the latest milestone release for greater stability.
> There may be some minor API incompatilibites and not everything you see here may work in your own project created
> from one of those templates, unless you upgrade the `embabel-agent.version` property in the POM file, as in this
> repository.


## ğŸš€ Quick Start

### Prerequisites

- **Java 21+**
- **API Key** (at least one): [OpenAI](https://platform.openai.com/api-keys)
  or [Anthropic](https://www.anthropic.com/api)
- **Maven 3.9+** (optional - project includes Maven wrapper)

### 1. Clone & Build

```bash
git clone https://github.com/embabel/embabel-agent-examples.git
cd embabel-agent-examples
./mvnw clean install    # Unix/Linux/macOS
mvnw.cmd clean install  # Windows
```

### 2. Set API Keys

```bash
# Required (choose one or both)
export OPENAI_API_KEY="your_openai_key"
export ANTHROPIC_API_KEY="your_anthropic_key"

```

### 3. Run Examples

#### **Kotlin Examples**

```bash
cd scripts/kotlin
./shell.sh                    # Unix/Linux/macOS - Basic features
shell.cmd                     # Windows - Basic features

./shell.sh --docker-tools     # Unix/Linux/macOS - With Docker integration
shell.cmd --docker-tools      # Windows - With Docker integration
```

#### **Java Examples**

```bash
cd scripts/java
./shell.sh                    # Unix/Linux/macOS - Basic features
shell.cmd                     # Windows - Basic features

./shell.sh --docker-tools     # Unix/Linux/macOS - With Docker integration
shell.cmd --docker-tools      # Windows - With Docker integration
```

---

### Creating Your Own Project

You can create your own agent repo from our [Java](https://github.com/embabel/java-agent-template)
or [Kotlin](https://github.com/embabel/kotlin-agent-template) GitHub template by clicking the "Use this template"
button.

You can also create your own Embabel agent project locally with our quick start tool, which allows some customization:

```
uvx --from git+https://github.com/embabel/project-creator.git project-creator
```

Choose Java or Kotlin and specify your project name and package name and you'll have an agent running in under a minute,
if you already have an `OPENAI_API_KEY` and have Maven installed.

## ğŸ†• **Spring Boot Integration Architecture**

### **Embabel Agent Starter Guide:**

#### **`embabel-agent-starter`**

- âœ… Application decides on startup mode (console, web application, etc)
- âœ… Agent discovery and registration
- âœ… Agent Platform beans are available via Dependency Injection mechanism for Application to use as needed
- âœ… Progress tracking and logging
- âœ… Development-friendly error handling

#### **`embabel-agent-starter-shell`**

- âœ… Interactive command-line interface
- âœ… Agent discovery and registration
- âœ… Human-in-the-loop capabilities
- âœ… Progress tracking and logging
- âœ… Development-friendly error handling

#### **`embabel-agent-starter-mcpserver`**

- âœ… MCP protocol server implementation
- âœ… Tool registration and discovery
- âœ… JSON-RPC communication via SSE (Server-Sent Events)
- âœ… Integration with MCP-compatible clients
- âœ… Security and sandboxing

### **Three Application Modes**

The Embabel Agent framework provides three distinct application modes, each optimized for different use cases:

1. Interactive Shell Mode with Star Wars themed logging
```xml
<dependency>
    <groupId>com.embabel.agent</groupId>
    <artifactId>embabel-agent-starter-shell</artifactId>
</dependency>
```

```kotlin
@SpringBootApplication
@EnableAgents(loggingTheme = LoggingThemes.STAR_WARS)
class AgentShellApplication
```

2. Shell Mode with MCP Client Support (Docker Desktop integration)
```xml
<dependency>
    <groupId>com.embabel.agent</groupId>
    <artifactId>embabel-agent-starter-shell</artifactId>
</dependency>
```
```kotlin
@SpringBootApplication
@EnableAgents(
    loggingTheme = LoggingThemes.SEVERANCE,
    mcpServers = [McpServers.DOCKER_DESKTOP]
)
class AgentShellMcpClientApplication
```

3. MCP Server Mode
```xml
<dependency>
    <groupId>com.embabel.agent</groupId>
    <artifactId>embabel-agent-starter-mcpserver</artifactId>
</dependency>
```
```kotlin
@SpringBootApplication
@EnableAgents(mcpServers = [McpServers.DOCKER_DESKTOP])
class AgentMcpServerApplication
```

```java
// Java versions
@SpringBootApplication
@EnableAgents(
        loggingTheme = LoggingThemes.STAR_WARS,
        mcpServers = {McpServers.DOCKER_DESKTOP}
)
public class AgentShellApplication

@SpringBootApplication
@EnableAgents(mcpServers = {McpServers.DOCKER_DESKTOP})
public class AgentMcpApplication
```

### **Annotation Guide:**

#### **`@EnableAgents`**

- ğŸ¨ **loggingTheme**: Customize your agent's logging personality
    - `"starwars"` - May the Force be with your logs!
    - `"severance"` - Welcome to Lumon Industries (default)
- ğŸ³ **mcpServers**: Enable MCP client integrations
    - `"docker-desktop"` - Docker Desktop AI capabilities
    - Custom clients can be added

---

## Setting up MCP Tools

Several of the examples use the Model Context Protocol (MCP) to access tools and services.

The default source is the Docker Desktop MCP server, which is installed with Docker Desktop.

To ensure tools are available and startup doesn't time out, first pull models with:

```bash
docker login
docker mcp gateway run
```

When the gateway has come up you can kill it and start the Embabel server.

## ğŸ“š Examples by Learning Level

### ğŸ† **Beginner: InjectedComponent**

> **Available in:** Java | **Concept:** Just a Little AI

Demonstrates how you can inject any Spring component with an Embabel `OperationContext`
and use it to call LLMs with the rich Embabel API.

```java

@Component
public record InjectedComponent(Ai ai) {

    public record Joke(String leadup, String punchline) {
    }

    public String tellJokeAbout(String topic) {
        return ai
                .withDefaultLlm()
                .generateText("Tell me a joke about " + topic);
    }

    public Joke createJokeObjectAbout(String topic1, String topic2, String voice) {
        return ai
                .withLlm(LlmOptions.withDefaultLlm().withTemperature(.8))
                .createObject("""
                                Tell me a joke about %s and %s.
                                The voice of the joke should be %s.
                                The joke should have a leadup and a punchline.
                                """.formatted(topic1, topic2, voice),
                        Joke.class);
    }

}
```

### ğŸŒŸ **Beginner: Horoscope News Agent**

> **Available in:** Java & Kotlin | **Concept:** Basic Agent Workflow

A fun introduction to agent development that finds personalized news based on someone's star sign.

**What It Teaches:**

- ğŸ“‹ **Action-based workflows** with `@Action` annotations
- ğŸ” **Data extraction** from user input using LLMs
- ğŸŒ **Web tool integration** for finding news stories
- ğŸ“ **Content generation** with personality and context
- ğŸ¯ **Goal achievement** with `@AchievesGoal`

**How It Works:**

1. Extract person's name from user input
2. Get their star sign (via form if needed)
3. Retrieve daily horoscope
4. Search web for relevant news stories
5. Create amusing writeup combining horoscope + news

**Try It:**

Start the agent shell, then type:

```bash
x "Find horoscope news for Alice who is a Gemini"
```

`x` is short for `execute`, which triggers the agent to run its workflow.

**Code Comparison:**

- **Kotlin:** `examples-kotlin/src/main/kotlin/com/embabel/example/horoscope/StarNewsFinder.kt`
- **Java:** `examples-java/src/main/java/com/embabel/example/horoscope/StarNewsFinder.java`

**Key Patterns:**

```kotlin
@Agent(description = "Find news based on a person's star sign")
class StarNewsFinder {

    @Action
    fun extractPerson(userInput: UserInput): Person?

    @Action(toolGroups = [CoreToolGroups.WEB])
    fun findNewsStories(person: StarPerson, horoscope: Horoscope): RelevantNewsStories

    @AchievesGoal(description = "Create an amusing writeup")
    @Action
    fun starNewsWriteup(/* params */): Writeup
}
```

---

### ğŸ”¬ **Expert: Multi-LLM Research Agent**

> **Available in:** Java, Kotlin | **Concept:** Self-Improving AI Workflows

A sophisticated research agent using multiple AI models with self-critique capabilities.

**What It Teaches:**

- ğŸ§  **Multi-model consensus** (GPT-4 + Claude working together)
- ğŸ” **Self-improvement loops** with critique and retry
- âš™ï¸ **Configuration-driven behavior** with Spring Boot properties
- ğŸŒŠ **Parallel processing** of research tasks
- ğŸ“ **Quality control** through automated review

**Architecture:**

```kotlin
@ConfigurationProperties(prefix = "embabel.examples.researcher")
data class ResearcherProperties(
    val maxWordCount: Int = 300,
    val claudeModelName: String = AnthropicModels.CLAUDE_35_HAIKU,
    val openAiModelName: String = OpenAiModels.GPT_41_MINI
)
```

**Self-Improvement Pattern:**

```kotlin
@Action(outputBinding = "gpt4Report")
fun researchWithGpt4(/* params */): SingleLlmReport

@Action(outputBinding = "claudeReport")
fun researchWithClaude(/* params */): SingleLlmReport

@Action(outputBinding = "mergedReport")
fun mergeReports(gpt4: SingleLlmReport, claude: SingleLlmReport): ResearchReport

@Action
fun critiqueReport(report: ResearchReport): Critique

@AchievesGoal(description = "Completes research with quality assurance")
fun acceptReport(report: ResearchReport, critique: Critique): ResearchReport
```

**Try It:**

```bash
"Research the latest developments in renewable energy adoption"
```

**Location:** `examples-kotlin/src/main/kotlin/com/embabel/example/researcher/`

---

### âœ… **Expert: Fact-Checking Agent (DSL Style)**

> **Available in:** Kotlin | **Concept:** Functional Agent Construction

A fact-verification agent built using Embabel's functional DSL approach instead of annotations.

**What It Teaches:**

- ğŸ”§ **Functional DSL construction** for agents
- ğŸ” **Parallel fact verification** across multiple claims
- ğŸ“Š **Confidence scoring** and source trust evaluation
- ğŸŒ **Web research integration** for verification
- âš¡ **Functional programming patterns** in agent design

**DSL Construction:**

```kotlin
fun factCheckerAgent(llms: List<LlmOptions>, properties: FactCheckerProperties) =
    agent(name = "FactChecker", description = "Check content for factual accuracy") {

        flow {
            aggregate<UserInput, FactualAssertions, RationalizedFactualAssertions>(
                transforms = llms.map { llm ->
                    { context -> /* extract assertions with this LLM */ }
                },
                merge = { list, context -> /* rationalize overlapping claims */ }
            )
        }

        transformation<RationalizedFactualAssertions, FactCheck> {
            /* parallel fact-checking */
        }
    }
```

**Domain Model:**

```kotlin
data class FactualAssertion(
    val claim: String,
    val reasoning: String
)

data class AssertionCheck(
    val assertion: FactualAssertion,
    val isFactual: Boolean,
    val confidence: Double,
    val sources: List<String>
)
```

**Try It:**

```bash
"Check these facts: The Earth is flat. Paris is the capital of France."
```

**Location:** `examples-kotlin/src/main/kotlin/com/embabel/example/factchecker/`

---

## ğŸ› ï¸ Core Concepts You'll Learn

### **Spring Framework Integration**

- **Multiple Application Classes:** Dedicated starters for different modes
- **Maven Profiles:** `enable-shell`, `enable-shell-mcp-client`, `enable-agent-mcp-server`
- **Dependency Injection:** Constructor-based injection with agents as Spring beans
- **Configuration Properties:** Type-safe configuration with `@ConfigurationProperties`
- **Conditional Beans:** Environment-specific components with `@ConditionalOnBean`
- **Repository Pattern:** Spring Data integration for domain entities

### **Modern Spring Boot Patterns**

- **Multi-Annotation Architecture:** Combining multiple `@Enable*` annotations
- **Profile-Based Execution:** Maven profiles control which application class runs
- **Auto-Configuration Classes:** Understanding Spring Boot's auto-configuration
- **Conditional Configuration:** Mode-specific bean loading
- **Theme-Based Customization:** Dynamic behavior based on configuration

### **Modern Kotlin Features**

- **Data Classes:** Rich domain models with computed properties
- **Type Aliases:** Domain-specific types (`typealias OneThroughTen = Int`)
- **Extension Functions:** Enhanced functionality for existing types
- **Delegation:** Clean composition patterns
- **DSL Construction:** Functional agent building
- **Coroutines:** Parallel execution with structured concurrency

### **Agent Design Patterns**

- **Workflow Orchestration:** Multi-step processes with `@Action` chains
- **Blackboard Pattern:** Shared workspace for data between actions
- **Human-in-the-Loop:** User confirmations and form submissions
- **Self-Improvement:** Critique and retry loops for quality
- **Multi-Model Consensus:** Combining results from different LLMs
- **Condition-Based Flow:** Workflow control with `@Condition`
- **Progress Tracking:** Event publishing for monitoring

---

### Additional Examples

Some of our examples are projects in their own right, and are therefore
in separate repositories.

See:

- [Coding Agent](https://www.github.com/embabel/coding-agent): An open source coding agent
- [Flicker](https://www.github.com/embabel/flicker): A movie recommendation engine that takes into account the user's
  tastes and what's available to them in their country on the streaming services they subscribe to. Uses external APIs
  and PostgreSQL via JPA. Illustrates a complex workflow where recommendations are generated until enough available
  movies have been found.
- [Decker](https://www.github.com/embabel/decker): An agent to build presentations using Embabel
- [Tripper](https://www.github.com/embabel/tripper): Travel planning agent. Uses mapping APIs to find routes and places
  of interest, and generates a travel itinerary. Performs research on points of interest in parallel.

## ğŸ”§ Running Specific Examples

### **Interactive Shell Mode** (Default)

```bash
cd scripts/kotlin && ./shell.sh          # Basic features
cd scripts/kotlin && shell.cmd           # Basic features (Windows)
# or
cd scripts/java && ./shell.sh            # Basic features
cd scripts/java && shell.cmd             # Basic features (Windows)
```

Uses Maven profile: `enable-shell`

### **Shell with MCP Client Support**

```bash
cd scripts/kotlin && ./shell.sh --docker-tools     # Advanced Docker integration
cd scripts/kotlin && shell.cmd --docker-tools      # Advanced Docker integration (Windows)
# or
cd scripts/java && ./shell.sh --docker-tools       # Advanced Docker integration
cd scripts/java && shell.cmd --docker-tools        # Advanced Docker integration (Windows)
```

Uses Maven profile: `enable-shell-mcp-client`

### **With Observability (Zipkin Tracing)**

Enable distributed tracing with Zipkin by adding the `--observability` flag:

```bash
cd scripts/kotlin && ./shell.sh --observability    # Enable observability
cd scripts/kotlin && shell.cmd --observability     # Enable observability (Windows)
# or
cd scripts/java && ./shell.sh --observability      # Enable observability
cd scripts/java && shell.cmd --observability       # Enable observability (Windows)
```

Make sure to run `docker compose up` in the project root to start Zipkin trace collector:

```bash
docker compose up
```
You should be able to access Zipkin Console: http://127.0.0.1:9411/zipkin/

### **MCP Server Mode**

```bash
cd scripts/kotlin && ./mcp_server.sh
cd scripts/kotlin && mcp_server.cmd      # Windows
# or
cd scripts/java && ./mcp_server.sh
cd scripts/java && mcp_server.cmd        # Windows
```

Uses Maven profile: `enable-agent-mcp-server`

You can use the Embabel agent platform as an MCP server from a
UI like Claude Desktop. The Embabel MCP server is available over SSE.

Configure Claude Desktop as follows in your `claude_desktop_config.yml`:

```json
{
  "mcpServers": {
    "embabel-examples": {
      "command": "npx",
      "args": [
        "-y",
        "mcp-remote",
        "http://localhost:8080/sse"
      ]
    }
  }
}

```

See [MCP Quickstart for Claude Desktop Users](https://modelcontextprotocol.io/quickstart/user) for how to configure
Claude Desktop.

Create a project in Claude Desktop to work with Embabel examples. This will
enable you to add a custom system prompt.

The Embabel server will expose each goal as an MCP tool, enabling
Claude Desktop to invoke them like this:

<img src="images/Claude_Desktop_StarNews.jpg" alt="Claude Desktop invoking Embabel Star News Finder Agent" width="600"/>



The [MCP Inspector](https://github.com/modelcontextprotocol/inspector) is a helpful tool for interacting with your
Embabel
SSE server, manually invoking tools and checking the exposed prompts and resources.

Start the MCP Inspector with:

```bash
npx @modelcontextprotocol/inspector
```

### **Manual Execution**

```bash
# Kotlin shell mode
cd examples-kotlin
mvn -P enable-shell spring-boot:run

# Kotlin shell with MCP client
cd examples-kotlin
mvn -P enable-shell-mcp-client spring-boot:run

# Kotlin MCP server mode
cd examples-kotlin  
mvn -P enable-agent-mcp-server spring-boot:run

# Java equivalents use the same pattern
cd examples-java
mvn -P enable-shell spring-boot:run
```

### **Testing**

```bash
# Run all tests
./mvnw test             # Unix/Linux/macOS
mvnw.cmd test           # Windows

# Module-specific tests
cd examples-kotlin && ../mvnw test
cd examples-java && ../mvnw test
```

---

## ğŸŒ **MCP (Model Context Protocol) Support**

### **What is MCP?**

MCP (Model Context Protocol) is an open protocol that enables AI assistants and applications to securely connect to data
sources and tools. Embabel supports MCP in two ways:

1. **MCP Server Mode**: Your agents become tools that can be called by MCP clients
2. **MCP Client Support**: Your agents can call external MCP servers (like Docker Desktop)

### **MCP Server Mode**

Run your agents as an MCP server that exposes tools over Server-Sent Events (SSE):

```bash
# Start Kotlin agents as MCP server
cd scripts/kotlin && ./mcp_server.sh

# Start Java agents as MCP server  
cd scripts/java && ./mcp_server.sh
```

Your agents become available as tools:

- **StarNewsFinder** - `find_horoscope_news`
- **Researcher** - `research_topic`
- **FactChecker** - `check_facts`

### **MCP Client Support**

Enable your agents to use external MCP tools by using the `--docker-tools` parameter:

```bash
# Enable Docker Desktop MCP integration
cd scripts/kotlin && ./shell.sh --docker-tools
cd scripts/java && ./shell.sh --docker-tools
```

This allows your agents to:

- Execute commands in Docker containers
- Access containerized services
- Integrate with other MCP-compatible tools

### **Benefits of MCP**

- **ğŸ”„ Tool Interoperability** - Agents can use and be used as tools
- **ğŸ¯ Domain Expertise** - Specialized agents for specific tasks
- **ğŸ› ï¸ Tool Composition** - Combine multiple tools in workflows
- **ğŸ”’ Secure Access** - MCP handles authentication and sandboxing
- **ğŸ“ˆ Scalable Architecture** - Add new tools without changing code

---

## ğŸ¯ **Creating Your Own Agent Application**

### **Basic Shell Application**

```kotlin
@SpringBootApplication
@EnableAgentShell
@EnableAgents
class MyAgentApplication

fun main(args: Array<String>) {
    runApplication<MyAgentApplication>(*args)
}
```

### **Shell with Theme and MCP Client**

```kotlin
@SpringBootApplication
@EnableAgentShell
@EnableAgents(
    loggingTheme = LoggingThemes.STAR_WARS,
    mcpServers = [McpServers.DOCKER_DESKTOP]
)
class MyThemedAgentApplication

fun main(args: Array<String>) {
    runApplication<MyThemedAgentApplication>(*args)
}
```

### **MCP Server Application**

```kotlin
@SpringBootApplication
@EnableAgentMcpServer
@EnableAgents
class MyMcpServerApplication

fun main(args: Array<String>) {
    runApplication<MyMcpServerApplication>(*args)
}
```

---

## ğŸ¯ Getting Started Recommendations

### **New to Agents?**

1. Start with **Horoscope News Agent** (Java or Kotlin)
2. Compare the Java vs Kotlin implementations
3. Experiment with different prompts and see how the agent plans different workflows
4. Try different logging themes to make development more fun!

### **Spring Developer?**

1. Look at the configuration classes and repository integration
2. Study the domain model design and service composition
3. Explore the different application modes and Maven profiles
4. See how themes and MCP clients are configured

### **Kotlin Enthusiast?**

1. Progress to **Researcher** for multi-model patterns
2. Explore **Fact Checker** for functional DSL approaches

### **AI/ML Developer?**

1. Study prompt engineering techniques in any example
2. Examine the **Researcher** for multi-model consensus patterns
3. Look at **Fact Checker** for confidence scoring and source evaluation
4. Explore MCP integration for tool composition

---

## ğŸš¨ Common Issues & Solutions

| Problem                         | Solution                                                                                        |
|---------------------------------|-------------------------------------------------------------------------------------------------|
| **"No API keys found"**         | Set `OPENAI_API_KEY` or `ANTHROPIC_API_KEY`                                                     |
| **Wrong examples load**         | Use correct script: `kotlin/shell.sh` vs `java/shell.sh`                                        |
| **Build failures**              | Run `./mvnw clean install` (Unix/macOS) or `mvnw.cmd clean install` (Windows) from project root |
| **Application class not found** | Check Maven profile matches application class                                                   |
| **MCP client fails to connect** | Check port availability and Docker Desktop status. See instructions on pulling models above.    |

Look at the log output in the event of failure as it may contain hints as to the solution.

---

## ğŸ“ Project Structure

```
embabel-agent-examples/
â”œâ”€â”€ examples-kotlin/                 # ğŸ† Kotlin implementations
â”‚   â”œâ”€â”€ src/main/kotlin/com/embabel/example/
â”‚   â”‚   â”œâ”€â”€ AgentShellApplication.kt         # Basic shell mode
â”‚   â”‚   â”œâ”€â”€ AgentShellMcpClientApplication.kt # Shell + MCP client
â”‚   â”‚   â”œâ”€â”€ AgentMcpServerApplication.kt     # MCP server mode  
â”‚   â”‚   â”œâ”€â”€ horoscope/              # ğŸŒŸ Beginner: Star news agent
â”‚   â”œâ”€â”€ pom.xml                     # Maven profiles for each mode
â”‚   â””â”€â”€ README.md                   # ğŸ“– Kotlin-specific documentation
â”‚
â”œâ”€â”€ examples-java/                   # â˜• Java implementations  
â”‚   â”œâ”€â”€ src/main/java/com/embabel/example/
â”‚   â”‚   â”œâ”€â”€ AgentShellApplication.java  # Shell mode with themes
â”‚   â”‚   â”œâ”€â”€ AgentMcpApplication.java    # MCP server mode
â”‚   â”‚   â””â”€â”€ horoscope/              # ğŸŒŸ Beginner: Star news agent
â”‚   â””â”€â”€ README.md                   # ğŸ“– Java-specific documentation
â”‚
â”œâ”€â”€ examples-common/                 # ğŸ”§ Shared services & utilities
â”œâ”€â”€ scripts/                        # ğŸš€ Quick-start scripts
â”‚   â”œâ”€â”€ kotlin/
â”‚   â”‚   â”œâ”€â”€ shell.sh               # Launch shell (with --docker-tools option)
â”‚   â”‚   â””â”€â”€ mcp_server.sh          # Launch MCP server
â”‚   â”œâ”€â”€ java/
â”‚   â”‚   â”œâ”€â”€ shell.sh               # Launch shell (with --docker-tools option)
â”‚   â”‚   â””â”€â”€ mcp_server.sh          # Launch MCP server
â”‚   â”œâ”€â”€ support/                   # Shared script utilities
â”‚   â””â”€â”€ README.md                  # ğŸ“– Scripts documentation
â””â”€â”€ pom.xml                         # Parent Maven configuration
```

---

## ğŸ“„ License

Licensed under the Apache License 2.0. See [LICENSE](LICENSE) for details.

**ğŸ‰ Happy coding with Spring Framework and agentic AI!**

### ğŸŒŸ May the Force be with your agents! ğŸŒŸ

## Contributors

[![Embabel contributors](https://contrib.rocks/image?repo=embabel/embabel-agent-examples)](https://github.com/embabel/embabel-agent-examples/graphs/contributors)



================================================
FILE: README.zh-CN.md
================================================
# ğŸ¤– Embabel Agent ç¤ºä¾‹

<img align="left" src="https://github.com/embabel/embabel-agent/blob/main/embabel-agent-api/images/315px-Meister_der_Weltenchronik_001.jpg?raw=true" width="180">

![Build](https://github.com/embabel/embabel-agent-examples/actions/workflows/maven.yml/badge.svg)

[//]: # ([![Quality Gate Status]&#40;https://sonarcloud.io/api/project_badges/measure?project=embabel_embabel-agent&metric=alert_status&token=d275d89d09961c114b8317a4796f84faf509691c&#41;]&#40;https://sonarcloud.io/summary/new_code?id=embabel_embabel-agent&#41;)

[//]: # ([![Bugs]&#40;https://sonarcloud.io/api/project_badges/measure?project=embabel_embabel-agent&metric=bugs&#41;]&#40;https://sonarcloud.io/summary/new_code?id=embabel_embabel-agent&#41;)

![Kotlin](https://img.shields.io/badge/kotlin-%237F52FF.svg?style=for-the-badge&logo=kotlin&logoColor=white)
![Java](https://img.shields.io/badge/java-%23ED8B00.svg?style=for-the-badge&logo=openjdk&logoColor=white)
![Spring](https://img.shields.io/badge/spring-%236DB33F.svg?style=for-the-badge&logo=spring&logoColor=white)
![Apache Tomcat](https://img.shields.io/badge/apache%20tomcat-%23F8DC75.svg?style=for-the-badge&logo=apache-tomcat&logoColor=black)
![Apache Maven](https://img.shields.io/badge/Apache%20Maven-C71A36?style=for-the-badge&logo=Apache%20Maven&logoColor=white)
![ChatGPT](https://img.shields.io/badge/chatGPT-74aa9c?style=for-the-badge&logo=openai&logoColor=white)
![Jinja](https://img.shields.io/badge/jinja-white.svg?style=for-the-badge&logo=jinja&logoColor=black)
![JSON](https://img.shields.io/badge/JSON-000?logo=json&logoColor=fff)
![GitHub Actions](https://img.shields.io/badge/github%20actions-%232671E5.svg?style=for-the-badge&logo=githubactions&logoColor=white)
![SonarQube](https://img.shields.io/badge/SonarQube-black?style=for-the-badge&logo=sonarqube&logoColor=4E9BCD)
![Docker](https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white)
![IntelliJ IDEA](https://img.shields.io/badge/IntelliJIDEA-000000.svg?style=for-the-badge&logo=intellij-idea&logoColor=white)


&nbsp;&nbsp;&nbsp;&nbsp;

<br/>

[English](./README.md) Â· **ç®€ä½“ä¸­æ–‡**  

é€šè¿‡ **Spring Framework** å’Œ **Java** æˆ– **Kotlin** å­¦ä¹ æ™ºèƒ½ä½“ AI å¼€å‘ã€‚
è¿™äº›ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•æ„å»ºèƒ½å¤Ÿè§„åˆ’ã€æ‰§è¡Œå·¥ä½œæµã€ä½¿ç”¨å·¥å…·å¹¶ä¸äººç±»äº’åŠ¨çš„æ™ºèƒ½ä½“ã€‚

> æœ¬ä»“åº“ä½¿ç”¨æœ€æ–°çš„ Embabel å¿«ç…§æ¥å±•ç¤ºå½“å‰çš„æœ€ä½³å®è·µï¼Œ
> è€Œ [Java](https://github.com/embabel/java-agent-template) å’Œ 
> [Kotlin](https://github.com/embabel/kotlin-agent-template) æ¨¡æ¿ä»“åº“åˆ™ä½¿ç”¨æœ€æ–°çš„é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä»¥è·å¾—æ›´å¥½çš„ç¨³å®šæ€§ã€‚
> å¯èƒ½å­˜åœ¨ä¸€äº›è½»å¾®çš„ API ä¸å…¼å®¹æ€§ï¼Œæ‚¨åœ¨è¿™äº›æ¨¡æ¿ä¸­çœ‹åˆ°çš„å¹¶éæ‰€æœ‰å†…å®¹éƒ½èƒ½åœ¨æ‚¨è‡ªå·±çš„é¡¹ç›®ä¸­æ­£å¸¸å·¥ä½œï¼Œ
> é™¤éæ‚¨åœ¨ POM æ–‡ä»¶ä¸­å‡çº§ `embabel-agent.version` å±æ€§ï¼Œå¦‚æœ¬ä»“åº“æ‰€ç¤ºã€‚



## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶
- **Java 21+**
- **API å¯†é’¥**ï¼ˆä»»æ„ä¸€ä¸ªï¼‰ï¼š[OpenAI](https://platform.openai.com/api-keys) 
æˆ– [Anthropic](https://www.anthropic.com/api)
- **Maven 3.9+**ï¼ˆå¯é€‰ - é¡¹ç›®åŒ…å« Maven åŒ…è£…å™¨ï¼‰

### 1. å…‹éš†å¹¶æ„å»º
> è¯·ç¡®è®¤æ‚¨çš„ Maven é…ç½®å¯ä»¥è®¿é—® `repo.embabel.com` ä¸Šçš„ Maven ç§æœã€‚
```bash
git clone https://github.com/embabel/embabel-agent-examples.git
cd embabel-agent-examples
./mvnw clean install    # Unix/Linux/macOS 
mvnw.cmd clean install  # Windows
```

### 2. è®¾ç½® API å¯†é’¥
```bash
# å¿…éœ€ï¼ˆé€‰æ‹©ä¸€ä¸ªæˆ–ä¸¤ä¸ªï¼‰
export OPENAI_API_KEY="your_openai_key"
export ANTHROPIC_API_KEY="your_anthropic_key"
```

### 3. è¿è¡Œç¤ºä¾‹
#### **Kotlin ç¤ºä¾‹**
```bash
cd scripts/kotlin
./shell.sh                    # Unix/Linux/macOS - åŸºæœ¬åŠŸèƒ½
shell.cmd                     # Windows - åŸºæœ¬åŠŸèƒ½

./shell.sh --docker-tools     # Unix/Linux/macOS - å¯ç”¨ Docker é›†æˆ
shell.cmd --docker-tools      # Windows - å¯ç”¨ Docker é›†æˆ
```

#### **Java ç¤ºä¾‹**
```bash
cd scripts/java
./shell.sh                    # Unix/Linux/macOS - åŸºæœ¬åŠŸèƒ½
shell.cmd                     # Windows - åŸºæœ¬åŠŸèƒ½

./shell.sh --docker-tools     # Unix/Linux/macOS - å¯ç”¨ Docker é›†æˆ
shell.cmd --docker-tools      # Windows - å¯ç”¨ Docker é›†æˆ
```

### åˆ›å»ºæ‚¨è‡ªå·±çš„é¡¹ç›®

æ‚¨å¯ä»¥ä»æˆ‘ä»¬çš„ [Java](https://github.com/embabel/java-agent-template) æˆ– [Kotlin](https://github.com/embabel/kotlin-agent-template) GitHub æ¨¡æ¿åˆ›å»ºè‡ªå·±çš„ Agent ä»“åº“ï¼Œç‚¹å‡»"Use this template"æŒ‰é’®ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„å¿«é€Ÿå¯åŠ¨å·¥å…·åœ¨æœ¬åœ°åˆ›å»ºè‡ªå·±çš„ Embabel Agent é¡¹ç›®ï¼Œè¯¥å·¥å…·å…è®¸è‡ªå®šä¹‰ï¼š
```
uvx --from git+https://github.com/embabel/project-creator.git project-creator
```
é€‰æ‹© Java æˆ– Kotlinï¼ŒæŒ‡å®šæ‚¨çš„é¡¹ç›®åç§°å’ŒåŒ…åç§°ï¼Œå¦‚æœæ‚¨å·²ç»æ‹¥æœ‰ `OPENAI_API_KEY` ä¸”å®‰è£…äº† Mavenï¼Œæ‚¨å°†åœ¨ä¸€åˆ†é’Ÿå†…å¯åŠ¨ä¸€ä¸ªæ™ºèƒ½ä½“ã€‚

## ğŸ†• **Spring Boot é›†æˆæ¶æ„**

### **Embabel Agent Starter æŒ‡å—ï¼š**

#### **`embabel-agent-starter`**

- âœ… åº”ç”¨ç¨‹åºè‡ªå®šä¹‰å¯åŠ¨æ¨¡å¼ï¼ˆæ§åˆ¶å°ã€Webåº”ç”¨ç¨‹åºç­‰ï¼‰
- âœ… æ™ºèƒ½ä½“çš„å‘ç°ä¸æ³¨å†Œ
- âœ… åœ¨æ™ºèƒ½ä½“å¹³å°ä¸­Beanå¯é€šè¿‡ä¾èµ–æ³¨å…¥æœºåˆ¶ä¾›åº”ç”¨ç¨‹åºæŒ‰éœ€ä½¿ç”¨
- âœ… è¿›åº¦è·Ÿè¸ªå’Œæ—¥å¿—è®°å½•
- âœ… å¼€å‘è€…å‹å¥½çš„é”™è¯¯å¤„ç†

#### **`embabel-agent-starter-shell`**

- âœ… äº¤äº’å¼å‘½ä»¤è¡Œç•Œé¢
- âœ… æ™ºèƒ½ä½“çš„å‘ç°ä¸æ³¨å†Œ
- âœ… äººæœºäº¤äº’èƒ½åŠ›
- âœ… è¿›åº¦è·Ÿè¸ªå’Œæ—¥å¿—è®°å½•
- âœ… å¼€å‘è€…å‹å¥½çš„é”™è¯¯å¤„ç†

#### **`embabel-agent-starter-mcpserver`**

- âœ… MCPåè®®æœåŠ¡å™¨ç«¯å®ç°
- âœ… å·¥å…·çš„æ³¨å†Œä¸å‘ç°
- âœ… é€šè¿‡SSEåè®®ï¼ˆæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼‰è¿›è¡ŒJSON-RPCé€šä¿¡
- âœ… ä¸MCPå…¼å®¹çš„å®¢æˆ·ç«¯é›†æˆ
- âœ… å®‰å…¨æ€§ä¸æ²™ç®±åŒ–


### **ä¸‰ç§åº”ç”¨æ¨¡å¼**

Embabel Agentæ¡†æ¶æä¾›ä¸‰ç§ä¸åŒçš„åº”ç”¨æ¨¡å¼ï¼Œæ¯ç§æ¨¡å¼éƒ½é’ˆå¯¹ä¸åŒçš„ç”¨ä¾‹è¿›è¡Œäº†ä¼˜åŒ–ï¼š

1. äº¤äº’å¼Shellæ¨¡å¼ï¼ˆå¸¦æ˜Ÿçƒå¤§æˆ˜ä¸»é¢˜æ—¥å¿—ï¼‰
```xml
<dependency>
    <groupId>com.embabel.agent</groupId>
    <artifactId>embabel-agent-starter-shell</artifactId>
</dependency>
```

```kotlin
@SpringBootApplication
@EnableAgents(loggingTheme = LoggingThemes.STAR_WARS)
class AgentShellApplication
```

2. Shellæ¨¡å¼ï¼ˆæ”¯æŒMCPå®¢æˆ·ç«¯ï¼ŒDocker Desktopé›†æˆï¼‰

```xml
<dependency>
    <groupId>com.embabel.agent</groupId>
    <artifactId>embabel-agent-starter-shell</artifactId>
</dependency>
```

```kotlin
@SpringBootApplication
@EnableAgents(
   loggingTheme = LoggingThemes.SEVERANCE,
   mcpServers = [McpServers.DOCKER_DESKTOP]
)
class AgentShellMcpClientApplication
```

3. MCPæœåŠ¡å™¨æ¨¡å¼
```xml
<dependency>
    <groupId>com.embabel.agent</groupId>
    <artifactId>embabel-agent-starter-mcpserver</artifactId>
</dependency>
```

```kotlin
@SpringBootApplication
@EnableAgents(mcpServers = [McpServers.DOCKER_DESKTOP])
class AgentMcpServerApplication
```

```java
// Java ç‰ˆæœ¬
@SpringBootApplication
@EnableAgents(
    loggingTheme = LoggingThemes.STAR_WARS,
    mcpServers = {McpServers.DOCKER_DESKTOP}
)
public class AgentShellApplication;

@SpringBootApplication  
@EnableAgents(mcpServers = {McpServers.DOCKER_DESKTOP})
public class AgentMcpApplication;
```

### **æ³¨è§£æŒ‡å—ï¼š**

#### **`@EnableAgents`**
- ğŸ¨ **loggingTheme**ï¼šè‡ªå®šä¹‰æ™ºèƒ½ä½“çš„æ—¥å¿—ä¸ªæ€§
  - `"starwars"` - æ„¿åŸåŠ›ä¸ä½ çš„æ—¥å¿—åŒåœ¨ï¼
  - `"severance"` - æ¬¢è¿æ¥åˆ° Lumon Industriesï¼ˆé»˜è®¤ï¼‰
- ğŸ³ **mcpServers**ï¼šå¯ç”¨ MCP å®¢æˆ·ç«¯é›†æˆ
  - `"docker-desktop"` - Docker Desktop AI åŠŸèƒ½
  - å¯ä»¥æ·»åŠ è‡ªå®šä¹‰å®¢æˆ·ç«¯

## è®¾ç½® MCP å·¥å…·

ä¸€äº›ç¤ºä¾‹ä½¿ç”¨æ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼ˆMCPï¼‰æ¥è®¿é—®å·¥å…·å’ŒæœåŠ¡ã€‚

é»˜è®¤æºæ˜¯ä¸ Docker Desktop ä¸€èµ·å®‰è£…çš„ Docker Desktop MCP æœåŠ¡å™¨ã€‚

ä¸ºäº†ç¡®ä¿å·¥å…·å¯ç”¨ä¸”å¯åŠ¨ä¸ä¼šè¶…æ—¶ï¼Œè¯·é¦–å…ˆé€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–æ¨¡å‹ï¼š
```bash
docker login
docker mcp gateway run
```
å½“ç½‘å…³å¯åŠ¨åï¼Œæ‚¨å¯ä»¥ç»ˆæ­¢å…¶è¿è¡Œå¹¶å¯åŠ¨ Embabel æœåŠ¡å™¨ã€‚

## ğŸ“š æŒ‰å­¦ä¹ é˜¶æ®µåˆ†ç±»çš„ç¤ºä¾‹

### ğŸŒŸ **åˆå­¦è€…: æ˜Ÿåº§æ–°é—»æ™ºèƒ½ä½“**
> **å¯ç”¨è¯­è¨€:** Java å’Œ Kotlin | **æ¦‚å¿µ:** åŸºæœ¬æ™ºèƒ½ä½“å·¥ä½œæµ

ä¸€ä¸ªæœ‰è¶£çš„æ™ºèƒ½ä½“å¼€å‘å…¥é—¨ï¼Œèƒ½å¤Ÿæ ¹æ®æŸäººçš„æ˜Ÿåº§æ‰¾åˆ°ä¸ªæ€§åŒ–æ–°é—»ã€‚

**å­¦ä¹ å†…å®¹:**
- ğŸ“‹ **åŸºäºåŠ¨ä½œçš„å·¥ä½œæµ**ï¼Œä½¿ç”¨ `@Action` æ³¨è§£
- ğŸ” **ä»ç”¨æˆ·è¾“å…¥ä¸­æå–æ•°æ®**ï¼Œä½¿ç”¨ LLM
- ğŸŒ **ç½‘ç»œå·¥å…·é›†æˆ**ï¼Œå¯»æ‰¾æ–°é—»æ•…äº‹
- ğŸ“ **å¸¦æœ‰ä¸ªæ€§å’Œä¸Šä¸‹æ–‡çš„å†…å®¹ç”Ÿæˆ**
- ğŸ¯ **é€šè¿‡ `@AchievesGoal` è¾¾æˆç›®æ ‡**

**å·¥ä½œåŸç†:**
1. ä»ç”¨æˆ·è¾“å…¥ä¸­æå–å§“å
2. è·å–ä»–ä»¬çš„æ˜Ÿåº§ï¼ˆå¦‚æœ‰å¿…è¦é€šè¿‡è¡¨å•ï¼‰
3. æ£€ç´¢æ¯æ—¥æ˜Ÿåº§è¿åŠ¿
4. åœ¨ç½‘ä¸Šæœç´¢ç›¸å…³æ–°é—»æ•…äº‹
5. åˆ›å»ºç»“åˆæ˜Ÿåº§è¿åŠ¿å’Œæ–°é—»çš„æœ‰è¶£å†™ä½œ

**è¯•è¯•çœ‹:**

å¯åŠ¨æ™ºèƒ½ä½“ shellï¼Œç„¶åè¾“å…¥ï¼š
```bash
x "Find horoscope news for Alice who is a Gemini"
```
`x` æ˜¯ `execute` çš„ç¼©å†™ï¼Œè§¦å‘æ™ºèƒ½ä½“è¿è¡Œå…¶å·¥ä½œæµã€‚

**ä»£ç ä½ç½®:**
- **Kotlin:** `examples-kotlin/src/main/kotlin/com/embabel/example/horoscope/StarNewsFinder.kt`
- **Java:** `examples-java/src/main/java/com/embabel/example/horoscope/StarNewsFinder.java`

**æ ¸å¿ƒæ¨¡å¼:**
```kotlin
@Agent(description = "Find news based on a person's star sign")
class StarNewsFinder {
    
    @Action
    fun extractPerson(userInput: UserInput): Person?
    
    @Action(toolGroups = [CoreToolGroups.WEB])
    fun findNewsStories(person: StarPerson, horoscope: Horoscope): RelevantNewsStories
    
    @AchievesGoal(description = "Create an amusing writeup")
    @Action
    fun starNewsWriteup(/* params */): Writeup
}
```

### ğŸ”¬ **ä¸“å®¶: å¤šLLMç ”ç©¶æ™ºèƒ½ä½“**
> **å¯ç”¨è¯­è¨€:** Kotlin | **æ¦‚å¿µ:** è‡ªæˆ‘æ”¹è¿›çš„ AI å·¥ä½œæµ

ä¸€ä¸ªå…ˆè¿›çš„ç ”ç©¶æ™ºèƒ½ä½“ï¼Œä½¿ç”¨å¤šä¸ª AI æ¨¡å‹å¹¶å…·æœ‰è‡ªæˆ‘æ‰¹è¯„èƒ½åŠ›ã€‚

**å­¦ä¹ å†…å®¹:**
- ğŸ§  **å¤šæ¨¡å‹å…±è¯†**ï¼ˆGPT-4 + Claude ååŒå·¥ä½œï¼‰
- ğŸ” **è‡ªæˆ‘æ”¹è¿›å¾ªç¯**ï¼Œå¸¦æœ‰æ‰¹è¯„å’Œé‡è¯•
- âš™ï¸ **åŸºäºé…ç½®çš„è¡Œä¸º**ï¼Œä½¿ç”¨ Spring Boot å±æ€§
- ğŸŒŠ **å¹¶è¡Œå¤„ç†**ç ”ç©¶ä»»åŠ¡
- ğŸ“ **è´¨é‡æ§åˆ¶**é€šè¿‡è‡ªåŠ¨å®¡æ ¸

**æ¶æ„:**
```kotlin
@ConfigurationProperties(prefix = "embabel.examples.researcher")
data class ResearcherProperties(
    val maxWordCount: Int = 300,
    val claudeModelName: String = AnthropicModels.CLAUDE_35_HAIKU,
    val openAiModelName: String = OpenAiModels.GPT_41_MINI
)
```

**è‡ªæˆ‘æ”¹è¿›æ¨¡å¼:**
```kotlin
@Action(outputBinding = "gpt4Report")
fun researchWithGpt4(/* params */): SingleLlmReport

@Action(outputBinding = "claudeReport") 
fun researchWithClaude(/* params */): SingleLlmReport

@Action(outputBinding = "mergedReport")
fun mergeReports(gpt4: SingleLlmReport, claude: SingleLlmReport): ResearchReport

@Action
fun critiqueReport(report: ResearchReport): Critique

@AchievesGoal(description = "Completes research with quality assurance")
fun acceptReport(report: ResearchReport, critique: Critique): ResearchReport
```

**è¯•è¯•çœ‹:**
```bash
"Research the latest developments in renewable energy adoption"
```
**ä»£ç ä½ç½®:** `examples-kotlin/src/main/kotlin/com/embabel/example/researcher/`

### âœ… **ä¸“å®¶: äº‹å®æ ¸æŸ¥æ™ºèƒ½ä½“ï¼ˆDSL é£æ ¼ï¼‰**
> **å¯ç”¨è¯­è¨€:** Kotlin | **æ¦‚å¿µ:** å‡½æ•°å¼æ™ºèƒ½ä½“æ„å»º

ä¸€ä¸ªåŸºäº Embabel çš„å‡½æ•°å¼ DSL æ–¹æ³•æ„å»ºçš„äº‹å®éªŒè¯æ™ºèƒ½ä½“ã€‚

**å­¦ä¹ å†…å®¹:**
- ğŸ”§ **åŸºäºå‡½æ•°çš„ DSL æ„å»º** æ™ºèƒ½ä½“
- ğŸ” **å¤šä¸ªå£°æ˜çš„å¹¶è¡Œäº‹å®éªŒè¯**
- ğŸ“Š **ç½®ä¿¡åº¦è¯„åˆ†** å’Œæ¥æºä¿¡ä»»è¯„ä¼°
- ğŸŒ **ç½‘ç»œç ”ç©¶é›†æˆ**ä»¥è¿›è¡ŒéªŒè¯
- âš¡ **æ™ºèƒ½ä½“è®¾è®¡ä¸­çš„å‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼**

**DSL æ„å»º:**
```kotlin
fun factCheckerAgent(llms: List<LlmOptions>, properties: FactCheckerProperties) = 
agent(name = "FactChecker", description = "Check content for factual accuracy") {
    
    flow {
        aggregate<UserInput, FactualAssertions, RationalizedFactualAssertions>(
            transforms = llms.map { llm ->
                { context -> /* extract assertions with this LLM */ }
            },
            merge = { list, context -> /* rationalize overlapping claims */ }
        )
    }
    
    transformation<RationalizedFactualAssertions, FactCheck> { 
        /* parallel fact-checking */
    }
}
```

**æ•°æ®æ¨¡å‹:**
```kotlin
data class FactualAssertion(
    val claim: String,
    val reasoning: String
)

data class AssertionCheck(
    val assertion: FactualAssertion,
    val isFactual: Boolean,
    val confidence: Double,
    val sources: List<String>
)
```

**è¯•è¯•çœ‹:**
```bash
"Check these facts: The Earth is flat. Paris is the capital of France."
```
**ä»£ç ä½ç½®:** `examples-kotlin/src/main/kotlin/com/embabel/example/factchecker/`

## ğŸ› ï¸ æ‚¨å°†å­¦ä¹ çš„æ ¸å¿ƒæ¦‚å¿µ
### **Spring æ¡†æ¶é›†æˆ**
- **å¤šä¸ªåº”ç”¨ç¨‹åºç±»:** é’ˆå¯¹ä¸åŒæ¨¡å¼çš„ä¸“ç”¨å¯åŠ¨å™¨
- **Maven é…ç½®:** `enable-shell`ã€`enable-shell-mcp-client`ã€`enable-agent-mcp-server`
- **ä¾èµ–æ³¨å…¥:** é‡‡ç”¨æ„é€ å‡½æ•°æ³¨å…¥ï¼Œæ™ºèƒ½ä½“ä½œä¸º Spring beans
- **é…ç½®å±æ€§:** ä½¿ç”¨ `@ConfigurationProperties` è¿›è¡Œç±»å‹å®‰å…¨é…ç½®
- **æ¡ä»¶ Bean:** å…·æœ‰ `@ConditionalOnBean` çš„ç¯å¢ƒç‰¹å®šç»„ä»¶
- **ä»“å‚¨æ¨¡å¼:** Spring Data é›†æˆç”¨äºé¢†åŸŸå®ä½“

### **ç°ä»£ Spring Boot æ¨¡å¼**
- **å¤šæ³¨è§£æ¶æ„:** ç»“åˆå¤šä¸ª `@Enable*` æ³¨è§£
- **åŸºäºé…ç½®æ–‡ä»¶çš„æ‰§è¡Œ:** Maven é…ç½®æ§åˆ¶å“ªä¸ªåº”ç”¨ç¨‹åºç±»è¿è¡Œ
- **è‡ªåŠ¨é…ç½®ç±»:** ç†è§£ Spring Boot çš„è‡ªåŠ¨é…ç½®
- **æ¡ä»¶é…ç½®:** ç‰¹å®šæ¨¡å¼çš„ Bean åŠ è½½
- **åŸºäºä¸»é¢˜çš„è‡ªå®šä¹‰:** åŸºäºé…ç½®çš„åŠ¨æ€è¡Œä¸º

### **ç°ä»£ Kotlin ç‰¹æ€§**
- **æ•°æ®ç±»:** å¸¦è®¡ç®—å±æ€§çš„ä¸°å¯Œé¢†åŸŸæ¨¡å‹
- **ç±»å‹åˆ«å:** ç‰¹å®šé¢†åŸŸçš„ç±»å‹ï¼ˆ`typealias OneThroughTen = Int`ï¼‰
- **æ‰©å±•å‡½æ•°:** å¢å¼ºç°æœ‰ç±»å‹çš„åŠŸèƒ½
- **å§”æ‰˜:** æ¸…æ™°çš„ç»„åˆæ¨¡å¼
- **DSL æ„å»º:** åŠŸèƒ½æ€§æ™ºèƒ½ä½“æ„å»º
- **åç¨‹:** é‡‡ç”¨ç»“æ„åŒ–å¹¶å‘çš„å¹¶è¡Œæ‰§è¡Œ

### **æ™ºèƒ½ä½“è®¾è®¡æ¨¡å¼**
- **å·¥ä½œæµç¼–æ’:** ä½¿ç”¨ `@Action` é“¾çš„å¤šæ­¥éª¤è¿‡ç¨‹
- **é»‘æ¿æ¨¡å¼:** åŠ¨ä½œä¹‹é—´å…±äº«æ•°æ®çš„å·¥ä½œç©ºé—´
- **äººæœºåä½œ:** ç”¨æˆ·ç¡®è®¤å’Œè¡¨å•æäº¤
- **è‡ªæˆ‘æ”¹è¿›:** è´¨é‡çš„æ‰¹è¯„å’Œé‡è¯•å¾ªç¯
- **å¤šæ¨¡å‹å…±è¯†:** æ•´åˆä¸åŒ LLM çš„ç»“æœ
- **æ¡ä»¶æµç¨‹:** ä½¿ç”¨ `@Condition` æ§åˆ¶å·¥ä½œæµ
- **è¿›åº¦ç›‘æ§:** äº‹ä»¶å‘å¸ƒç”¨äºç›‘æ§

### å…¶ä»–ç¤ºä¾‹

æˆ‘ä»¬çš„ä¸€äº›ç¤ºä¾‹æ˜¯ç‹¬ç«‹çš„é¡¹ç›®ï¼Œå› æ­¤ä½äºå•ç‹¬çš„ä»“åº“ä¸­ã€‚

å‚è€ƒé¡¹ç›®:

- [Coding Agent](https://www.github.com/embabel/coding-agent): ä¸€æ¬¾å¼€æºçš„ç¼–ç¨‹æ™ºèƒ½ä½“ã€‚
- [Flicker](https://www.github.com/embabel/flicker): ä¸€æ¬¾ç”µå½±æ¨èå¼•æ“ï¼Œæ ¹æ®ç”¨æˆ·çš„å–œå¥½å’Œå…¶åœ¨æµåª’ä½“æœåŠ¡ä¸Šå¯ç”¨çš„å†…å®¹è¿›è¡Œæ¨èã€‚ä½¿ç”¨å¤–éƒ¨ API åŠé€šè¿‡ JPA çš„ PostgreSQLã€‚å±•ç¤ºäº†ä¸€ä¸ªå¤æ‚çš„å·¥ä½œæµï¼Œåœ¨è¯¥å·¥ä½œæµä¸­ï¼Œæ¨èä¼šä¸æ–­ç”Ÿæˆï¼Œç›´åˆ°æ‰¾åˆ°è¶³å¤Ÿå¯ç”¨çš„ç”µå½±ã€‚
- [Decker](https://www.github.com/embabel/decker): ä¸€ä¸ªä½¿ç”¨ Embabel æ„å»ºæ¼”ç¤ºæ–‡ç¨¿çš„æ™ºèƒ½ä½“
- [Tripper](https://www.github.com/embabel/tripper): æ—…è¡Œè§„åˆ’æ™ºèƒ½ä½“ã€‚ä½¿ç”¨åœ°å›¾ API æŸ¥æ‰¾è·¯çº¿å’Œæ„Ÿå…´è¶£çš„åœ°ç‚¹ï¼Œå¹¶ç”Ÿæˆæ—…è¡Œè¡Œç¨‹ã€‚åŒæ—¶æ‰§è¡Œå¯¹æ„Ÿå…´è¶£çš„åœ°ç‚¹ç ”ç©¶ã€‚

## ğŸ”§ è¿è¡Œç‰¹å®šç¤ºä¾‹
### **äº¤äº’å¼ Shell æ¨¡å¼**ï¼ˆé»˜è®¤)
```bash
cd scripts/kotlin && ./shell.sh          # åŸºæœ¬åŠŸèƒ½
cd scripts/kotlin && shell.cmd           # åŸºæœ¬åŠŸèƒ½ï¼ˆWindowsï¼‰
# æˆ–
cd scripts/java && ./shell.sh            # åŸºæœ¬åŠŸèƒ½
cd scripts/java && shell.cmd             # åŸºæœ¬åŠŸèƒ½ï¼ˆWindowsï¼‰
```
ä½¿ç”¨ Maven é…ç½®æ–‡ä»¶ï¼š`enable-shell`

### **å¸¦æœ‰ MCP å®¢æˆ·ç«¯æ”¯æŒçš„ Shell**
```bash
cd scripts/kotlin && ./shell.sh --docker-tools     # é«˜çº§ Docker é›†æˆ
cd scripts/kotlin && shell.cmd --docker-tools      # é«˜çº§ Docker é›†æˆ
# æˆ–
cd scripts/java && ./shell.sh --docker-tools       # é«˜çº§ Docker é›†æˆ
cd scripts/java && shell.cmd --docker-tools        # é«˜çº§ Docker é›†æˆ
```
ä½¿ç”¨ Maven é…ç½®æ–‡ä»¶ï¼š`enable-shell-mcp-client`

### **MCP æœåŠ¡å™¨æ¨¡å¼**
```bash
cd scripts/kotlin && ./mcp_server.sh
cd scripts/kotlin && mcp_server.cmd      # Windows
# æˆ–
cd scripts/java && ./mcp_server.sh
cd scripts/java && mcp_server.cmd        # Windows
```
ä½¿ç”¨ Maven é…ç½®æ–‡ä»¶ï¼š`enable-agent-mcp-server`

æ‚¨å¯ä»¥å°† Embabel æ™ºèƒ½ä½“å¹³å°ä½œä¸º MCP æœåŠ¡å™¨ä» UIï¼ˆå¦‚ Claude Desktopï¼‰ä½¿ç”¨ã€‚Embabel MCP æœåŠ¡å™¨é€šè¿‡ SSE æä¾›ã€‚

åœ¨ `claude_desktop_config.yml` ä¸­å°† Claude Desktop é…ç½®å¦‚ä¸‹ï¼š
```json
{
  "mcpServers": {
    "embabel-examples": {
      "command": "npx",
      "args": [
        "-y",
        "mcp-remote",
        "http://localhost:8080/sse"
      ]
    }
  }
}
```
è¯·å‚è€ƒ [Claude Desktop ç”¨æˆ·çš„ MCP å¿«é€Ÿå…¥é—¨](https://modelcontextprotocol.io/quickstart/user) äº†è§£å¦‚ä½•é…ç½® Claude Desktopã€‚

åœ¨ Claude Desktop ä¸­åˆ›å»ºä¸€ä¸ªé¡¹ç›®ä»¥ä½¿ç”¨ Embabel ç¤ºä¾‹ã€‚è¿™æ ·æ‚¨å°±å¯ä»¥æ·»åŠ è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºã€‚

Embabel æœåŠ¡å™¨å°†æ¯ä¸ªç›®æ ‡æš´éœ²ä¸ºä¸€ä¸ª MCP å·¥å…·ï¼Œä½¿ Claude Desktop èƒ½å¤Ÿåƒè¿™æ ·è°ƒç”¨å®ƒä»¬ï¼š

<img src="images/Claude_Desktop_StarNews.jpg" alt="Claude Desktop è°ƒç”¨ Embabel æ˜Ÿåº§æ–°é—»å‘ç°æ™ºèƒ½ä½“" width="600"/>

[MCP Inspector](https://github.com/modelcontextprotocol/inspector) æ˜¯ä¸€ä¸ªæœ‰åŠ©äºä¸æ‚¨çš„ Embabel SSE æœåŠ¡å™¨äº¤äº’çš„å·¥å…·ï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒç”¨å·¥å…·å¹¶æ£€æŸ¥æš´éœ²çš„æç¤ºå’Œèµ„æºã€‚

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ MCP Inspectorï¼š
```bash
npx @modelcontextprotocol/inspector
```

### **æ‰‹åŠ¨æ‰§è¡Œ**
```bash
# Kotlin shell æ¨¡å¼
cd examples-kotlin
mvn -P enable-shell spring-boot:run

# Kotlin å¸¦æœ‰ MCP å®¢æˆ·ç«¯
cd examples-kotlin
mvn -P enable-shell-mcp-client spring-boot:run

# Kotlin MCP æœåŠ¡å™¨æ¨¡å¼
cd examples-kotlin  
mvn -P enable-agent-mcp-server spring-boot:run

# Java çš„å¯¹åº”å‘½ä»¤ä½¿ç”¨ç›¸åŒæ¨¡å¼
cd examples-java
mvn -P enable-shell spring-boot:run
```

### **æµ‹è¯•**
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./mvnw test             # Unix/Linux/macOS
mvnw.cmd test           # Windows

# æ¨¡å—ç‰¹å®šæµ‹è¯•
cd examples-kotlin && ../mvnw test
cd examples-java && ../mvnw test
```

## ğŸŒ **MCPï¼ˆæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼‰æ”¯æŒ**
### **ä»€ä¹ˆæ˜¯ MCP?**
MCPï¼ˆæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾åè®®ï¼Œä½¿ AI åŠ©æ‰‹å’Œåº”ç”¨ç¨‹åºèƒ½å¤Ÿå®‰å…¨åœ°è¿æ¥åˆ°æ•°æ®æºå’Œå·¥å…·ã€‚Embabel é€šè¿‡ä¸¤ç§æ–¹å¼æ”¯æŒ MCPï¼š

1. **MCP æœåŠ¡å™¨æ¨¡å¼**: æ‚¨çš„æ™ºèƒ½ä½“æˆä¸º MCP å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨çš„å·¥å…·
2. **MCP å®¢æˆ·ç«¯æ”¯æŒ**: æ‚¨çš„æ™ºèƒ½ä½“å¯ä»¥è°ƒç”¨å¤–éƒ¨ MCP æœåŠ¡å™¨ï¼ˆå¦‚ Docker Desktopï¼‰

### **MCP æœåŠ¡å™¨æ¨¡å¼**

ä»¥ MCP æœåŠ¡å™¨èº«ä»½è¿è¡Œæ‚¨çš„æ™ºèƒ½ä½“ï¼Œé€šè¿‡æœåŠ¡å™¨æ¨é€äº‹ä»¶ (SSE) æš´éœ²å·¥å…·ï¼š
```bash
# å¯åŠ¨ Kotlin æ™ºèƒ½ä½“ä½œä¸º MCP æœåŠ¡å™¨
cd scripts/kotlin && ./mcp_server.sh

# å¯åŠ¨ Java æ™ºèƒ½ä½“ä½œä¸º MCP æœåŠ¡å™¨  
cd scripts/java && ./mcp_server.sh
```

æ‚¨çš„æ™ºèƒ½ä½“å°†ä½œä¸ºå·¥å…·å¯ç”¨ï¼š
- **æ˜Ÿåº§æ–°é—»å‘ç°** - `find_horoscope_news`
- **ç ”ç©¶è€…** - `research_topic`
- **äº‹å®æ ¸æŸ¥è€…** - `check_facts`

### **MCP å®¢æˆ·ç«¯æ”¯æŒ**

é€šè¿‡ä½¿ç”¨ `--docker-tools` å‚æ•°å¯ç”¨æ‚¨çš„æ™ºèƒ½ä½“ä½¿ç”¨å¤–éƒ¨ MCP å·¥å…·ï¼š
```bash
# å¯ç”¨ Docker Desktop MCP é›†æˆ
cd scripts/kotlin && ./shell.sh --docker-tools
cd scripts/java && ./shell.sh --docker-tools
```

è¿™ä½¿å¾—æ‚¨çš„æ™ºèƒ½ä½“èƒ½å¤Ÿï¼š
- åœ¨ Docker å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤
- è®¿é—®å®¹å™¨åŒ–æœåŠ¡
- ä¸å…¶ä»–å…¼å®¹ MCP çš„å·¥å…·é›†æˆ

### **MCP çš„ä¼˜ç‚¹**
- **ğŸ”„ å·¥å…·äº’æ“ä½œæ€§** - æ™ºèƒ½ä½“å¯ä»¥ç”¨ä½œå·¥å…·å¹¶è¢«ç”¨ä½œå·¥å…·
- **ğŸ¯ é¢†åŸŸä¸“ä¸šçŸ¥è¯†** - é€‚ç”¨äºç‰¹å®šä»»åŠ¡çš„ä¸“ä¸šæ™ºèƒ½ä½“
- **ğŸ› ï¸ å·¥å…·ç»„åˆ** - åœ¨å·¥ä½œæµä¸­åˆå¹¶å¤šä¸ªå·¥å…·
- **ğŸ”’ å®‰å…¨è®¿é—®** - MCP å¤„ç†èº«ä»½éªŒè¯å’Œæ²™ç®±
- **ğŸ“ˆ å¯æ‰©å±•æ¶æ„** - æ·»åŠ æ–°å·¥å…·è€Œæ— éœ€æ›´æ”¹ä»£ç 

## ğŸ¯ **åˆ›å»ºæ‚¨è‡ªå·±çš„æ™ºèƒ½ä½“åº”ç”¨ç¨‹åº**
### **åŸºæœ¬ Shell åº”ç”¨ç¨‹åº**
```kotlin
@SpringBootApplication
@EnableAgentShell
@EnableAgents
class MyAgentApplication

fun main(args: Array<String>) {
    runApplication<MyAgentApplication>(*args)
}
```
### **å¸¦ä¸»é¢˜å’Œ MCP å®¢æˆ·ç«¯çš„ Shell**
```kotlin
@SpringBootApplication
@EnableAgentShell
@EnableAgents(
    loggingTheme = LoggingThemes.STAR_WARS,
    mcpServers = [McpServers.DOCKER_DESKTOP]
)
class MyThemedAgentApplication

fun main(args: Array<String>) {
    runApplication<MyThemedAgentApplication>(*args)
}
```

### **MCP æœåŠ¡å™¨åº”ç”¨ç¨‹åº**
```kotlin
@SpringBootApplication
@EnableAgentMcpServer
@EnableAgents
class MyMcpServerApplication

fun main(args: Array<String>) {
    runApplication<MyMcpServerApplication>(*args)
}
```

## ğŸ¯ å…¥é—¨å»ºè®®
### **å¯¹æ™ºèƒ½ä½“ä¸ç†Ÿæ‚‰?**
1. ä» **æ˜Ÿåº§æ–°é—»æ™ºèƒ½ä½“**ï¼ˆJava æˆ– Kotlinï¼‰å¼€å§‹
2. æ¯”è¾ƒ Java å’Œ Kotlin å®ç°
3. å°è¯•ä¸åŒçš„æç¤ºï¼Œè§‚å¯Ÿæ™ºèƒ½ä½“è§„åˆ’ä¸åŒçš„å·¥ä½œæµ
4. å°è¯•ä¸åŒçš„æ—¥å¿—ä¸»é¢˜ï¼Œè®©å¼€å‘æ›´åŠ æœ‰è¶£ï¼

### **Spring å¼€å‘è€…?**
1. æŸ¥çœ‹é…ç½®ç±»å’Œä»“å‚¨é›†æˆ
2. ç ”ç©¶æ•°æ®æ¨¡å‹è®¾è®¡å’ŒæœåŠ¡æ¶æ„
3. æ¢ç´¢ä¸åŒçš„åº”ç”¨æ¨¡å¼å’Œ Maven é…ç½®æ–‡ä»¶
4. äº†è§£å¦‚ä½•é…ç½®ä¸»é¢˜å’Œ MCP å®¢æˆ·ç«¯

### **Kotlin çˆ±å¥½è€…?**
1. è¿›é˜¶åˆ° **ç ”ç©¶è€…**ï¼Œäº†è§£å¤šæ¨¡å‹æ¨¡å¼
2. æ¢ç´¢ **äº‹å®æ ¸æŸ¥è€…** çš„å‡½æ•°å¼ DSL æ–¹æ³•

### **AI/ML å¼€å‘è€…?**
1. å­¦ä¹ ä»»ä½•ç¤ºä¾‹ä¸­çš„æç¤ºå·¥ç¨‹æŠ€æœ¯
2. æŸ¥çœ‹ **ç ”ç©¶è€…** ä»¥å­¦ä¹ å¤šæ¨¡å‹å…±è¯†æ¨¡å¼
3. æŸ¥çœ‹ **äº‹å®æ ¸æŸ¥è€…** ä»¥å­¦ä¹ ç½®ä¿¡è¯„åˆ†å’Œæ¥æºè¯„ä¼°
4. æ¢ç´¢ MCP é›†æˆä»¥å®ç°å·¥å…·ç»„åˆ

## ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

| é—®é¢˜                          | è§£å†³æ–¹æ³•                                                                                 |
|-------------------------------|------------------------------------------------------------------------------------------|
| **"æœªæ‰¾åˆ° API å¯†é’¥"**       | é…ç½® `OPENAI_API_KEY` æˆ– `ANTHROPIC_API_KEY`                                            |
| **é”™è¯¯ç¤ºä¾‹åŠ è½½**             | ä½¿ç”¨æ­£ç¡®çš„è„šæœ¬: `kotlin/shell.sh` ä¸ `java/shell.sh`                                   |
| **æ„å»ºå¤±è´¥**                 | ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ `./mvnw clean install`ï¼ˆUnix/macOSï¼‰æˆ– `mvnw.cmd clean install`ï¼ˆWindowsï¼‰ |
| **æœªæ‰¾åˆ°åº”ç”¨ç¨‹åºç±»**         | æ£€æŸ¥ Maven é…ç½®æ–‡ä»¶ä¸åº”ç”¨ç¨‹åºç±»æ˜¯å¦åŒ¹é…                                               |
| **MCP å®¢æˆ·ç«¯æ— æ³•è¿æ¥**       | æ£€æŸ¥ç«¯å£å¯ç”¨æ€§å’Œ Docker Desktop çŠ¶æ€ã€‚è·å–æ¨¡å‹çš„è¯´æ˜è¯·å‚è€ƒå‰é¢çš„é…ç½®æŒ‡å—ã€‚        |

åœ¨å‡ºç°é—®é¢˜æ—¶æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼Œå…¶ä¸­å¯èƒ½åŒ…å«è§£å†³é—®é¢˜çš„æç¤ºã€‚

## ğŸ“ é¡¹ç›®ç»“æ„
```
embabel-agent-examples/
â”œâ”€â”€ examples-kotlin/                 # ğŸ† Kotlin å®ç°
â”‚   â”œâ”€â”€ src/main/kotlin/com/embabel/example/
â”‚   â”‚   â”œâ”€â”€ AgentShellApplication.kt         # åŸºæœ¬ shell æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ AgentShellMcpClientApplication.kt # Shell + MCP å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ AgentMcpServerApplication.kt     # MCP æœåŠ¡å™¨æ¨¡å¼  
â”‚   â”‚   â”œâ”€â”€ horoscope/              # ğŸŒŸ åˆå­¦è€…: æ˜Ÿåº§æ–°é—»æ™ºèƒ½ä½“
â”‚   â”œâ”€â”€ pom.xml                     # æ¯ä¸ªæ¨¡å¼çš„ Maven é…ç½®
â”‚   â””â”€â”€ README.md                   # ğŸ“– é’ˆå¯¹ Kotlin çš„å…·ä½“æ–‡æ¡£
â”‚
â”œâ”€â”€ examples-java/                   # â˜• Java å®ç°  
â”‚   â”œâ”€â”€ src/main/java/com/embabel/example/
â”‚   â”‚   â”œâ”€â”€ AgentShellApplication.java  # Shell æ¨¡å¼ï¼Œå¸¦ä¸»é¢˜
â”‚   â”‚   â”œâ”€â”€ AgentMcpApplication.java    # MCP æœåŠ¡å™¨æ¨¡å¼
â”‚   â”‚   â””â”€â”€ horoscope/              # ğŸŒŸ åˆå­¦è€…: æ˜Ÿåº§æ–°é—»æ™ºèƒ½ä½“
â”‚   â””â”€â”€ README.md                   # ğŸ“– é’ˆå¯¹ Java çš„å…·ä½“æ–‡æ¡£
â”‚
â”œâ”€â”€ examples-common/                 # ğŸ”§ å…±äº«æœåŠ¡å’Œå·¥å…·
â”œâ”€â”€ scripts/                        # ğŸš€ å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ kotlin/
â”‚   â”‚   â”œâ”€â”€ shell.sh               # å¯åŠ¨ shellï¼ˆå¸¦æœ‰ --docker-tools é€‰é¡¹ï¼‰
â”‚   â”‚   â””â”€â”€ mcp_server.sh          # å¯åŠ¨ MCP æœåŠ¡å™¨
â”‚   â”œâ”€â”€ java/
â”‚   â”‚   â”œâ”€â”€ shell.sh               # å¯åŠ¨ shellï¼ˆå¸¦æœ‰ --docker-tools é€‰é¡¹ï¼‰
â”‚   â”‚   â””â”€â”€ mcp_server.sh          # å¯åŠ¨ MCP æœåŠ¡å™¨
â”‚   â”œâ”€â”€ support/                   # å…±äº«è„šæœ¬å·¥å…·
â”‚   â””â”€â”€ README.md                  # ğŸ“– è„šæœ¬æ–‡æ¡£
â””â”€â”€ pom.xml                         # çˆ¶çº§ Maven é…ç½®
```

## ğŸ“„ å¼€æºåè®®

åŸºäº Apache è®¸å¯è¯ 2.0 æˆæƒã€‚è¯¦æƒ…è¯·å‚è€ƒ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

**ğŸ‰ ä½¿ç”¨ Spring æ¡†æ¶å’Œ Agentic AI äº«å—ç¼–ç çš„ä¹è¶£ï¼**

### ğŸŒŸ æ„¿åŸåŠ›ä¸ä½ çš„æ™ºèƒ½ä½“åŒåœ¨ï¼ğŸŒŸ

## è´¡çŒ®è€…

[![Embabel è´¡çŒ®è€…](https://contrib.rocks/image?repo=embabel/embabel-agent-examples)](https://github.com/embabel/embabel-agent-examples/graphs/contributors)



================================================
FILE: docker-compose.yml
================================================
services:
  zipkin:
    image: 'openzipkin/zipkin:latest'
    ports:
      - "9411:9411"


================================================
FILE: LICENSE
================================================
                                 Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      "License" shall mean the terms and conditions for use, reproduction,
      and distribution as defined by Sections 1 through 9 of this document.

      "Licensor" shall mean the copyright owner or entity authorized by
      the copyright owner that is granting the License.

      "Legal Entity" shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under common
      control with that entity. For the purposes of this definition,
      "control" means (i) the power, direct or indirect, to cause the
      direction or management of such entity, whether by contract or
      otherwise, or (ii) ownership of fifty percent (50%) or more of the
      outstanding shares, or (iii) beneficial ownership of such entity.

      "You" (or "Your") shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      "Source" form shall mean the preferred form for making modifications,
      including but not limited to software source code, documentation
      source, and configuration files.

      "Object" form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      "Work" shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      "Derivative Works" shall mean any work, whether in Source or Object
      form, that is based on (or derived from) the Work and for which the
      editorial revisions, annotations, elaborations, or other modifications
      represent, as a whole, an original work of authorship. For the purposes
      of this License, Derivative Works shall not include works that remain
      separable from, or merely link (or bind by name) to the interfaces of,
      the Work and Derivative Works thereof.

      "Contribution" shall mean any work of authorship, including
      the original version of the Work and any modifications or additions
      to that Work or Derivative Works thereof, that is intentionally
      submitted to Licensor for inclusion in the Work by the copyright owner
      or by an individual or Legal Entity authorized to submit on behalf of
      the copyright owner. For the purposes of this definition, "submitted"
      means any form of electronic, verbal, or written communication sent
      to the Licensor or its representatives, including but not limited to
      communication on electronic mailing lists, source code control systems,
      and issue tracking systems that are managed by, or on behalf of, the
      Licensor for the purpose of discussing and improving the Work, but
      excluding communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as "Not a Contribution."

      "Contributor" shall mean Licensor and any individual or Legal Entity
      on behalf of whom a Contribution has been received by Licensor and
      subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      copyright license to reproduce, prepare Derivative Works of,
      publicly display, publicly perform, sublicense, and distribute the
      Work and such Derivative Works in Source or Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have made,
      use, offer to sell, sell, import, and otherwise transfer the Work,
      where such license applies only to those patent claims licensable
      by such Contributor that are necessarily infringed by their
      Contribution(s) alone or by combination of their Contribution(s)
      with the Work to which such Contribution(s) was submitted. If You
      institute patent litigation against any entity (including a
      cross-claim or counterclaim in a lawsuit) alleging that the Work
      or a Contribution incorporated within the Work constitutes direct
      or contributory patent infringement, then any patent licenses
      granted to You under this License for that Work shall terminate
      as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a "NOTICE" text file as part of its
          distribution, then any Derivative Works that You distribute must
          include a readable copy of the attribution notices contained
          within such NOTICE file, excluding those notices that do not
          pertain to any part of the Derivative Works, in at least one
          of the following places: within a NOTICE text file distributed
          as part of the Derivative Works; within the Source form or
          documentation, if provided along with the Derivative Works; or,
          within a display generated by the Derivative Works, if and
          wherever such third-party notices normally appear. The contents
          of the NOTICE file are for informational purposes only and
          do not modify the License. You may add Your own attribution
          notices within Derivative Works that You distribute, alongside
          or as an addendum to the NOTICE text from the Work, provided
          that such additional attribution notices cannot be construed
          as modifying the License.

      You may add Your own copyright statement to Your modifications and
      may provide additional or different license terms and conditions
      for use, reproduction, or distribution of Your modifications, or
      for any such Derivative Works as a whole, provided Your use,
      reproduction, and distribution of the Work otherwise complies with
      the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state otherwise,
      any Contribution intentionally submitted for inclusion in the Work
      by You to the Licensor shall be under the terms and conditions of
      this License, without any additional terms or conditions.
      Notwithstanding the above, nothing herein shall supersede or modify
      the terms of any separate license agreement you may have executed
      with Licensor regarding such Contributions.

   6. Trademarks. This License does not grant permission to use the trade
      names, trademarks, service marks, or product names of the Licensor,
      except as required for reasonable and customary use in describing the
      origin of the Work and reproducing the content of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or conditions
      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
      PARTICULAR PURPOSE. You are solely responsible for determining the
      appropriateness of using or redistributing the Work and assume any
      risks associated with Your exercise of permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and grossly
      negligent acts) or agreed to in writing, shall any Contributor be
      liable to You for damages, including any direct, indirect, special,
      incidental, or consequential damages of any character arising as a
      result of this License or out of the use or inability to use the
      Work (including but not limited to damages for loss of goodwill,
      work stoppage, computer failure or malfunction, or any and all
      other commercial damages or losses), even if such Contributor
      has been advised of the possibility of such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by reason
      of your accepting any such warranty or additional liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets "[]"
      replaced with your own identifying information. (Don't include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same "printed page" as the copyright notice for easier
      identification within third-party archives.

   Copyright [yyyy] [name of copyright owner]

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.



================================================
FILE: mvnw
================================================
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.2
#
# Optional ENV vars
# -----------------
#   JAVA_HOME - location of a JDK home dir, required when download maven via java source
#   MVNW_REPOURL - repo url base for downloading maven distribution
#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != debug ] || set -x

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
  [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
  native_path() { cygpath --path --windows "$1"; }
  ;;
esac

# set JAVACMD and JAVACCMD
set_java_home() {
  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched
  if [ -n "${JAVA_HOME-}" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
      JAVACCMD="$JAVA_HOME/jre/sh/javac"
    else
      JAVACMD="$JAVA_HOME/bin/java"
      JAVACCMD="$JAVA_HOME/bin/javac"

      if [ ! -x "$JAVACMD" ] || [ ! -x "$JAVACCMD" ]; then
        echo "The JAVA_HOME environment variable is not defined correctly, so mvnw cannot run." >&2
        echo "JAVA_HOME is set to \"$JAVA_HOME\", but \"\$JAVA_HOME/bin/java\" or \"\$JAVA_HOME/bin/javac\" does not exist." >&2
        return 1
      fi
    fi
  else
    JAVACMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v java
    )" || :
    JAVACCMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v javac
    )" || :

    if [ ! -x "${JAVACMD-}" ] || [ ! -x "${JAVACCMD-}" ]; then
      echo "The java/javac command does not exist in PATH nor is JAVA_HOME set, so mvnw cannot run." >&2
      return 1
    fi
  fi
}

# hash string like Java String::hashCode
hash_string() {
  str="${1:-}" h=0
  while [ -n "$str" ]; do
    char="${str%"${str#?}"}"
    h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
    str="${str#?}"
  done
  printf %x\\n $h
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" != true ] || verbose() { printf %s\\n "${1-}"; }

die() {
  printf %s\\n "$1" >&2
  exit 1
}

trim() {
  # MWRAPPER-139:
  #   Trims trailing and leading whitespace, carriage returns, tabs, and linefeeds.
  #   Needed for removing poorly interpreted newline sequences when running in more
  #   exotic environments such as mingw bash on Windows.
  printf "%s" "${1}" | tr -d '[:space:]'
}

# parse distributionUrl and optional distributionSha256Sum, requires .mvn/wrapper/maven-wrapper.properties
while IFS="=" read -r key value; do
  case "${key-}" in
  distributionUrl) distributionUrl=$(trim "${value-}") ;;
  distributionSha256Sum) distributionSha256Sum=$(trim "${value-}") ;;
  esac
done <"${0%/*}/.mvn/wrapper/maven-wrapper.properties"
[ -n "${distributionUrl-}" ] || die "cannot read distributionUrl property in ${0%/*}/.mvn/wrapper/maven-wrapper.properties"

case "${distributionUrl##*/}" in
maven-mvnd-*bin.*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  case "${PROCESSOR_ARCHITECTURE-}${PROCESSOR_ARCHITEW6432-}:$(uname -a)" in
  *AMD64:CYGWIN* | *AMD64:MINGW*) distributionPlatform=windows-amd64 ;;
  :Darwin*x86_64) distributionPlatform=darwin-amd64 ;;
  :Darwin*arm64) distributionPlatform=darwin-aarch64 ;;
  :Linux*x86_64*) distributionPlatform=linux-amd64 ;;
  *)
    echo "Cannot detect native platform for mvnd on $(uname)-$(uname -m), use pure java version" >&2
    distributionPlatform=linux-amd64
    ;;
  esac
  distributionUrl="${distributionUrl%-bin.*}-$distributionPlatform.zip"
  ;;
maven-mvnd-*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;
*) MVN_CMD="mvn${0##*/mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;
esac

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
[ -z "${MVNW_REPOURL-}" ] || distributionUrl="$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*"$_MVNW_REPO_PATTERN"}"
distributionUrlName="${distributionUrl##*/}"
distributionUrlNameMain="${distributionUrlName%.*}"
distributionUrlNameMain="${distributionUrlNameMain%-bin}"
MAVEN_USER_HOME="${MAVEN_USER_HOME:-${HOME}/.m2}"
MAVEN_HOME="${MAVEN_USER_HOME}/wrapper/dists/${distributionUrlNameMain-}/$(hash_string "$distributionUrl")"

exec_maven() {
  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :
  exec "$MAVEN_HOME/bin/$MVN_CMD" "$@" || die "cannot exec $MAVEN_HOME/bin/$MVN_CMD"
}

if [ -d "$MAVEN_HOME" ]; then
  verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  exec_maven "$@"
fi

case "${distributionUrl-}" in
*?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;
*) die "distributionUrl is not valid, must match *-bin.zip or maven-mvnd-*.zip, but found '${distributionUrl-}'" ;;
esac

# prepare tmp dir
if TMP_DOWNLOAD_DIR="$(mktemp -d)" && [ -d "$TMP_DOWNLOAD_DIR" ]; then
  clean() { rm -rf -- "$TMP_DOWNLOAD_DIR"; }
  trap clean HUP INT TERM EXIT
else
  die "cannot create temp dir"
fi

mkdir -p -- "${MAVEN_HOME%/*}"

# Download and Install Apache Maven
verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
verbose "Downloading from: $distributionUrl"
verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

# select .zip or .tar.gz
if ! command -v unzip >/dev/null; then
  distributionUrl="${distributionUrl%.zip}.tar.gz"
  distributionUrlName="${distributionUrl##*/}"
fi

# verbose opt
__MVNW_QUIET_WGET=--quiet __MVNW_QUIET_CURL=--silent __MVNW_QUIET_UNZIP=-q __MVNW_QUIET_TAR=''
[ "${MVNW_VERBOSE-}" != true ] || __MVNW_QUIET_WGET='' __MVNW_QUIET_CURL='' __MVNW_QUIET_UNZIP='' __MVNW_QUIET_TAR=v

# normalize http auth
case "${MVNW_PASSWORD:+has-password}" in
'') MVNW_USERNAME='' MVNW_PASSWORD='' ;;
has-password) [ -n "${MVNW_USERNAME-}" ] || MVNW_USERNAME='' MVNW_PASSWORD='' ;;
esac

if [ -z "${MVNW_USERNAME-}" ] && command -v wget >/dev/null; then
  verbose "Found wget ... using wget"
  wget ${__MVNW_QUIET_WGET:+"$__MVNW_QUIET_WGET"} "$distributionUrl" -O "$TMP_DOWNLOAD_DIR/$distributionUrlName" || die "wget: Failed to fetch $distributionUrl"
elif [ -z "${MVNW_USERNAME-}" ] && command -v curl >/dev/null; then
  verbose "Found curl ... using curl"
  curl ${__MVNW_QUIET_CURL:+"$__MVNW_QUIET_CURL"} -f -L -o "$TMP_DOWNLOAD_DIR/$distributionUrlName" "$distributionUrl" || die "curl: Failed to fetch $distributionUrl"
elif set_java_home; then
  verbose "Falling back to use Java to download"
  javaSource="$TMP_DOWNLOAD_DIR/Downloader.java"
  targetZip="$TMP_DOWNLOAD_DIR/$distributionUrlName"
  cat >"$javaSource" <<-END
	public class Downloader extends java.net.Authenticator
	{
	  protected java.net.PasswordAuthentication getPasswordAuthentication()
	  {
	    return new java.net.PasswordAuthentication( System.getenv( "MVNW_USERNAME" ), System.getenv( "MVNW_PASSWORD" ).toCharArray() );
	  }
	  public static void main( String[] args ) throws Exception
	  {
	    setDefault( new Downloader() );
	    java.nio.file.Files.copy( java.net.URI.create( args[0] ).toURL().openStream(), java.nio.file.Paths.get( args[1] ).toAbsolutePath().normalize() );
	  }
	}
	END
  # For Cygwin/MinGW, switch paths to Windows format before running javac and java
  verbose " - Compiling Downloader.java ..."
  "$(native_path "$JAVACCMD")" "$(native_path "$javaSource")" || die "Failed to compile Downloader.java"
  verbose " - Running Downloader.java ..."
  "$(native_path "$JAVACMD")" -cp "$(native_path "$TMP_DOWNLOAD_DIR")" Downloader "$distributionUrl" "$(native_path "$targetZip")"
fi

# If specified, validate the SHA-256 sum of the Maven distribution zip file
if [ -n "${distributionSha256Sum-}" ]; then
  distributionSha256Result=false
  if [ "$MVN_CMD" = mvnd.sh ]; then
    echo "Checksum validation is not supported for maven-mvnd." >&2
    echo "Please disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  elif command -v sha256sum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | sha256sum -c >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  elif command -v shasum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | shasum -a 256 -c >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  else
    echo "Checksum validation was requested but neither 'sha256sum' or 'shasum' are available." >&2
    echo "Please install either command, or disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  fi
  if [ $distributionSha256Result = false ]; then
    echo "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised." >&2
    echo "If you updated your Maven version, you need to update the specified distributionSha256Sum property." >&2
    exit 1
  fi
fi

# unzip and move
if command -v unzip >/dev/null; then
  unzip ${__MVNW_QUIET_UNZIP:+"$__MVNW_QUIET_UNZIP"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -d "$TMP_DOWNLOAD_DIR" || die "failed to unzip"
else
  tar xzf${__MVNW_QUIET_TAR:+"$__MVNW_QUIET_TAR"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -C "$TMP_DOWNLOAD_DIR" || die "failed to untar"
fi
printf %s\\n "$distributionUrl" >"$TMP_DOWNLOAD_DIR/$distributionUrlNameMain/mvnw.url"
mv -- "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain" "$MAVEN_HOME" || [ -d "$MAVEN_HOME" ] || die "fail to move MAVEN_HOME"

clean || :
exec_maven "$@"



================================================
FILE: mvnw.cmd
================================================
<# : batch portion
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    http://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Apache Maven Wrapper startup batch script, version 3.3.2
@REM
@REM Optional ENV vars
@REM   MVNW_REPOURL - repo url base for downloading maven distribution
@REM   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
@REM   MVNW_VERBOSE - true: enable verbose log; others: silence the output
@REM ----------------------------------------------------------------------------

@IF "%__MVNW_ARG0_NAME__%"=="" (SET __MVNW_ARG0_NAME__=%~nx0)
@SET __MVNW_CMD__=
@SET __MVNW_ERROR__=
@SET __MVNW_PSMODULEP_SAVE=%PSModulePath%
@SET PSModulePath=
@FOR /F "usebackq tokens=1* delims==" %%A IN (`powershell -noprofile "& {$scriptDir='%~dp0'; $script='%__MVNW_ARG0_NAME__%'; icm -ScriptBlock ([Scriptblock]::Create((Get-Content -Raw '%~f0'))) -NoNewScope}"`) DO @(
  IF "%%A"=="MVN_CMD" (set __MVNW_CMD__=%%B) ELSE IF "%%B"=="" (echo %%A) ELSE (echo %%A=%%B)
)
@SET PSModulePath=%__MVNW_PSMODULEP_SAVE%
@SET __MVNW_PSMODULEP_SAVE=
@SET __MVNW_ARG0_NAME__=
@SET MVNW_USERNAME=
@SET MVNW_PASSWORD=
@IF NOT "%__MVNW_CMD__%"=="" (%__MVNW_CMD__% %*)
@echo Cannot start maven from wrapper >&2 && exit /b 1
@GOTO :EOF
: end batch / begin powershell #>

$ErrorActionPreference = "Stop"
if ($env:MVNW_VERBOSE -eq "true") {
  $VerbosePreference = "Continue"
}

# calculate distributionUrl, requires .mvn/wrapper/maven-wrapper.properties
$distributionUrl = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionUrl
if (!$distributionUrl) {
  Write-Error "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"
}

switch -wildcard -casesensitive ( $($distributionUrl -replace '^.*/','') ) {
  "maven-mvnd-*" {
    $USE_MVND = $true
    $distributionUrl = $distributionUrl -replace '-bin\.[^.]*$',"-windows-amd64.zip"
    $MVN_CMD = "mvnd.cmd"
    break
  }
  default {
    $USE_MVND = $false
    $MVN_CMD = $script -replace '^mvnw','mvn'
    break
  }
}

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
if ($env:MVNW_REPOURL) {
  $MVNW_REPO_PATTERN = if ($USE_MVND) { "/org/apache/maven/" } else { "/maven/mvnd/" }
  $distributionUrl = "$env:MVNW_REPOURL$MVNW_REPO_PATTERN$($distributionUrl -replace '^.*'+$MVNW_REPO_PATTERN,'')"
}
$distributionUrlName = $distributionUrl -replace '^.*/',''
$distributionUrlNameMain = $distributionUrlName -replace '\.[^.]*$','' -replace '-bin$',''
$MAVEN_HOME_PARENT = "$HOME/.m2/wrapper/dists/$distributionUrlNameMain"
if ($env:MAVEN_USER_HOME) {
  $MAVEN_HOME_PARENT = "$env:MAVEN_USER_HOME/wrapper/dists/$distributionUrlNameMain"
}
$MAVEN_HOME_NAME = ([System.Security.Cryptography.MD5]::Create().ComputeHash([byte[]][char[]]$distributionUrl) | ForEach-Object {$_.ToString("x2")}) -join ''
$MAVEN_HOME = "$MAVEN_HOME_PARENT/$MAVEN_HOME_NAME"

if (Test-Path -Path "$MAVEN_HOME" -PathType Container) {
  Write-Verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
  exit $?
}

if (! $distributionUrlNameMain -or ($distributionUrlName -eq $distributionUrlNameMain)) {
  Write-Error "distributionUrl is not valid, must end with *-bin.zip, but found $distributionUrl"
}

# prepare tmp dir
$TMP_DOWNLOAD_DIR_HOLDER = New-TemporaryFile
$TMP_DOWNLOAD_DIR = New-Item -Itemtype Directory -Path "$TMP_DOWNLOAD_DIR_HOLDER.dir"
$TMP_DOWNLOAD_DIR_HOLDER.Delete() | Out-Null
trap {
  if ($TMP_DOWNLOAD_DIR.Exists) {
    try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
    catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
  }
}

New-Item -Itemtype Directory -Path "$MAVEN_HOME_PARENT" -Force | Out-Null

# Download and Install Apache Maven
Write-Verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
Write-Verbose "Downloading from: $distributionUrl"
Write-Verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

$webclient = New-Object System.Net.WebClient
if ($env:MVNW_USERNAME -and $env:MVNW_PASSWORD) {
  $webclient.Credentials = New-Object System.Net.NetworkCredential($env:MVNW_USERNAME, $env:MVNW_PASSWORD)
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$webclient.DownloadFile($distributionUrl, "$TMP_DOWNLOAD_DIR/$distributionUrlName") | Out-Null

# If specified, validate the SHA-256 sum of the Maven distribution zip file
$distributionSha256Sum = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionSha256Sum
if ($distributionSha256Sum) {
  if ($USE_MVND) {
    Write-Error "Checksum validation is not supported for maven-mvnd. `nPlease disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties."
  }
  Import-Module $PSHOME\Modules\Microsoft.PowerShell.Utility -Function Get-FileHash
  if ((Get-FileHash "$TMP_DOWNLOAD_DIR/$distributionUrlName" -Algorithm SHA256).Hash.ToLower() -ne $distributionSha256Sum) {
    Write-Error "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised. If you updated your Maven version, you need to update the specified distributionSha256Sum property."
  }
}

# unzip and move
Expand-Archive "$TMP_DOWNLOAD_DIR/$distributionUrlName" -DestinationPath "$TMP_DOWNLOAD_DIR" | Out-Null
Rename-Item -Path "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain" -NewName $MAVEN_HOME_NAME | Out-Null
try {
  Move-Item -Path "$TMP_DOWNLOAD_DIR/$MAVEN_HOME_NAME" -Destination $MAVEN_HOME_PARENT | Out-Null
} catch {
  if (! (Test-Path -Path "$MAVEN_HOME" -PathType Container)) {
    Write-Error "fail to move MAVEN_HOME"
  }
} finally {
  try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
  catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
}

Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"



================================================
FILE: pom.xml
================================================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.embabel.build</groupId>
        <artifactId>embabel-build-parent</artifactId>
        <version>0.1.6-SNAPSHOT</version>
    </parent>
    <groupId>com.embabel.example</groupId>
    <artifactId>example-agent-parent</artifactId>
    <version>0.2.0-SNAPSHOT</version>
    <packaging>pom</packaging>
    <name>Embabel Example Agent Parent</name>
    <description>Example Agentic Flows</description>

    <properties>
        <embabel-agent.version>0.2.0-SNAPSHOT</embabel-agent.version>
        <mockk.version>1.13.3</mockk.version>
    </properties>

    <modules>
        <module>examples-kotlin</module>
        <module>examples-java</module>
        <module>examples-common</module>
    </modules>


    <!-- Embabel Common BOM -->
    <dependencyManagement>
        <dependencies>
            <!-- Embabel Agent BOM -->
            <dependency>
                <groupId>com.embabel.agent</groupId>
                <artifactId>embabel-agent-dependencies</artifactId>
                <version>${embabel-agent.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <!-- ================ Observability ================ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-tracing-bridge-brave</artifactId>
        </dependency>

        <dependency>
            <groupId>io.zipkin.reporter2</groupId>
            <artifactId>zipkin-reporter-brave</artifactId>
        </dependency>
        <!-- ================ Observability ================ -->

        <!-- Unit Test Dependencies -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>io.mockk</groupId>
            <artifactId>mockk-jvm</artifactId>
            <version>${mockk.version}</version>
        </dependency>
    </dependencies>

    <repositories>
        <repository>
            <id>embabel-releases</id>
            <url>https://repo.embabel.com/artifactory/libs-release</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>embabel-snapshots</id>
            <url>https://repo.embabel.com/artifactory/libs-snapshot</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>



================================================
FILE: books/cane_toad_adventures-a_fun_guide_for_kids.md
================================================
# Cane Toad Adventures: A Fun Guide for Kids
a fun book for kids

## Meet the Cane Toad!
Cane toads are big and bumpy! They are about 4 to 6 inches long, sometimes even bigger. Their skin is dry and warty, not smooth like frogs. They have a special 'M' shape on their nose. Their bumpy skin helps keep them safe and makes them easy to spot!

## Where Do Cane Toads Come From?
Cane toads come from warm places in Central and South America. They live in forests and near rivers. These toads have dry, bumpy skin and are quite big. They are part of nature there, where other animals eat them and help keep their numbers just right.

## Toads on a Mission: Why They Travelled
People moved cane toads to places like Australia and Fiji to help farmers. They wanted cane toads to eat bugs that harmed crops. But the toads spread fast and caused new problems.

## Toadville Takeover: When Things Get Out of Hand
Cane toads were brought to new lands to stop bugs! But they had no enemies there. They spread fast, taking over places quickly. Now, they are everywhere, causing big problems for other animals.

## Super Mamas: How Cane Toads Have Babies
Cane toad moms lay up to 36,000 eggs! The eggs float in long jelly strings on water. Tiny tadpoles hatch fast and swim around, eating plants and growing bigger before turning into toads.

## Toxic Toads: What Makes Them Dangerous
Cane toads have special poison in their skin called bufotoxins. These poisons protect them from animals who want to eat them. If a predator tries, the poison can make it very sick or even stop its heart. Even baby toads and eggs carry this poison! This is why cane toads are so tricky for other animals and people. Always be careful and never touch a toad without an adult nearby.

## Friends and Foes: What Eats Cane Toads?
Some animals eat cane toads even though they are poisonous. Birds like crows peck at safe places. Snakes and crocodiles sometimes eat toads that are less toxic. But many animals get sick or die from the toad's poison. This poison, called bufotoxin, protects the toad by hurting a predator's heart and nerves. Some native Australian animals, like certain lizards and quolls, have learned to avoid the poison and can safely eat cane toads.

## Toads Gone Wild: Problems They Cause
Cane toads hurt many animals by being poisonous. Native animals eat them and get very sick or die. They also eat lots of food, leaving little for other animals. This hurts the balance of nature and makes it hard for some creatures to live.

## Toad Tricks: How They Adapt and Survive
Cane toads are clever survivors! They can travel far each night to find water and food. Their skin helps them live through hot, dry times. They lay many eggs so baby toads grow strong. When danger comes, their poison keeps them safe. These tricks help cane toads live and spread everywhere!

## Cultural Cane Toads: Stories and Fun Facts
Cane toads are famous in stories and culture! In Australia, a funny magazine called The Cane Toad Times jokes about these toads taking over. Some tales show them as tricky or silly characters. Long ago, in Mesoamerica, people thought cane toads were special and used their skin in rituals. These toads remind us about being careful when animals move to new places. They teach us about nature, survival, and even humor!

## Protecting Nature: What We Can Do About Cane Toads
People help battle cane toads in many ways. They catch toads during toad musters and use traps. Scientists teach animals not to eat toads using safe tastes. Together, communities work hard to keep nature safe and happy.


================================================
FILE: examples-common/pom.xml
================================================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.embabel.example</groupId>
        <artifactId>example-agent-parent</artifactId>
        <version>0.2.0-SNAPSHOT</version>
    </parent>
    <artifactId>examples-common</artifactId>
    <name>Embabel Example Agent Common</name>
    <description>Common Services for Example Agents</description>

    <dependencies>
        <!-- Main Dependencies -->
        <dependency>
            <groupId>com.embabel.agent</groupId>
            <artifactId>embabel-agent-api</artifactId>
        </dependency>

        <!-- Test Dependencies -->
        <dependency>
            <groupId>com.embabel.agent</groupId>
            <artifactId>embabel-agent-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.jetbrains.kotlin</groupId>
                <artifactId>kotlin-maven-plugin</artifactId>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
            </plugin>

        </plugins>
    </build>

</project>



================================================
FILE: examples-common/src/main/kotlin/com/embabel/example/common/InMemoryCrudRepository.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.common

import org.springframework.data.repository.CrudRepository
import java.util.*
import java.util.concurrent.ConcurrentHashMap

/**
 * Spring Data CrudRepository with in memory storage.
 * Not itself intended for production usage, but can be used
 * in demos to minimize dependencies, and ultimately swapped out
 * for serious use.
 */
open class InMemoryCrudRepository<T : Any>(
    private val idGetter: (T) -> String?,
    private val idSetter: ((T, String) -> T),
) : CrudRepository<T, String> {

    private val storage = ConcurrentHashMap<String, T>()

    @Suppress("UNCHECKED_CAST")
    override fun <S : T> save(entity: S): S {
        var savedEntity = entity
        val existingId = idGetter.invoke(entity)
        val id = existingId ?: UUID.randomUUID().toString()
        savedEntity = (if (existingId == null) idSetter.invoke(savedEntity, id) else entity) as S
        storage[id] = savedEntity
        return savedEntity
    }

    override fun <S : T> saveAll(entities: Iterable<S>): Iterable<S> {
        return entities.map { save(it) }
    }

    override fun findById(id: String): Optional<T> {
        return Optional.ofNullable(storage[id])
    }

    override fun existsById(id: String): Boolean {
        return storage.containsKey(id)
    }

    override fun findAll(): Iterable<T> {
        return ArrayList(storage.values)
    }

    override fun findAllById(ids: Iterable<String>): Iterable<T> {
        return ids.mapNotNull { storage[it] }
    }

    override fun count(): Long {
        return storage.size.toLong()
    }

    override fun deleteById(id: String) {
        storage.remove(id)
    }

    override fun delete(entity: T) {
        val id = idGetter.invoke(entity)
        if (id != null) {
            deleteById(id)
        }
    }

    override fun deleteAllById(ids: Iterable<String>) {
        ids.forEach { deleteById(it) }
    }

    override fun deleteAll(entities: Iterable<T>) {
        entities.forEach { delete(it) }
    }

    override fun deleteAll() {
        storage.clear()
    }

}



================================================
FILE: examples-common/src/main/kotlin/com/embabel/example/horoscope/HoroscopeService.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope

import org.springframework.stereotype.Service
import org.springframework.web.client.RestClient

fun interface HoroscopeService {

    fun dailyHoroscope(sign: String): String
}

@Service
class HoroscopeAppApiHoroscopeService : HoroscopeService {

    private val restClient = RestClient.builder()
        .baseUrl("https://horoscope-app-api.vercel.app")
        .build()

    override fun dailyHoroscope(sign: String): String {
        val response = restClient.get()
            .uri("/api/v1/get-horoscope/daily?sign={sign}", sign.lowercase())
            .retrieve()
            .body(HoroscopeResponse::class.java)

        return response?.data?.horoscope_data
            ?: "Unable to retrieve horoscope for $sign today."
    }
}

private data class HoroscopeResponse(
    val success: Boolean,
    val status: Int,
    val data: HoroscopeData?
)

private data class HoroscopeData(
    val date: String,
    val horoscope_data: String
)



================================================
FILE: examples-java/README.md
================================================
[Binary file]


================================================
FILE: examples-java/pom.xml
================================================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.embabel.example</groupId>
        <artifactId>example-agent-parent</artifactId>
        <version>0.2.0-SNAPSHOT</version>
    </parent>
    <groupId>com.embabel.example.java</groupId>
    <artifactId>example-agent-java</artifactId>
    <name>Embabel Agent Java Examples</name>
    <description>Java Examples for Embabel Agentic Flows</description>
    <properties>
        <spring-shell-standard.version>3.4.0</spring-shell-standard.version>
    </properties>


    <dependencies>
        <dependency>
            <groupId>com.embabel.example</groupId>
            <artifactId>examples-common</artifactId>
            <version>${project.version}</version>
        </dependency>

        <!-- Ollama is always included as an option for local model hosting -->
        <dependency>
            <groupId>com.embabel.agent</groupId>
            <artifactId>embabel-agent-starter-ollama</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.shell</groupId>
            <artifactId>spring-shell-standard</artifactId>
            <version>${spring-shell-standard.version}</version>
        </dependency>

        <!-- Test Dependencies -->
        <dependency>
            <groupId>com.embabel.agent</groupId>
            <artifactId>embabel-agent-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
            </plugin>

        </plugins>
    </build>

    <profiles>
        <profile>
            <id>openai-models</id>
            <activation>
                <property>
                    <name>env.OPENAI_API_KEY</name>
                </property>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-openai</artifactId>
                </dependency>
            </dependencies>
        </profile>
        <profile>
            <id>anthropic-models</id>
            <activation>
                <property>
                    <name>env.ANTHROPIC_API_KEY</name>
                </property>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-anthropic</artifactId>
                </dependency>
            </dependencies>
        </profile>
         <profile>
            <id>bedrock-models</id>
            <activation>
                <property>
                    <name>env.ENABLE_BEDROCK</name>
                </property>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-bedrock</artifactId>
                </dependency>
            </dependencies>
        </profile>
        <profile>
            <id>docker-models</id>
            <activation>
                <property>
                    <name>env.ENABLE_DOCKER_MODELS</name>
                </property>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-dockermodels</artifactId>
                </dependency>
            </dependencies>
        </profile>
        <profile>
            <id>enable-shell-mcp-client</id>
            <activation>
                <activeByDefault>true</activeByDefault>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-shell</artifactId>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                        <configuration>
                            <mainClass>com.embabel.example.JavaAgentShellApplication</mainClass>
                        </configuration>
                        <version>${spring-boot.version}</version>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>enable-shell</id>
            <activation>
                <activeByDefault>false</activeByDefault>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-shell</artifactId>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                        <configuration>
                            <mainClass>com.embabel.example.JavaAgentSimpleShellApplication</mainClass>
                        </configuration>
                        <version>${spring-boot.version}</version>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>enable-agent-mcp-server</id>
            <activation>
                <activeByDefault>false</activeByDefault>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-mcpserver</artifactId>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                        <configuration>
                            <mainClass>com.embabel.example.JavaMcpServerApplication</mainClass>
                        </configuration>
                        <version>${spring-boot.version}</version>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>

</project>



================================================
FILE: examples-java/src/main/java/com/embabel/example/JavaAgentShellApplication.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example;

import com.embabel.agent.config.annotation.EnableAgents;
import com.embabel.agent.config.annotation.LoggingThemes;
import com.embabel.agent.config.annotation.McpServers;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.ConfigurationPropertiesScan;


/**
 * Spring Boot application that provides an interactive command-line shell for Embabel agents
 * with Star Wars themed logging and Docker Desktop integration.
 *
 * <p>This application runs in interactive shell mode, allowing developers to test and interact
 * with agents through a REPL-like interface. It combines the development-friendly shell
 * environment with fun Star Wars themed logging messages and Docker container capabilities.
 *
 * @author Embabel Team
 * @see EnableAgents
 * @since 1.0
 */
@SpringBootApplication
@ConfigurationPropertiesScan(
        basePackages = {
                "com.embabel.example"
        }
)
@EnableAgents(
        loggingTheme = LoggingThemes.STAR_WARS,
        mcpServers = {McpServers.DOCKER_DESKTOP}
)
public class JavaAgentShellApplication {

    /**
     * Application entry point.
     *
     * <p>Starts the Spring Boot application with an interactive shell interface,
     * Star Wars themed logging, and Docker Desktop integration.
     *
     * @param args command line arguments passed to the application
     */
    public static void main(String[] args) {
        SpringApplication.run(JavaAgentShellApplication.class, args);
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/JavaAgentSimpleShellApplication.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example;

import com.embabel.agent.config.annotation.EnableAgents;
import com.embabel.agent.config.annotation.LoggingThemes;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.ConfigurationPropertiesScan;

/**
 * Spring Boot application that provides an interactive command-line shell for Embabel agents
 * with Star Wars themed logging.
 * <br>
 * This is a simple example application demonstrating how to set up an Embabel agent
 * environment with a customized logging theme.
 * <br>
 * Docker Tools are not enabled in this example to keep the setup straightforward,
 * but keep in mind that some examples may require Docker Tools for full functionality.
 *
 * <p>This application runs in interactive shell mode, allowing developers to test and interact
 * with agents through a REPL-like interface.
 *
 * @author Embabel Team
 * @see EnableAgents
 * @since 1.0
 */
@SpringBootApplication
@ConfigurationPropertiesScan(
        basePackages = {
                "com.embabel.example"
        }
)
@EnableAgents(
        loggingTheme = LoggingThemes.SEVERANCE
)
public class JavaAgentSimpleShellApplication {

    /**
     * Application entry point.
     *
     * <p>Starts the Spring Boot application with an interactive shell interface,
     * Star Wars themed logging.
     *
     * @param args command line arguments passed to the application
     */
    public static void main(String[] args) {
        SpringApplication.run(JavaAgentSimpleShellApplication.class, args);
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/JavaMcpServerApplication.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example;

import com.embabel.agent.config.annotation.EnableAgents;
import com.embabel.agent.config.annotation.McpServers;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.ConfigurationPropertiesScan;

/**
 * Spring Boot application that runs Embabel agents as an MCP (Model Context Protocol) server.
 *
 * <p>This application exposes your agents as MCP-compatible tools that can be consumed by
 * AI assistants like Claude Desktop, development environments with MCP support, or other
 * MCP-compliant clients. It also enables Docker Desktop integration for containerized
 * tool execution.
 *
 * @author Embabel Team
 * @since 1.0
 */
@SpringBootApplication
@ConfigurationPropertiesScan(
        basePackages = {
                "com.embabel.example"
        }
)
@EnableAgents(
        mcpServers = {McpServers.DOCKER_DESKTOP}
)
public class JavaMcpServerApplication {

    /**
     * Application entry point.
     *
     * <p>Starts the Spring Boot application with MCP server capabilities and
     * Docker Desktop integration enabled.
     *
     * @param args command line arguments passed to the application
     */
    public static void main(String[] args) {
        SpringApplication.run(JavaMcpServerApplication.class, args);
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/crew/README.md
================================================
# Agents based on Crew AI samples


================================================
FILE: examples-java/src/main/java/com/embabel/example/crew/bookwriter/README.md
================================================
# Book Writer

Embabel implementation of CrewAI's "Write a Book with Flows" example.
https://github.com/crewAIInc/crewAI-examples/tree/main/flows/write_a_book_with_flows


================================================
FILE: examples-java/src/main/java/com/embabel/example/crew/bookwriter/BookWriter.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.crew.bookwriter;

import com.embabel.agent.api.annotation.*;
import com.embabel.agent.api.common.OperationContext;
import com.embabel.agent.core.CoreToolGroups;
import com.embabel.agent.domain.library.ResearchReport;
import com.embabel.agent.prompt.persona.RoleGoalBackstory;
import com.embabel.agent.tools.file.FileTools;
import com.embabel.common.ai.model.LlmOptions;
import com.embabel.common.ai.prompt.PromptContributor;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.context.properties.ConfigurationProperties;

import java.io.File;
import java.nio.file.Path;
import java.util.List;
import java.util.stream.Collectors;

record ChapterOutline(String title, String content) {
}

record BookOutline(String title,
                   List<ChapterOutline> chapterOutlines) implements PromptContributor {

    @NotNull
    @Override
    public String contribution() {
        return "Book Outline:\nTitle: " + title + "\n" + chapterOutlines.stream()
                .map(chapter -> chapter.title() + "\n" + chapter.content())
                .collect(Collectors.joining("\n\n"));
    }
}

record Chapter(String title, String content) {
}

record Book(BookRequest request,
            String title,
            List<Chapter> chapters) {

    public String text() {
        return "# " + title() + "\n" + request.goal() + "\n\n" +
                chapters().stream()
                        .map(chapter -> "## " + chapter.title() + "\n" + chapter.content())
                        .collect(Collectors.joining("\n\n"));
    }
}

record BookRequest(String topic, String goal, int wordsPerChapter) implements PromptContributor {
    @NotNull
    @Override
    public String contribution() {
        return """
                Book Request:
                Topic: %s
                Goal: %s
                Maximum words per chapter: %d
                """.formatted(topic, goal, wordsPerChapter);
    }
}

/**
 * All properties can be overridden in application.yml
 */
@ConfigurationProperties("examples.book-writer")
record BookWriterConfig(
        LlmOptions researcherLlm,
        LlmOptions writerLlm,
        int maxConcurrency,
        RoleGoalBackstory researcher,
        RoleGoalBackstory outliner,
        RoleGoalBackstory writer,
        String outputDirectory
) {

    public Path saveContent(Book book) {
        var dir = outputDirectory != null ? outputDirectory : System.getProperty("user.dir");
        var fileName = book.title()
                .replaceAll("[<>:\"|*?/\\\\]", "_")
                .replace(" ", "_")
                .toLowerCase() + ".md";
        return FileTools.readWrite(dir).createFile("books" + File.separator + fileName, book.text(), true);
    }
}


/**
 * Based on the Crew AI Book Writer example, this agent creates a book by first researching the topic,
 * then creating an outline, and finally writing the chapters.
 * See <a href="https://github.com/crewAIInc/crewAI-examples/tree/main/flows/write_a_book_with_flows">Write a book with flows</a>
 */
@Agent(description = "Write a book, first creating an outline, then writing the chapters and combining them")
public record BookWriter(BookWriterConfig config) {

    static final Logger logger = LoggerFactory.getLogger(BookWriter.class);

    public BookWriter {
        logger.info("Initialized with configuration {}", config);
    }

    @Action(cost = 100.0)
    BookRequest askForBookRequest(OperationContext context) {
        return WaitFor.formSubmission(
                "Please provide the topic, goal, and maximum words per chapter for the book you want to write:",
                BookRequest.class);
    }

    @Action
    ResearchReport researchTopic(
            BookRequest bookRequest,
            OperationContext context) {
        return context.ai()
                .withLlm(config.researcherLlm())
                .withPromptElements(config.researcher(), bookRequest)
                .withToolGroup(CoreToolGroups.WEB)
                .createObject(
                        """
                                Research the topic to gather the most important information that will
                                be useful in creating a book outline. Ensure you focus on high-quality, reliable sources,
                                and create a set of key points and important information that can be used to create a book outline.
                                """,
                        ResearchReport.class);
    }

    @Action
    BookOutline createOutline(
            BookRequest bookRequest,
            ResearchReport researchReport,
            OperationContext context) {
        return context.ai()
                .withLlm(config.writerLlm())
                .withPromptElements(config.outliner(), bookRequest, researchReport)
                .withToolGroup(CoreToolGroups.WEB)
                .createObject(
                        """
                                Create a book outline as requested with chapters in sequential order based on the given research findings.
                                Ensure that each chapter has a title and a brief description that highlights the topics and subtopics to be covered.
                                Ensure that you do not duplicate any chapters or topics in the outline.
                                """,
                        BookOutline.class);
    }

    @Action
    Book writeBook(
            BookRequest bookRequest,
            BookOutline bookOutline,
            ResearchReport researchReport,
            OperationContext context
    ) {
        var chapters = context.parallelMap(
                bookOutline.chapterOutlines(),
                config.maxConcurrency(),
                chapterOutline -> writeChapter(
                        bookRequest,
                        bookOutline,
                        chapterOutline,
                        context
                )
        );
        return new Book(bookRequest, bookOutline.title(), chapters);
    }

    @AchievesGoal(
            description = "Book has been written and published about the requested topic",
            export = @Export(remote = true)
    )
    @Action
    Book publishBook(Book book) {
        var path = config.saveContent(book);
        logger.info("Book {} written and saved to {}", book.title(), path);
        return book;
    }

    private Chapter writeChapter(
            BookRequest bookRequest,
            BookOutline bookOutline,
            ChapterOutline chapterOutline,
            OperationContext context) {
        logger.info("Researching chapter {}...", chapterOutline.title());
        var specificResearch = context.ai()
                .withLlm(config.researcherLlm())
                .withPromptElements(config.researcher(), bookRequest, bookOutline)
                .withToolGroup(CoreToolGroups.WEB)
                .createObject(
                        """
                                Research the topic of the chapter titled "%s" for the given book outline.
                                Consider the following chapter outline:
                                %s
                                
                                Ensure that you focus on high-quality, reliable sources,
                                and create a set of key points and important information
                                that can be used to write the chapter.
                                """.formatted(chapterOutline.title(), chapterOutline.content()),
                        ResearchReport.class);
        logger.info("Writing chapter {}...", chapterOutline.title());
        return context.ai()
                .withLlm(config.writerLlm())
                .withPromptElements(bookRequest, config.writer(), bookOutline, specificResearch)
                .createObject(
                        """
                                Write a well-structured chapter for the book based on the provided chapter title, goal, and outline.
                                The chapter should be written in markdown format.
                                Chapter title: %s
                                Chapter outline: %s
                                """.formatted(chapterOutline.title(), chapterOutline.content()
                        ),
                        Chapter.class
                );
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/factchecker/FactChecker.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.factchecker;

import com.embabel.agent.api.annotation.AchievesGoal;
import com.embabel.agent.api.annotation.Action;
import com.embabel.agent.api.annotation.Agent;
import com.embabel.agent.api.annotation.Export;
import com.embabel.agent.api.common.ActionContext;
import com.embabel.agent.api.common.OperationContext;
import com.embabel.agent.api.common.TransformationActionContext;
import com.embabel.agent.api.common.workflow.control.ResultList;
import com.embabel.agent.api.common.workflow.control.ScatterGatherBuilder;
import com.embabel.agent.api.common.workflow.multimodel.ConsensusBuilder;
import com.embabel.agent.core.CoreToolGroups;
import com.embabel.agent.domain.io.UserInput;
import com.embabel.agent.domain.library.InternetResource;
import com.embabel.common.ai.model.LlmOptions;
import com.embabel.common.ai.prompt.PromptContributor;
import com.fasterxml.jackson.annotation.JsonPropertyDescription;
import com.google.common.base.Supplier;
import org.slf4j.LoggerFactory;
import org.springframework.boot.context.properties.ConfigurationProperties;

import java.util.List;
import java.util.Map;
import java.util.stream.Stream;

/**
 * Non-overlapping factual assertions extracted from content.
 *
 * @param assertions
 */
record DistinctFactualAssertions(List<String> assertions) {
}

/**
 * Fact check of a single assertion.
 */
record FactCheck(
        String assertion,
        boolean isTrue,
        @JsonPropertyDescription("confidence in your judgment as to whether the assertion true or false. From 0-1")
        double confidence,
        @JsonPropertyDescription("reasoning for your scoring")
        String reasoning,
        @JsonPropertyDescription("Source of the fact checks, typically a LLM model")
        String source,
        List<InternetResource> links
) {
}

record FactChecks(
        List<FactCheck> checks
) {
}


@ConfigurationProperties("embabel.fact-checker")
record FactCheckerProperties(
        int reasoningWordCount,
        List<String> trustedSources,
        List<String> untrustedSources,
        List<String> models,
        String deduplicationModel,
        int maxConcurrency
) {

    LlmOptions deduplicationLlm() {
        return LlmOptions.withModel(deduplicationModel);
    }

    /**
     * Allows consistent exposure of relevant properties in prompts
     */
    PromptContributor promptContributor() {
        return PromptContributor.fixed(
                """
                        Be guided by the following regarding sources:
                        - Trusted sources: %s
                        - Untrusted sources: %s
                        """.formatted(
                        String.join(", ", trustedSources),
                        String.join(", ", untrustedSources)
                )
        );
    }

}

@Agent(description = "Fact checker agent")
class FactChecker {

    private final FactCheckerProperties properties;

    public FactChecker(FactCheckerProperties properties) {
        this.properties = properties;
        LoggerFactory.getLogger(FactChecker.class).info("FactChecker initialized with properties: {}", properties);
    }

    @Action
    DistinctFactualAssertions identifyDistinctFactualAssertions(
            UserInput userInput,
            ActionContext actionContext) {
        return ConsensusBuilder
                .returning(DistinctFactualAssertions.class)
                .sourcedFrom(factualAssertionExtractors(userInput, actionContext).toList())
                .withConsensusBy(this::consolidateFactualAssertions)
                .asSubProcess(actionContext);
    }


    @AchievesGoal(description = "Content has been fact-checked",
            export = @Export(remote = true, startingInputTypes = {UserInput.class}))
    @Action
    FactChecks runAndConsolidateFactChecks(
            DistinctFactualAssertions distinctFactualAssertions,
            ActionContext context) {
        var llmFactChecks = properties.models().stream()
                .flatMap(model -> factCheckWithSingleLlm(model, distinctFactualAssertions, context))
                .toList();
        return ScatterGatherBuilder
                .returning(FactChecks.class)
                .fromElements(FactCheck.class)
                .generatedBy(llmFactChecks)
                .consolidatedBy(this::reconcileFactChecks)
                .asSubProcess(context);
    }

    /**
     * Fact-check the distinct factual assertions using a given LLM
     */
    private Stream<Supplier<FactCheck>> factCheckWithSingleLlm(
            String model,
            DistinctFactualAssertions distinctFactualAssertions,
            OperationContext context) {
        return context.parallelMap(distinctFactualAssertions.assertions(), properties.maxConcurrency(), assertion ->
                        context.ai()
                                .withLlm(model)
                                .withPromptContributor(properties.promptContributor())
                                .withTools(CoreToolGroups.WEB)
                                .createObject(
                                        """
                                                Given the following assertion, check if it is true or false and explain why in %d words
                                                Express your confidence in your determination as a number between 0 and 1.
                                                Use web tools so you can cite information to support your conclusion.
                                                Use '%s' for the source field.
                                                
                                                ASSERTION TO CHECK:
                                                %s
                                                """.formatted(
                                                properties.reasoningWordCount(),
                                                model,
                                                assertion
                                        ),
                                        FactCheck.class
                                )).stream()
                .map(check -> () -> check);
    }

    private Stream<Supplier<DistinctFactualAssertions>> factualAssertionExtractors(UserInput userInput, ActionContext actionContext) {
        return properties.models().stream()
                .map(model -> () -> extractFactualAssertionsWithModel(userInput, actionContext, model));
    }

    /**
     * Generate distinct factual assertions from the user input using the given LLM
     */
    private DistinctFactualAssertions extractFactualAssertionsWithModel(UserInput userInput, ActionContext context, String model) {
        return context.ai()
                .withLlm(model)
                .createObject(
                        """
                                Extract distinct factual assertions from the following text.
                                The assertions may be incorrect; it is your job to identify them,
                                not to fact-check them.
                                
                                The assertions may overlap, so you should
                                return a list of distinct factual assertions, each expressed it at most %d words.
                                
                                If the input directs you to fact check, ignore that (that's not a fact you need worry about!)
                                and focus on extracting factual assertions.
                                
                                TEXT TO ANALYZE FOLLOWS:
                                %s
                                """
                                .formatted(
                                        properties.reasoningWordCount(),
                                        userInput.getContent()),
                        DistinctFactualAssertions.class
                );
    }

    private DistinctFactualAssertions consolidateFactualAssertions(
            TransformationActionContext<ResultList<DistinctFactualAssertions>, DistinctFactualAssertions> context) {
        var allAssertions = context.getInput().getResults().stream()
                .flatMap(result -> result.assertions().stream())
                .distinct()
                .toList();
        return context.ai()
                .withLlm(properties.deduplicationLlm())
                // Jinjava template from classpath at prompts/factchecker/consolidate_assertions.jinja
                .withTemplate("factchecker/consolidate_assertions")
                .createObject(
                        DistinctFactualAssertions.class,
                        Map.of(
                                "assertions", allAssertions,
                                "reasoningWordCount", properties.reasoningWordCount()
                        )
                );
    }

    /**
     * Use the best LLM to reconcile the fact checks into a single list.
     */
    private FactChecks reconcileFactChecks(
            TransformationActionContext<ResultList<FactCheck>, FactChecks> context) {
        var formattedFactChecks = new StringBuilder();
        for (var factCheck : context.getInput().getResults()) {
            formattedFactChecks.append("Source: ").append(factCheck.source()).append("\n");
            formattedFactChecks.append("- ").append(
                            String.format("%s (%B with confidence %.2f from source '%s')\nReasoning: %s\nLinks:\n%s",
                                    factCheck.assertion(), factCheck.isTrue(),
                                    factCheck.confidence(), factCheck.source(),
                                    factCheck.reasoning(), factCheck.links()))
                    .append("\n\n");
        }
        return context.ai()
                .withLlm(properties.deduplicationLlm())
                .withTools(CoreToolGroups.WEB)
                .withPromptContributor(properties.promptContributor())
                .createObject(
                        """
                                Your task is to reconcile different fact checks into a single list.
                                You must decide on the quality of each check and merge useful results.
                                Your determination should be expressed in at most %d words.
                                
                                Your confidence should reflect the mix of confidence levels in the checks.
                                If the checks disagree,you may perform your own research with the given tools.
                                Do NOT do this if the checks are consistent and all with high confidence.
                                
                                For each assertion, you should return a consolidated set of links, excluding only
                                those that are duplicates or from untrusted sources.
                                
                                All checks:
                                %s
                                """
                                .formatted(properties.reasoningWordCount(), formattedFactChecks),
                        FactChecks.class
                );
    }

}


================================================
FILE: examples-java/src/main/java/com/embabel/example/handoff/Handoff.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.handoff;

import com.embabel.agent.api.annotation.*;
import com.embabel.agent.api.common.OperationContext;
import com.embabel.agent.domain.io.UserInput;
import com.embabel.example.horoscope.StarPerson;
import com.embabel.example.horoscope.Writeup;

record Choice(String choice) {
}

record AdventureLog(String log) {
}

@Agent(description = "Choose your own adventure handoff agent")
public class Handoff {

    /**
     * This action is get user input out of the way in selecting the adventure by handoff
     */
    @Action
    Choice makeChoice(UserInput userInput, OperationContext operationContext) {
        return WaitFor.formSubmission("Please choose your own adventure", Choice.class);
    }

    @Action
    @AchievesGoal(description = "Choose your own adventure",
            export = @Export(name = "chooseAdventure", remote = true, startingInputTypes = {UserInput.class}))
    AdventureLog chooseAdventure(Choice choice, OperationContext operationContext) {
        return operationContext.ai()
                .withAutoLlm()
                .withHandoffs(StarPerson.class, Writeup.class)
                .createObject("""
                        Based on the user's input, decide what to do. You might do something related to a horoscope or some fact checking.
                        What they said: %s
                        """.formatted(choice.choice()), AdventureLog.class);
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/handoff/Subagents.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.handoff;

import com.embabel.agent.api.annotation.AchievesGoal;
import com.embabel.agent.api.annotation.Action;
import com.embabel.agent.api.annotation.Agent;
import com.embabel.agent.api.annotation.WaitFor;
import com.embabel.agent.api.common.OperationContext;
import com.embabel.agent.api.common.Subagent;
import com.embabel.agent.domain.io.UserInput;
import com.embabel.common.ai.model.LlmOptions;
import com.embabel.example.horoscope.StarNewsFinder;
import com.embabel.example.horoscope.StarPerson;

import java.util.List;

record TargetPerson(String name, String sign) {
}

record InterestingFacts(List<String> facts) {
}

/**
 * Works with subagents to find interesting facts about a person based on their star sign.
 */
@Agent(description = "Find interesting things for this person")
class Subagents {

    @Action
    TargetPerson acquireTarget() {
        return WaitFor.formSubmission("Please enter the name and star sign of a person",
                TargetPerson.class);
    }

    @AchievesGoal(description = "Find interesting facts about a person")
    @Action
    InterestingFacts findInterestingFacts(TargetPerson person, OperationContext operationContext) {
        return operationContext.promptRunner()
                .withLlm(LlmOptions.withAutoLlm())
                .withSubagents(
                        new Subagent(StarNewsFinder.class, StarPerson.class),
                        new Subagent("GoatWriter", UserInput.class))
                .createObject("""
                                The person has a strong interest in astrology and goats.
                                Find 5 facts that will interest them, and return them as a list.
                                Each fact should be a limerick.
                                
                                Person: %s with star sign %s
                                """.formatted(person.name(), person.sign()),
                        InterestingFacts.class);
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/horoscope/Horoscope.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope;

public record Horoscope(String summary) {
}


================================================
FILE: examples-java/src/main/java/com/embabel/example/horoscope/StarNewsFinder.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope;

import com.embabel.agent.api.annotation.*;
import com.embabel.agent.api.common.Ai;
import com.embabel.agent.api.models.AnthropicModels;
import com.embabel.agent.api.models.OpenAiModels;
import com.embabel.agent.core.CoreToolGroups;
import com.embabel.agent.domain.io.UserInput;
import com.embabel.agent.domain.library.Person;
import com.embabel.agent.domain.library.PersonImpl;
import com.embabel.agent.domain.library.RelevantNewsStories;
import com.embabel.common.ai.model.LlmOptions;
import org.springframework.beans.factory.annotation.Value;

import java.util.stream.Collectors;


/**
 * Find news based on a person's star sign
 */
@Agent(
        name = "JavaStarNewsFinder",
        description = "Find news based on a person's star sign",
        beanName = "javaStarNewsFinder")
public class StarNewsFinder {

    private final HoroscopeService horoscopeService;
    private final int storyCount;

    public StarNewsFinder(
            HoroscopeService horoscopeService,
            @Value("${star-news-finder.story.count:5}") int storyCount) {
        this.horoscopeService = horoscopeService;
        this.storyCount = storyCount;
    }

    @Action
    public Person extractPerson(UserInput userInput, Ai ai) {
        return ai
                .withLlm(OpenAiModels.GPT_41)
                .createObjectIfPossible(
                        """
                                Create a person from this user input, extracting their name:
                                %s""".formatted(userInput.getContent()),
                        PersonImpl.class
                );
    }

    @Action(cost = 100.0) // Make it costly so it won't be used in a plan unless there's no other path
    public Starry makeStarry(Person person) {
        return WaitFor.formSubmission("Let's get some astrological details for " + person.getName(),
                Starry.class);
    }

    @Action
    public StarPerson assembleStarPerson(Person person, Starry starry) {
        return new StarPerson(
                person.getName(),
                starry.sign()
        );
    }

    @Action
    public StarPerson extractStarPerson(UserInput userInput, Ai ai) {
        return ai
                .withLlmByRole("best")
                .createObjectIfPossible(
                        """
                                Create a person from this user input, extracting their name and star sign:
                                %s""".formatted(userInput.getContent()),
                        StarPerson.class
                );
    }

    @Action
    public Horoscope retrieveHoroscope(StarPerson starPerson) {
        return new Horoscope(horoscopeService.dailyHoroscope(starPerson.sign()));
    }

    // toolGroups specifies tools that are required for this action to run
    @Action(toolGroups = {CoreToolGroups.WEB})
    public RelevantNewsStories findNewsStories(
            StarPerson person,
            Horoscope horoscope,
            Ai ai) {
        var prompt = """
                %s is an astrology believer with the sign %s.
                Their horoscope for today is:
                    <horoscope>%s</horoscope>
                Given this, use web tools and generate search queries
                to find %d relevant news stories summarize them in a few sentences.
                Include the URL for each story.
                Do not look for another horoscope reading or return results directly about astrology;
                find stories relevant to the reading above.
                
                For example:
                - If the horoscope says that they may
                want to work on relationships, you could find news stories about
                novel gifts
                - If the horoscope says that they may want to work on their career,
                find news stories about training courses.""".formatted(
                person.name(), person.sign(), horoscope.summary(), storyCount);

        return ai
                .withDefaultLlm().
                createObject(prompt, RelevantNewsStories.class);
    }

    // The @AchievesGoal annotation indicates that completing this action
    // achieves the given goal, so the agent can be complete
    @AchievesGoal(
            description = "Write an amusing writeup for the target person based on their horoscope and current news stories",
            export = @Export(
                    remote = true,
                    name = "starNewsWriteupJava",
                    startingInputTypes = {StarPerson.class, UserInput.class})
    )
    @Action
    public Writeup writeup(
            StarPerson person,
            RelevantNewsStories relevantNewsStories,
            Horoscope horoscope,
            Ai ai) {
        var newsItems = relevantNewsStories.getItems().stream()
                .map(item -> "- " + item.getUrl() + ": " + item.getSummary())
                .collect(Collectors.joining("\n"));

        var prompt = """
                Take the following news stories and write up something
                amusing for the target person.
                
                Begin by summarizing their horoscope in a concise, amusing way, then
                talk about the news. End with a surprising signoff.
                
                %s is an astrology believer with the sign %s.
                Their horoscope for today is:
                    <horoscope>%s</horoscope>
                Relevant news stories are:
                %s
                
                Format it as Markdown with links.""".formatted(
                person.name(), person.sign(), horoscope.summary(), newsItems);
        return ai
                .withLlm(LlmOptions
                        .withFirstAvailableLlmOf(AnthropicModels.CLAUDE_37_SONNET, OpenAiModels.GPT_41_MINI)
                        .withTemperature(0.9))
                .createObject(prompt, Writeup.class);
    }
}


================================================
FILE: examples-java/src/main/java/com/embabel/example/horoscope/StarPerson.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope;

import com.embabel.agent.domain.library.Person;
import com.fasterxml.jackson.annotation.JsonClassDescription;
import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.annotation.JsonPropertyDescription;
import com.fasterxml.jackson.databind.annotation.JsonDeserialize;

@JsonClassDescription("Person with astrology details")
@JsonDeserialize(as = StarPerson.class)
public record StarPerson(
        String name,
        @JsonPropertyDescription("Star sign") String sign
) implements Person {

    @JsonCreator
    public StarPerson(
            @JsonProperty("name") String name,
            @JsonProperty("sign") String sign
    ) {
        this.name = name;
        this.sign = sign;
    }

    @Override
    public String getName() {
        return name;
    }
}


================================================
FILE: examples-java/src/main/java/com/embabel/example/horoscope/Starry.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope;

import com.embabel.ux.form.Text;
import com.fasterxml.jackson.annotation.JsonClassDescription;

@JsonClassDescription("Astrological details for a person")
public record Starry(@Text(label = "Star sign") String sign) {
}


================================================
FILE: examples-java/src/main/java/com/embabel/example/horoscope/Writeup.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope;

import com.embabel.agent.domain.library.HasContent;
import com.fasterxml.jackson.annotation.JsonClassDescription;
import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.annotation.JsonProperty;

@JsonClassDescription("Writeup relating to a person's horoscope and relevant news")
public record Writeup(String text) implements HasContent {

    @JsonCreator
    public Writeup(@JsonProperty("text") String text) {
        this.text = text;
    }

    @Override
    public String getContent() {
        return text;
    }
}


================================================
FILE: examples-java/src/main/java/com/embabel/example/injection/InjectedComponent.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection;

import com.embabel.agent.api.common.Ai;
import com.embabel.common.ai.model.LlmOptions;
import org.springframework.stereotype.Component;


/**
 * Demonstrate the simplest use of Embabel's AI capabilities,
 * injecting an AI helper into a Spring component.
 * The jokes will be terrible, but don't blame Embabel, blame the LLM.
 *
 * @param ai the AI helper injected by Embabel
 */
@Component
public record InjectedComponent(Ai ai) {

    public record Joke(String leadup, String punchline) {
    }

    public String tellJokeAbout(String topic) {
        return ai
                .withDefaultLlm()
                .generateText("Tell me a joke about " + topic);
    }

    public Joke createJokeObjectAbout(String topic1, String topic2, String voice) {
        return ai
                .withLlm(LlmOptions.withDefaultLlm().withTemperature(.8))
                .createObject("""
                                Tell me a joke about %s and %s.
                                The voice of the joke should be %s.
                                The joke should have a leadup and a punchline.
                                """.formatted(topic1, topic2, voice),
                        Joke.class);
    }

}



================================================
FILE: examples-java/src/main/java/com/embabel/example/injection/JokeShellCommands.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection;

import com.embabel.example.injection.travel.ActivitySummarizer;
import org.springframework.shell.standard.ShellComponent;
import org.springframework.shell.standard.ShellMethod;
import org.springframework.shell.standard.ShellOption;

@ShellComponent
public record JokeShellCommands(
        InjectedComponent injectedComponent,
        ActivitySummarizer activitySummarizer
) {

    @ShellMethod("Tell a joke")
    public String stringJoke(
            @ShellOption(value = "topic", help = "topic of the joke", defaultValue = "galahs") String topic
    ) {
        return injectedComponent.tellJokeAbout(topic);
    }

    @ShellMethod("Create a joke object")
    public String objectJoke(
            @ShellOption(value = "topic1", help = "first topic", defaultValue = "dogs") String topic1,
            @ShellOption(value = "topic2", help = "second topic", defaultValue = "cats") String topic2,
            @ShellOption(value = "voice", help = "voice of the joke", defaultValue = "Shakespearean") String voice

    ) {
        var joke = injectedComponent.createJokeObjectAbout(topic1, topic2, voice);
        return joke.toString();
    }

    @ShellMethod("Analyze travel report")
    public String travelReport(
    ) {
        var summary = activitySummarizer.summarizeActivity(1L);
        if (summary == null) {
            return "No customer found";
        }
        return summary.toString();
    }


}




================================================
FILE: examples-java/src/main/java/com/embabel/example/injection/travel/ActivitySummarizer.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection.travel;

import com.embabel.agent.api.common.Ai;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.context.properties.bind.DefaultValue;
import org.springframework.lang.Nullable;
import org.springframework.stereotype.Service;

/**
 * Implemented by services that can report travel activity.
 * A real implementation would be backed by a database or other software system
 */
interface TravelActivityReportingService {

    /**
     * Given a customer id, return their travel activity
     */
    @Nullable
    TravellerActivity report(Long customerId);
}

/**
 * Spring service that uses Embabel AI to summarize customer activity.
 */
@Service
public record ActivitySummarizer(
        TravelActivityReportingService travelActivityReportingService,
        Ai ai,
        Config config) {

    @ConfigurationProperties(prefix = "example.activity-summarizer")
    public record Config(
            @DefaultValue("80") int maxWords,
            @DefaultValue("2000.0") float highSpenderThreshold,
            @DefaultValue("10") float highTripsPerYearThreshold
    ) {
    }

    @Nullable
    public TravelerActivityReport summarizeActivity(Long customerId) {
        // This may well be transactional, so we don't keep the
        // transaction open while we call the LLM.
        // The tools we pass to the LLM will be fast as they
        // act on data in memory
        var activity = travelActivityReportingService.report(customerId);
        if (activity == null) {
            return null;
        }
        // We can rely on the record's generated toString in this
        // case to expose the right data, as it will include all fields
        var report = ai
                .withDefaultLlm()
                .withToolObject(activity)
                .generateText("""
                        Your job is to help staff of Antechinus Travel understand their customers.
                        You will be given a report of customer activity over a period of time.
                        Summarize the activity in a way that draws our staff member's
                        attention to important details and also includes the customer's name.
                        Use no more than %s words.
                        We consider customers that spend more than %f to be high spenders.
                        Customers that take more than %f trips per year are frequent travelers.
                        If the customer is a high spender, include a note about this in the summary.
                        
                        # CUSTOMER ACTIVITY
                        %s
                        """.formatted(config.maxWords, config.highSpenderThreshold, config.highTripsPerYearThreshold(),
                        activity));
        return new TravelerActivityReport(report, activity);
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/injection/travel/DummyTravelActivityReportingService.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection.travel;

import org.springframework.stereotype.Service;

import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;

/**
 * Dummy ReportService implementation that generates realistic travel records
 * A real implementation would probably be transactional.
 * This can be accomplished with the Spring @Transactional annotation on the class or method.
 */
@Service
public class DummyTravelActivityReportingService implements TravelActivityReportingService {

    private static final Random random = new Random();

    private static final String[] TRAVELER_NAMES = {
            "James Mitchell",
            "Sarah Thompson",
            "Wei Chen",
            "Emma van der Berg",
            "Rajesh Patel",
            "Claire Dubois"
    };

    // Major cities in Australia, Canada, France, Netherlands, and UK
    private static final String[] AUSTRALIAN_CITIES = {
            "Sydney", "Melbourne", "Brisbane", "Perth", "Adelaide", "Darwin", "Canberra"
    };

    private static final String[] CANADIAN_CITIES = {
            "Toronto", "Vancouver", "Montreal", "Calgary", "Ottawa", "Edmonton", "Winnipeg", "Halifax"
    };

    private static final String[] FRENCH_CITIES = {
            "Paris", "Lyon", "Marseille", "Nice", "Toulouse", "Strasbourg", "Bordeaux", "Lille"
    };

    private static final String[] DUTCH_CITIES = {
            "Amsterdam", "Rotterdam", "The Hague", "Utrecht", "Eindhoven", "Groningen", "Tilburg"
    };

    private static final String[] UK_CITIES = {
            "London", "Manchester", "Birmingham", "Edinburgh", "Glasgow", "Liverpool", "Bristol", "Leeds"
    };

    private static final String[][] ALL_CITIES = {
            AUSTRALIAN_CITIES, CANADIAN_CITIES, FRENCH_CITIES, DUTCH_CITIES, UK_CITIES
    };

    private static final String[] COUNTRY_NAMES = {
            "Australia", "Canada", "France", "Netherlands", "UK"
    };

    public static TravellerActivity generateRealisticRecord() {
        String name = TRAVELER_NAMES[random.nextInt(TRAVELER_NAMES.length)];

        // Generate time period (last 6 months for more realistic travel frequency)
        Instant to = Instant.now();
        Instant from = to.minus(180, ChronoUnit.DAYS);

        // Generate 1-4 realistic trips (most people don't travel constantly)
        int numTrips = 1 + random.nextInt(4);
        List<Trip> trips = new ArrayList<>();

        Instant currentTime = from;
        for (int i = 0; i < numTrips; i++) {
            Trip trip = generateRealisticTrip(currentTime, to);
            trips.add(trip);
            // Space trips out realistically (at least 2 weeks between trips)
            currentTime = trip.arrival().plus(14 + random.nextInt(30), ChronoUnit.DAYS);
        }

        return new TravellerActivity(name, from, to, trips);
    }

    private static Trip generateRealisticTrip(Instant earliestStart, Instant latestEnd) {
        // Select random countries for origin and destination
        int fromCountryIndex = random.nextInt(ALL_CITIES.length);
        int toCountryIndex = random.nextInt(ALL_CITIES.length);

        String fromCity = ALL_CITIES[fromCountryIndex][random.nextInt(ALL_CITIES[fromCountryIndex].length)];
        String toCity = ALL_CITIES[toCountryIndex][random.nextInt(ALL_CITIES[toCountryIndex].length)];

        // Avoid same city travel
        while (fromCity.equals(toCity)) {
            toCountryIndex = random.nextInt(ALL_CITIES.length);
            toCity = ALL_CITIES[toCountryIndex][random.nextInt(ALL_CITIES[toCountryIndex].length)];
        }

        // Generate departure time within allowed range, leaving room for trip duration
        long maxSeconds = latestEnd.getEpochSecond() - earliestStart.getEpochSecond();
        long maxDepartureOffset = maxSeconds - (7 * 24 * 3600); // Leave room for max 7-day trip
        if (maxDepartureOffset <= 0) maxDepartureOffset = maxSeconds / 2;

        long departureOffset = Math.abs(random.nextLong() % maxDepartureOffset);
        Instant departure = earliestStart.plusSeconds(departureOffset);

        // Realistic trip duration based on travel type
        int tripDurationHours;
        boolean isDomestic = fromCountryIndex == toCountryIndex;

        if (isDomestic) {
            // Domestic trips: 1-4 days
            tripDurationHours = (1 + random.nextInt(4)) * 24;
        } else {
            // International trips: 3-10 days
            tripDurationHours = (3 + random.nextInt(8)) * 24;
        }

        Instant arrival = departure.plus(tripDurationHours, ChronoUnit.HOURS);

        // Ensure arrival doesn't exceed the latest end time
        if (arrival.isAfter(latestEnd)) {
            arrival = latestEnd.minus(1, ChronoUnit.HOURS);
        }

        // Generate realistic pricing
        float amount = generateRealisticPrice(fromCountryIndex, toCountryIndex, tripDurationHours / 24);

        return new Trip(fromCity, toCity, departure, arrival, amount);
    }

    private static float generateRealisticPrice(int fromCountryIndex, int toCountryIndex, int durationDays) {
        boolean isDomestic = fromCountryIndex == toCountryIndex;

        if (isDomestic) {
            // Domestic travel pricing
            float basePrice = 150f + random.nextFloat() * 400f; // $150-550 base
            return basePrice + (durationDays * (50f + random.nextFloat() * 100f)); // Add daily costs
        } else {
            // International travel pricing
            float baseFlight = 500f + random.nextFloat() * 1500f; // $500-2000 flight
            float dailyCost = 100f + random.nextFloat() * 200f; // $100-300 per day

            // Distance-based adjustments
            if (isLongHaulFlight(fromCountryIndex, toCountryIndex)) {
                baseFlight += 300f + random.nextFloat() * 700f; // Long-haul premium
            }

            return baseFlight + (durationDays * dailyCost);
        }
    }

    private static boolean isLongHaulFlight(int from, int to) {
        // Australia to anywhere else, or trans-Atlantic/trans-Pacific routes
        return (from == 0 || to == 0) || // Australia involved
                (from == 1 && (to == 2 || to == 3 || to == 4)) || // Canada to Europe
                (to == 1 && (from == 2 || from == 3 || from == 4)); // Europe to Canada
    }

    // Generate all 6 travelers
    public static List<TravellerActivity> generateAllTravelers() {
        List<TravellerActivity> allTravelers = new ArrayList<>();

        for (String travelerName : TRAVELER_NAMES) {
            // Generate time period (last 6 months)
            Instant to = Instant.now();
            Instant from = to.minus(180, ChronoUnit.DAYS);

            // Generate 1-4 realistic trips per traveler
            int numTrips = 1 + random.nextInt(4);
            List<Trip> trips = new ArrayList<>();

            Instant currentTime = from;
            for (int i = 0; i < numTrips && currentTime.isBefore(to.minus(7, ChronoUnit.DAYS)); i++) {
                Trip trip = generateRealisticTrip(currentTime, to);
                trips.add(trip);
                // Space trips out realistically
                currentTime = trip.arrival().plus(14 + random.nextInt(30), ChronoUnit.DAYS);
            }

            allTravelers.add(new TravellerActivity(travelerName, from, to, trips));
        }

        return allTravelers;
    }

    @Override
    public TravellerActivity report(Long customerId) {
        // In a real implementation, you'd use customerId to get specific customer
        // For demo purposes, cycle through the 6 travelers based on ID
        if (customerId == null) {
            return generateRealisticRecord();
        }

        List<TravellerActivity> allTravelers = generateAllTravelers();
        int index = (int) (customerId % 6);
        return allTravelers.get(index);
    }
}


================================================
FILE: examples-java/src/main/java/com/embabel/example/injection/travel/TravelerActivityReport.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection.travel;

public record TravelerActivityReport(
        String summary,
        TravellerActivity activity
) {
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/injection/travel/TravellerActivity.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection.travel;

import org.springframework.ai.tool.annotation.Tool;

import java.time.Duration;
import java.time.Instant;
import java.util.List;

/**
 * Record of customer activity over a period of time.
 * We add methods exposed to be exposed the LLM as tools.
 *
 * @param from
 * @param to
 * @param trips
 */
public record TravellerActivity(
        String name,
        Instant from,
        Instant to,
        List<Trip> trips
) {

    @Tool
    public float totalSpend() {
        return trips.stream().map(Trip::amount).reduce(0f, Float::sum);
    }

    @Tool
    public float averageSpend() {
        return trips.isEmpty() ?
                0f :
                totalSpend() / trips.size();
    }

    @Tool(description = "Get the number of trips taken in the period")
    public int tripCount() {
        return trips.size();
    }

    @Tool(description = "Get the number of days in the period")
    public long periodDays() {
        return Duration.between(from, to).toDays();
    }

    @Tool(description = "Get the distinct destinations visited in the period")
    public List<String> destinations() {
        return trips.stream().map(Trip::to).distinct().toList();
    }

    /**
     * At this rate, how many trips would be taken in a year?
     */
    @Tool(description = "Trips per year")
    public float tripsPerYear() {
        long days = periodDays();
        return days == 0 ?
                trips.size()
                : (trips.size() * 365f) / days;
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/injection/travel/Trip.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection.travel;

import java.time.Instant;

public record Trip(
        String from,
        String to,
        Instant departure,
        Instant arrival,
        float amount
) {
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/pydantic/README.md
================================================
# Agents based on Pydantic AI samples


================================================
FILE: examples-java/src/main/java/com/embabel/example/pydantic/banksupport/README.md
================================================
# Pydantic Bank Support Example

See https://ai.pydantic.dev/examples/bank-support/#running-the-example

Our version demonstrates:

- Integration with Spring Data for production-quality data access
- A true domain model with LLM tools on domain objects.

Run within Spring Shell with:

```bash
bank-support --id 123 --query "What's my balance?"

bank-support --id 123 --query "What's my balance, including pending amounts. Also, I have lost my card. Can you help?"
```




================================================
FILE: examples-java/src/main/java/com/embabel/example/pydantic/banksupport/InMemoryCustomerRepository.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.pydantic.banksupport;

import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
class InMemoryCustomerRepository implements CustomerRepository {

    private final List<Customer> customers = new ArrayList<>();

    {
        // Pre-populate with customer
        customers.add(new Customer(123L, "John", 100.0f, 27.0f));
    }

    @Override
    public Customer findById(Long id) {
        return customers.stream()
                .filter(customer -> customer.id().equals(id))
                .findFirst()
                .orElse(null);
    }


}



================================================
FILE: examples-java/src/main/java/com/embabel/example/pydantic/banksupport/SupportAgent.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.pydantic.banksupport;


import com.embabel.agent.api.annotation.AchievesGoal;
import com.embabel.agent.api.annotation.Action;
import com.embabel.agent.api.annotation.Agent;
import com.embabel.agent.api.common.OperationContext;
import com.embabel.agent.api.models.OpenAiModels;
import com.fasterxml.jackson.annotation.JsonPropertyDescription;
import org.springframework.ai.tool.annotation.Tool;
import org.springframework.data.repository.Repository;
import org.springframework.lang.Nullable;

record Customer(Long id, String name, float balance, float pendingAmount) {

    @Tool(description = "Find the balance of a customer by id")
    float balance(boolean includePending) {
        return includePending ? balance + pendingAmount : balance;
    }
}

interface CustomerRepository extends Repository<Customer, Long> {

    @Nullable
    Customer findById(Long id);
}

record SupportInput(
        @JsonPropertyDescription("Customer ID") Long customerId,
        @JsonPropertyDescription("Query from the customer") String query) {
}

record SupportOutput(
        @JsonPropertyDescription("Advice returned to the customer") String advice,
        @JsonPropertyDescription("Whether to block their card or not") boolean blockCard,
        @JsonPropertyDescription("Risk level of query") int risk) {
}

@Agent(description = "Customer support agent")
record SupportAgent(CustomerRepository customerRepository) {

    @AchievesGoal(description = "Help bank customer with their query")
    @Action
    SupportOutput supportCustomer(SupportInput supportInput, OperationContext context) {
        var customer = customerRepository.findById(supportInput.customerId());
        if (customer == null) {
            return new SupportOutput("Customer not found with this id", false, 0);
        }
        return context.ai()
                .withLlm(OpenAiModels.GPT_41_MINI)
                .withToolObject(customer)
                .createObject(
                        """
                                You are a support agent in our bank, give the
                                customer support and judge the risk level of their query.
                                In some cases, you may need to block their card. In this case, explain why.
                                Reply using the customer's name, "%s".
                                Currencies are in $.
                                
                                Their query: [%s]
                                """.formatted(customer.name(), supportInput.query()),
                        SupportOutput.class);
    }

}



================================================
FILE: examples-java/src/main/java/com/embabel/example/pydantic/banksupport/SupportAgentShellCommands.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.pydantic.banksupport;

import com.embabel.agent.api.common.autonomy.AgentInvocation;
import com.embabel.agent.core.AgentPlatform;
import com.embabel.agent.core.ProcessOptions;
import org.springframework.shell.standard.ShellComponent;
import org.springframework.shell.standard.ShellMethod;
import org.springframework.shell.standard.ShellOption;

@ShellComponent
public record SupportAgentShellCommands(
        AgentPlatform agentPlatform
) {

    @ShellMethod("Get bank support for a customer query")
    public String bankSupport(
            @ShellOption(value = "id", help = "customer id", defaultValue = "123") Long id,
            @ShellOption(value = "query", help = "customer query", defaultValue = "What's my balance, including pending amounts?") String query
    ) {
        var supportInput = new SupportInput(id, query);
        System.out.println("Support input: " + supportInput);
        var invocation = AgentInvocation
                .builder(agentPlatform)
                .options(ProcessOptions.builder().verbosity(v -> v.showPrompts(true)).build())
                .build(SupportOutput.class);
        var result = invocation.invoke(supportInput);
        return result.toString();
    }


}



================================================
FILE: examples-java/src/main/java/com/embabel/example/repeatuntil/GoatWriterConfig.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.repeatuntil;

import com.embabel.agent.api.common.workflow.loop.RepeatUntilAcceptableBuilder;
import com.embabel.agent.api.common.workflow.loop.TextFeedback;
import com.embabel.agent.api.models.OpenAiModels;
import com.embabel.agent.core.Agent;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

record Goat(String description) {
}

/**
 * Show how a bean definition will be picked up as an agent.
 */
@Configuration
public class GoatWriterConfig {

    @Bean
    public Agent goatWriter() {
        return RepeatUntilAcceptableBuilder
                .returning(Goat.class)
                .withMaxIterations(3)
                .repeating(context -> {
                    var lastAttempt = context.lastAttempt();
                    var feedback = lastAttempt != null ? "Feedback: " + lastAttempt.getFeedback() : "";
                    return context.ai()
                            .withLlm(OpenAiModels.GPT_5_NANO)
                            .createObject(
                                    """
                                            Describe a goat in 200 words. Be creative.
                                            
                                            %s
                                            """.formatted(feedback),
                                    Goat.class);
                })
                .withEvaluator(context ->
                        context.ai().withDefaultLlm().createObject(
                                """
                                        Evaluate the goat description for creativity and detail.
                                        The goat must have a name.
                                        Description:
                                        %s
                                        
                                        Provide feedback of no more than 40 words on a scale from 0 to 1, where 1 is excellent and 0 is poor.
                                        """.formatted(context.getResultToEvaluate()),
                                TextFeedback.class))
                .buildAgent("GoatWriter",
                        "Write a description of a goat");
    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/repeatuntil/ReviseStoryUntilSatisfied.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.repeatuntil;

import com.embabel.agent.api.annotation.AchievesGoal;
import com.embabel.agent.api.annotation.Action;
import com.embabel.agent.api.annotation.Agent;
import com.embabel.agent.api.common.ActionContext;
import com.embabel.agent.api.common.workflow.loop.RepeatUntilAcceptableBuilder;
import com.embabel.agent.api.common.workflow.loop.TextFeedback;
import com.embabel.agent.api.models.OpenAiModels;
import com.embabel.agent.domain.io.UserInput;
import com.embabel.common.ai.model.LlmOptions;

record Story(String text) {
}

/**
 * Demonstrates a repeat-until agent that uses feedback
 */
@Agent(description = "Keep writing stories until the reviewer is satisfied")
class ReviseStoryUntilSatisfied {

    @AchievesGoal(description = "We have a story")
    @Action
    Story rewriteUntilSatisfied(
            UserInput userInput,
            ActionContext actionContext) {
        var writerPromptRunner = actionContext.ai()
                .withLlm(LlmOptions.withModel(OpenAiModels.GPT_41_MINI).withTemperature(.8));
        var reviewerPromptRunner = actionContext.ai()
                .withLlm(LlmOptions.withModel(OpenAiModels.GPT_41_MINI));
        return RepeatUntilAcceptableBuilder
                .returning(Story.class)
                .withMaxIterations(7)
                .withScoreThreshold(.8)
                .repeating(context -> {
                    var lastAttempt = context.lastAttempt();
                    var feedback = lastAttempt != null ? "Consider the following feedback: " + lastAttempt.getFeedback() : "";
                    return writerPromptRunner.createObject(
                            """
                                    Write a creative story inspired by the user input: %s
                                    
                                    %s
                                    """.formatted(userInput.getContent(), feedback),
                            Story.class
                    );
                })
                .withEvaluator(context ->
                        reviewerPromptRunner.createObject(
                                """
                                        Review and score the given story for creativity and relevance to the user input:
                                        Story:
                                        %s
                                        
                                        User input: %s
                                        """.formatted(
                                        context.getResultToEvaluate(),
                                        userInput.getContent()),
                                TextFeedback.class)
                )
                .build()
                .asSubProcess(actionContext, Story.class);

    }
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/wikipedia/ResearchSubject.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.wikipedia;

public record ResearchSubject(String name) {
}



================================================
FILE: examples-java/src/main/java/com/embabel/example/wikipedia/WikiAgent.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.wikipedia;

import com.embabel.agent.api.annotation.*;
import com.embabel.agent.api.common.OperationContext;
import com.embabel.agent.core.CoreToolGroups;
import com.embabel.common.ai.model.LlmOptions;
import org.springframework.beans.factory.annotation.Value;

import java.util.List;
import java.util.stream.Collectors;

record FocusAreas(List<FocusArea> focusAreas) {
}

record FocusArea(String topic) {
}

record ResearchReport(String subject, String summary) {
}

/**
 * Demonstrates an agent that interacts with the user
 */
@Agent(description = "Find information from wikipedia according to the user's request.")
public class WikiAgent {

    private final int wordCount;
    private final LlmOptions llm;

    public WikiAgent(
            @Value("${wiki.wordcount:200}") int wordCount,
            @Value("${wiki.llm:gpt-4.1-nano}") String model) {
        this.wordCount = wordCount;
        this.llm = LlmOptions.withModel(model);
    }

    @Action
    FocusAreas focusAreas(ResearchSubject researchSubject, OperationContext context) {
        return context.ai()
                .withLlm(llm.withTemperature(.6))
                .withToolGroup(CoreToolGroups.WEB)
                .createObject("""
                        What are some interesting topics to explore about %s?
                        Please provide a list of focus areas, each as a separate line.
                        Go beyond the obvious: emphasize quirky and lesser-known aspects.
                        Use Wikipedia as the source of information.
                        """.formatted(researchSubject.name()), FocusAreas.class);
    }

    @Action
    FocusArea findFocusArea(ResearchSubject researchSubject, FocusAreas focusAreas) {
        return WaitFor.formSubmission(
                """
                        Great, there are lots of interesting things to explore about %s.
                        Choices:
                            %s
                        Please select one of the topics above to focus on.
                        """.formatted(researchSubject.name(),
                        focusAreas.focusAreas().stream().map(FocusArea::topic)
                                .collect(Collectors.joining("\n"))),
                FocusArea.class);
    }

    @Action
    @AchievesGoal(description = "Find information from wikipedia according to the user's request.",
            export = @Export(remote = true, name = "wikiSearch", startingInputTypes = {ResearchSubject.class})
    )
    ResearchReport performResearch(ResearchSubject researchSubject, FocusArea focusArea, OperationContext context) {
        return context.ai()
                .withLlm(llm.withTemperature(.8))
                .withToolGroup(CoreToolGroups.WEB)
                .createObject("""
                                Research the following subject on Wikipedia, with the given focus area, and summarize it
                                in %d words:
                                Subject: %s
                                Focus Area: %s
                                """.formatted(wordCount, researchSubject.name(), focusArea.topic()),
                        ResearchReport.class);
    }
}



================================================
FILE: examples-java/src/main/resources/application-observability.yml
================================================
# Observability configuration for Spring AI with tracing and logging
# This is a concern of the application, not the library and will be removed in future versions
spring:
  ai:
    chat:
      client:
        observations:
          log-prompt: false             # Enable ChatClient prompt logging
      observations:
        log-prompt: false               # Enable ChatModel prompt logging
        log-completion: false           # Enable ChatModel response logging
        include-error-logging: true     # Include error details
# Observability and tracing configuration
management:
  tracing:
    enabled: true
    sampling:
      probability: 1.0                 # Sample 100% of traces (use 0.1 for production)

  # Zipkin configuration
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans



================================================
FILE: examples-java/src/main/resources/application.properties
================================================
spring.application.name=embabel-examples

embabel.models.default-llm=gpt-4.1-mini
embabel.models.llms.cheapest=gpt-4.1-nano

embabel.models.llms.best=gpt-5


embabel.agent.shell.chat.confirm-goals=false
embabel.agent.shell.chat.multi-goal=false
embabel.agent.shell.chat.bind-conversation=false
embabel.agent.shell.chat.model=gpt-4.1-mini
embabel.agent.shell.chat.temperature=0.3

embabel.agent-platform.ranking.llm=gpt-4.1-mini


embabel.fact-checker.models=gpt-4.1-mini,gpt-5-nano,gpt-5-mini
embabel.fact-checker.max-concurrency=8

# Use a good LLM for this
embabel.fact-checker.deduplication-model=gpt-4.1
embabel.fact-checker.reasoning-word-count=50
embabel.fact-checker.trusted-sources=Wikipedia,Wikidata,Britannica,BBC,Reuters,NY Times,ABC Australia
embabel.fact-checker.untrusted-sources=reddit,4chan,twitter




================================================
FILE: examples-java/src/main/resources/application.yml
================================================
examples:
  book-writer:

    max-concurrency: 8

    researcher-llm:
      model: gpt-4.1-nano
      temperature: 0.7

    writer-llm:
      model: gpt-4.1-mini


    researcher:
      role: Researcher
      goal: >
        Gather comprehensive information about a topic that will be used 
        to create an organized and well-structured book outline.
        Consider the author's desired goal for the book.

      backstory: >
        You are an experienced researcher skilled in finding the most relevant and up-to-date information on any given topic. 
        Your job is to provide insightful data that supports and enriches the writing process for the chapter.

    outliner:
      role: Outliner
      goal: >
        Based on research, generate a book outline about the given topic.
        The generated outline should include all chapters in sequential order and provide a title and description for each chapter.
        Consider the author's desired goal for the book
      backstory: >
        You are a skilled organizer, great at turning scattered information into a structured format.
        Your goal is to create clear, concise chapter outlines with all key topics and subtopics covered.
    

    writer:
      role: Chapter Writer
      goal: >
        Write a well-structured chapter for a book based on the provided chapter title, goal, and outline.
      backstory: >
        You are an exceptional writer, known for producing engaging, well-researched, and informative content.
        You excel at transforming complex ideas into readable and well-organized chapters.


================================================
FILE: examples-java/src/main/resources/prompts/factchecker/consolidate_assertions.jinja
================================================
Consolidate different factual assertions into a single list,
with no overlap.
Each assertion you return should be clear and stand by itself.

For example, if the input is:

- "The sky is blue."
- "The sky is blue and the grass is green."
- "The grass is green."
You should return:
- "The sky is blue."
- "The grass is green."

If the input is:
- France is larger than Sweden
- The user suggested that France is larger than Sweden
- Check whether France is larger than Sweden
You should return:
- "France is larger than Sweden."

Consolidate the following potentially overlapping factual assertions into a single list.
Each assertion should be expressed in at most {{ reasoningWordCount }} words.

Full list of assertions:

{% for assertion in assertions -%}
    - {{ assertion }}
{% endfor %}


================================================
FILE: examples-java/src/test/java/com/embabel/example/horoscope/StarNewsFinderTest.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope;

import com.embabel.agent.domain.library.NewsStory;
import com.embabel.agent.domain.library.RelevantNewsStories;
import com.embabel.agent.testing.unit.FakeOperationContext;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;

import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.Mockito.mock;

public class StarNewsFinderTest {

    @Nested
    class Writeup {

        @Test
        void writeupPromptMustContainKeyData() {

            HoroscopeService horoscopeService = mock(HoroscopeService.class);
            StarNewsFinder starNewsFinder = new StarNewsFinder(horoscopeService, 5);
            var context = new FakeOperationContext();
            context.expectResponse(new com.embabel.example.horoscope.Writeup("Gonna be a good day"));

            NewsStory cockatoos = new NewsStory(
                    "https://fake.com.au",
                    "Cockatoo behavior",
                    "Cockatoos are eating cabbages"
            );

            NewsStory emus = new NewsStory(
                    "https://morefake.com.au",
                    "Emu movements",
                    "Emus are massing"
            );

            StarPerson starPerson = new StarPerson("Lynda", "Scorpio");
            RelevantNewsStories relevantNewsStories = new RelevantNewsStories(Arrays.asList(cockatoos, emus));
            Horoscope horoscope = new Horoscope("This is a good day for you");

            starNewsFinder.writeup(starPerson, relevantNewsStories, horoscope, context.ai());

            var prompt = context.getLlmInvocations().getFirst().getMessages().getFirst().getContent();
            var toolGroups = context.getLlmInvocations().getFirst().getInteraction().getToolGroups();


            assertTrue(prompt.contains(starPerson.getName()));
            assertTrue(prompt.contains(starPerson.sign()));
            assertTrue(prompt.contains(cockatoos.getSummary()));
            assertTrue(prompt.contains(emus.getSummary()));

            assertTrue(toolGroups.isEmpty(), "The LLM should not have been given any tool groups");
        }
    }
}



================================================
FILE: examples-java/src/test/java/com/embabel/example/injection/InjectedComponentTest.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection;

import com.embabel.agent.api.common.Ai;
import com.embabel.agent.api.common.PromptRunner;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.Mockito.when;

/**
 * Unit test for InjectedComponent.
 */
class InjectedComponentTest {

    @Test
    void testTellJokeAbout() {
        var mockAi = Mockito.mock(Ai.class);
        var mockPromptRunner = Mockito.mock(PromptRunner.class);

        var prompt = "Tell me a joke about frogs";
        // Yep, an LLM came up with this joke.
        var terribleJoke = """
                Why don't frogs ever pay for drinks?
                Because they always have a tadpole in their wallet!
                """;
        when(mockAi.withDefaultLlm()).thenReturn(mockPromptRunner);
        when(mockPromptRunner.generateText(prompt)).thenReturn(terribleJoke);

        var injectedComponent = new InjectedComponent(mockAi);
        var joke = injectedComponent.tellJokeAbout("frogs");

        assertEquals(terribleJoke, joke);
        Mockito.verify(mockAi).withDefaultLlm();
        Mockito.verify(mockPromptRunner).generateText(prompt);
    }

}


================================================
FILE: examples-java/src/test/java/com/embabel/example/injection/travel/ActivitySummarizerTest.java
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.injection.travel;

import com.embabel.agent.api.common.Ai;
import com.embabel.agent.api.common.PromptRunner;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import java.time.Instant;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.when;

class ActivitySummarizerTest {

    @Test
    void testSummarizeActivityNullReport() {
        var mockReportingService = Mockito.mock(TravelActivityReportingService.class);
        var mockAi = Mockito.mock(Ai.class);
        var config = new ActivitySummarizer.Config(80, 2000.0f, 10f);

        when(mockReportingService.report(1L)).thenReturn(null);

        var activitySummarizer = new ActivitySummarizer(mockReportingService, mockAi, config);
        var result = activitySummarizer.summarizeActivity(1L);

        assertNull(result);
        Mockito.verify(mockReportingService).report(1L);
        Mockito.verifyNoInteractions(mockAi);
    }

    @Test
    void testSummarizeActivityLlmThrowsException() {
        var mockReportingService = Mockito.mock(TravelActivityReportingService.class);
        var mockAi = Mockito.mock(Ai.class);
        var mockPromptRunner = Mockito.mock(PromptRunner.class);
        var config = new ActivitySummarizer.Config(80, 2000.0f, 10f);

        var travellerActivity = createSampleTravellerActivity();
        when(mockReportingService.report(1L)).thenReturn(travellerActivity);
        when(mockAi.withDefaultLlm()).thenReturn(mockPromptRunner);
        when(mockPromptRunner.withToolObject(travellerActivity)).thenReturn(mockPromptRunner);
        when(mockPromptRunner.generateText(anyString())).thenThrow(new RuntimeException("LLM service unavailable"));

        var activitySummarizer = new ActivitySummarizer(mockReportingService, mockAi, config);

        assertThrows(RuntimeException.class, () -> activitySummarizer.summarizeActivity(1L));

        Mockito.verify(mockReportingService).report(1L);
        Mockito.verify(mockAi).withDefaultLlm();
        Mockito.verify(mockPromptRunner).withToolObject(travellerActivity);
    }

    @Test
    void testSummarizeActivityValidReturn() {
        var mockReportingService = Mockito.mock(TravelActivityReportingService.class);
        var mockAi = Mockito.mock(Ai.class);
        var mockPromptRunner = Mockito.mock(PromptRunner.class);
        var config = new ActivitySummarizer.Config(80, 2000.0f, 10f);

        var travellerActivity = createSampleTravellerActivity();
        var expectedSummary = "John Doe is a frequent traveler who has taken 2 trips to Paris and Tokyo, spending $3000 total. As a high spender, he enjoys premium destinations.";

        when(mockReportingService.report(1L)).thenReturn(travellerActivity);
        when(mockAi.withDefaultLlm()).thenReturn(mockPromptRunner);
        when(mockPromptRunner.withToolObject(travellerActivity)).thenReturn(mockPromptRunner);
        when(mockPromptRunner.generateText(anyString())).thenReturn(expectedSummary);

        var activitySummarizer = new ActivitySummarizer(mockReportingService, mockAi, config);
        var result = activitySummarizer.summarizeActivity(1L);

        assertEquals(expectedSummary, result.summary());
        assertEquals(travellerActivity, result.activity());

        Mockito.verify(mockReportingService).report(1L);
        Mockito.verify(mockAi).withDefaultLlm();
        Mockito.verify(mockPromptRunner).withToolObject(travellerActivity);
        Mockito.verify(mockPromptRunner).generateText(anyString());
    }

    private TravellerActivity createSampleTravellerActivity() {
        var trip1 = new Trip("New York", "Paris", Instant.parse("2024-01-01T10:00:00Z"), Instant.parse("2024-01-01T20:00:00Z"), 1500f);
        var trip2 = new Trip("Paris", "Tokyo", Instant.parse("2024-02-01T08:00:00Z"), Instant.parse("2024-02-01T22:00:00Z"), 1500f);

        return new TravellerActivity(
                "John Doe",
                Instant.parse("2024-01-01T00:00:00Z"),
                Instant.parse("2024-12-31T23:59:59Z"),
                List.of(trip1, trip2)
        );
    }
}


================================================
FILE: examples-kotlin/README.md
================================================
![Build](https://github.com/embabel/embabel-agent/actions/workflows/maven.yml/badge.svg)

[//]: # ([![Quality Gate Status]&#40;https://sonarcloud.io/api/project_badges/measure?project=embabel_embabel-agent&metric=alert_status&token=d275d89d09961c114b8317a4796f84faf509691c&#41;]&#40;https://sonarcloud.io/summary/new_code?id=embabel_embabel-agent&#41;)

[//]: # ([![Bugs]&#40;https://sonarcloud.io/api/project_badges/measure?project=embabel_embabel-agent&metric=bugs&#41;]&#40;https://sonarcloud.io/summary/new_code?id=embabel_embabel-agent&#41;)

![Kotlin](https://img.shields.io/badge/kotlin-%237F52FF.svg?style=for-the-badge&logo=kotlin&logoColor=white)
![Java](https://img.shields.io/badge/java-%23ED8B00.svg?style=for-the-badge&logo=openjdk&logoColor=white)
![Spring](https://img.shields.io/badge/spring-%236DB33F.svg?style=for-the-badge&logo=spring&logoColor=white)
![Apache Tomcat](https://img.shields.io/badge/apache%20tomcat-%23F8DC75.svg?style=for-the-badge&logo=apache-tomcat&logoColor=black)
![Apache Maven](https://img.shields.io/badge/Apache%20Maven-C71A36?style=for-the-badge&logo=Apache%20Maven&logoColor=white)
![ChatGPT](https://img.shields.io/badge/chatGPT-74aa9c?style=for-the-badge&logo=openai&logoColor=white)
![Jinja](https://img.shields.io/badge/jinja-white.svg?style=for-the-badge&logo=jinja&logoColor=black)
![JSON](https://img.shields.io/badge/JSON-000?logo=json&logoColor=fff)
![GitHub Actions](https://img.shields.io/badge/github%20actions-%232671E5.svg?style=for-the-badge&logo=githubactions&logoColor=white)
![SonarQube](https://img.shields.io/badge/SonarQube-black?style=for-the-badge&logo=sonarqube&logoColor=4E9BCD)
![Docker](https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white)
![IntelliJ IDEA](https://img.shields.io/badge/IntelliJIDEA-000000.svg?style=for-the-badge&logo=intellij-idea&logoColor=white)

<img align="left" src="https://github.com/embabel/embabel-agent/blob/main/embabel-agent-api/images/315px-Meister_der_Weltenchronik_001.jpg?raw=true" width="180">

&nbsp;&nbsp;&nbsp;&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;

# ğŸ¤– Embabel Agent Kotlin Examples

Learn agentic AI development with **Spring Framework** and **Kotlin/Java**. These examples demonstrate building intelligent agents that can plan, execute workflows, use tools, and interact with humans.

## ğŸš€ Quick Start

### Prerequisites
- **Java 21+**
- **API Key** (at least one): [OpenAI](https://platform.openai.com/api-keys) or [Anthropic](https://www.anthropic.com/api)
- **Maven 3.9+** (optional - project includes Maven wrapper)

### 1. Clone & Build
```bash
git clone https://github.com/embabel/embabel-agent-examples.git
cd embabel-agent-examples
./mvnw clean install    # Unix/Linux/macOS
mvnw.cmd clean install  # Windows
```

### 2. Set API Keys
```bash
# Required (choose one or both)
export OPENAI_API_KEY="your_openai_key"
export ANTHROPIC_API_KEY="your_anthropic_key"

```

### 3. Run Examples

#### **Kotlin Examples**
```bash
cd scripts/kotlin
./shell.sh                    # Unix/Linux/macOS - Basic features
shell.cmd                     # Windows - Basic features

./shell.sh --docker-tools     # Unix/Linux/macOS - With Docker integration
shell.cmd --docker-tools      # Windows - With Docker integration
```

---

## ğŸ†• **Spring Boot Integration Architecture**

### **Three Application Modes**
The Embabel Agent framework provides three distinct application modes through dedicated starter classes:

```kotlin
// 1. Interactive Shell Mode with Star Wars themed logging
@SpringBootApplication
@EnableAgentShell
@EnableAgents(loggingTheme = LoggingTheme.STAR_WARS)
class AgentShellApplication

// 2. Shell Mode with MCP Client Support (Docker Desktop integration)
@SpringBootApplication
@EnableAgentShell
@EnableAgents(
    loggingTheme = LoggingTheme.SEVERANCE,
    mcpServers = [McpServers.DOCKER_DESKTOP]
)
class AgentShellMcpClientApplication

// 3. MCP Server Mode  
@SpringBootApplication
@EnableAgentMcpServer
@EnableAgents(mcpServers = [McpServers.DOCKER_DESKTOP])
class AgentMcpServerApplication
```

### **Annotation Guide:**

#### **`@EnableAgentShell`**
- âœ… Interactive command-line interface
- âœ… Agent discovery and registration
- âœ… Human-in-the-loop capabilities
- âœ… Progress tracking and logging
- âœ… Development-friendly error handling

#### **`@EnableAgentMcpServer`**
- âœ… MCP protocol server implementation
- âœ… Tool registration and discovery
- âœ… JSON-RPC communication via SSE (Server-Sent Events)
- âœ… Integration with MCP-compatible servers
- âœ… Security and sandboxing

#### **`@EnableAgents`**
- ğŸ¨ **loggingTheme**: Customize your agent's logging personality
  - `LoggingThemes.STAR_WARS` - May the Force be with your logs!
  - `LoggingThemes.SEVERANCE` - Welcome to Lumon Industries (default)
- ğŸ³ **mcpServers**: Enable MCP server integrations
  - `McpServers.DOCKER_DESKTOP` - Docker Desktop AI capabilities
  - Custom servers can be added

---

## ğŸ“š Examples by Learning Level

### ğŸŒŸ **Beginner: Horoscope News Agent**
> **Available in:** Java & Kotlin | **Concept:** Basic Agent Workflow

A fun introduction to agent development that finds personalized news based on someone's star sign.

**What It Teaches:**
- ğŸ“‹ **Action-based workflows** with `@Action` annotations
- ğŸ” **Data extraction** from user input using LLMs
- ğŸŒ **Web tool integration** for finding news stories
- ğŸ“ **Content generation** with personality and context
- ğŸ¯ **Goal achievement** with `@AchievesGoal`

**How It Works:**
1. Extract person's name from user input
2. Get their star sign (via form if needed)
3. Retrieve daily horoscope
4. Search web for relevant news stories
5. Create amusing writeup combining horoscope + news

**Try It:**

Start the agent shell, then type:

```bash
x "Find horoscope news for Alice who is a Gemini"
```

`x` is short for `execute`, which triggers the agent to run its workflow.

**Code Comparison:**
- **Kotlin:** `examples-kotlin/src/main/kotlin/com/embabel/example/horoscope/StarNewsFinder.kt`
- **Java:** `examples-java/src/main/java/com/embabel/example/horoscope/StarNewsFinder.java`

**Key Patterns:**
```kotlin
@Agent(description = "Find news based on a person's star sign")
class StarNewsFinder {
    
    @Action
    fun extractPerson(userInput: UserInput): Person?
    
    @Action(toolGroups = [CoreToolGroups.WEB])
    fun findNewsStories(person: StarPerson, horoscope: Horoscope): RelevantNewsStories
    
    @AchievesGoal(description = "Create an amusing writeup")
    @Action
    fun starNewsWriteup(/* params */): Writeup
}
```

---

### ğŸ”¬ **Expert: Multi-LLM Research Agent**
> **Available in:** Kotlin | **Concept:** Self-Improving AI Workflows

A sophisticated research agent using multiple AI models with self-critique capabilities.

**What It Teaches:**
- ğŸ§  **Multi-model consensus** (GPT-4 + Claude working together)
- ğŸ” **Self-improvement loops** with critique and retry
- âš™ï¸ **Configuration-driven behavior** with Spring Boot properties
- ğŸŒŠ **Parallel processing** of research tasks
- ğŸ“ **Quality control** through automated review

**Architecture:**
```kotlin
@ConfigurationProperties(prefix = "embabel.examples.researcher")
data class ResearcherProperties(
    val maxWordCount: Int = 300,
    val claudeModelName: String = AnthropicModels.CLAUDE_35_HAIKU,
    val openAiModelName: String = OpenAiModels.GPT_41_MINI
)
```

**Self-Improvement Pattern:**
```kotlin
@Action(outputBinding = "gpt4Report")
fun researchWithGpt4(/* params */): SingleLlmReport

@Action(outputBinding = "claudeReport") 
fun researchWithClaude(/* params */): SingleLlmReport

@Action(outputBinding = "mergedReport")
fun mergeReports(gpt4: SingleLlmReport, claude: SingleLlmReport): ResearchReport

@Action
fun critiqueReport(report: ResearchReport): Critique

@AchievesGoal(description = "Completes research with quality assurance")
fun acceptReport(report: ResearchReport, critique: Critique): ResearchReport
```

**Try It:**
```bash
"Research the latest developments in renewable energy adoption"
```

**Location:** `examples-kotlin/src/main/kotlin/com/embabel/example/researcher/`

---

### âœ… **Expert: Fact-Checking Agent (DSL Style)**
> **Available in:** Kotlin | **Concept:** Functional Agent Construction

A fact-verification agent built using Embabel's functional DSL approach instead of annotations.

**What It Teaches:**
- ğŸ”§ **Functional DSL construction** for agents
- ğŸ” **Parallel fact verification** across multiple claims
- ğŸ“Š **Confidence scoring** and source trust evaluation
- ğŸŒ **Web research integration** for verification
- âš¡ **Functional programming patterns** in agent design

**DSL Construction:**
```kotlin
fun factCheckerAgent(llms: List<LlmOptions>, properties: FactCheckerProperties) = 
agent(name = "FactChecker", description = "Check content for factual accuracy") {
    
    flow {
        aggregate<UserInput, FactualAssertions, RationalizedFactualAssertions>(
            transforms = llms.map { llm ->
                { context -> /* extract assertions with this LLM */ }
            },
            merge = { list, context -> /* rationalize overlapping claims */ }
        )
    }
    
    transformation<RationalizedFactualAssertions, FactCheck> { 
        /* parallel fact-checking */
    }
}
```

**Domain Model:**
```kotlin
data class FactualAssertion(
    val claim: String,
    val reasoning: String
)

data class AssertionCheck(
    val assertion: String,
    val isTrue: Boolean,
    val confidence: ZeroToOne,
    val reasoning: String,
    val links: List<InternetResource>
)
```

**Try It:**
```bash
"Check these facts: The Earth is flat. Paris is the capital of France."
```

**Location:** `examples-kotlin/src/main/kotlin/com/embabel/example/factchecker/`

---

## ğŸ› ï¸ Core Concepts You'll Learn

### **Spring Framework Integration**
- **Multiple Application Classes:** Dedicated starters for different modes
- **Maven Profiles:** `enable-shell`, `enable-shell-mcp-client`, `enable-agent-mcp-server`
- **Dependency Injection:** Constructor-based injection with agents as Spring beans
- **Configuration Properties:** Type-safe configuration with `@ConfigurationProperties`
- **Conditional Beans:** Environment-specific components with `@ConditionalOnBean`
- **Repository Pattern:** Spring Data integration for domain entities

### **Modern Spring Boot Patterns**
- **Multi-Annotation Architecture:** Combining multiple `@Enable*` annotations
- **Profile-Based Execution:** Maven profiles control which application class runs
- **Auto-Configuration Classes:** Understanding Spring Boot's auto-configuration
- **Conditional Configuration:** Mode-specific bean loading
- **Theme-Based Customization:** Dynamic behavior based on configuration

### **Modern Kotlin Features**
- **Data Classes:** Rich domain models with computed properties
- **Type Aliases:** Domain-specific types (`typealias OneThroughTen = Int`)
- **Extension Functions:** Enhanced functionality for existing types
- **Delegation:** Clean composition patterns
- **DSL Construction:** Functional agent building
- **Coroutines:** Parallel execution with structured concurrency

### **Agent Design Patterns**
- **Workflow Orchestration:** Multi-step processes with `@Action` chains
- **Blackboard Pattern:** Shared workspace for data between actions
- **Human-in-the-Loop:** User confirmations and form submissions
- **Self-Improvement:** Critique and retry loops for quality
- **Multi-Model Consensus:** Combining results from different LLMs
- **Condition-Based Flow:** Workflow control with `@Condition`
- **Progress Tracking:** Event publishing for monitoring

---

## ğŸ”§ Running Specific Examples

### **Interactive Shell Mode** (Default)
```bash
cd scripts/kotlin && ./shell.sh          # Basic features
cd scripts/kotlin && shell.cmd           # Basic features (Windows)
```

Uses Maven profile: `enable-shell`

### **Shell with MCP Client Support**
```bash
cd scripts/kotlin && ./shell.sh --docker-tools     # Advanced Docker integration
cd scripts/kotlin && shell.cmd --docker-tools      # Advanced Docker integration (Windows)
```

Uses Maven profile: `enable-shell-mcp-client`

### **MCP Server Mode**
```bash
cd scripts/kotlin && ./mcp_server.sh
cd scripts/kotlin && mcp_server.cmd      # Windows
```

## ğŸŒ **MCP (Model Context Protocol) Support**

### **What is MCP?**
MCP (Model Context Protocol) is an open protocol that enables AI assistants and applications to securely connect to data sources and tools. Embabel supports MCP in two ways:

1. **MCP Server Mode**: Your agents become tools that can be called by MCP clients
2. **MCP Server Support**: Your agents can connect to external MCP servers (like Docker Desktop)

### **MCP Server Mode**

Run your agents as an MCP server that exposes tools over Server-Sent Events (SSE):

```bash
# Start Kotlin agents as MCP server
cd scripts/kotlin && ./mcp_server.sh
```

Your agents become available as tools:
- **StarNewsFinder** - `find_horoscope_news`
- **MovieFinder** - `suggest_movies` 
- **Researcher** - `research_topic`
- **FactChecker** - `check_facts`

### **MCP Server Support**

Enable your agents to connect to external MCP servers using the `--docker-tools` parameter:

```bash
# Enable Docker Desktop MCP integration
cd scripts/kotlin && ./shell.sh --docker-tools
```

This allows your agents to:
- Execute commands in Docker containers
- Access containerized services
- Integrate with other MCP-compatible servers

### **Benefits of MCP**
- **ğŸ”„ Tool Interoperability** - Agents can use and be used as tools
- **ğŸ¯ Domain Expertise** - Specialized agents for specific tasks
- **ğŸ› ï¸ Tool Composition** - Combine multiple tools in workflows
- **ğŸ”’ Secure Access** - MCP handles authentication and sandboxing
- **ğŸ“ˆ Scalable Architecture** - Add new tools without changing code

---

## ğŸ¯ **Creating Your Own Agent Application**

### **Basic Shell Application**
```kotlin
@SpringBootApplication
@EnableAgentShell
@EnableAgents
class MyAgentApplication

fun main(args: Array<String>) {
    runApplication<MyAgentApplication>(*args)
}
```

### **Shell with Theme and MCP Server**
```kotlin
@SpringBootApplication
@EnableAgentShell
@EnableAgents(
    loggingTheme = LoggingThemes.STAR_WARS,
    mcpServers = [McpServers.DOCKER_DESKTOP]
)
class MyThemedAgentApplication

fun main(args: Array<String>) {
    runApplication<MyThemedAgentApplication>(*args)
}
```

### **MCP Server Application**  
```kotlin
@SpringBootApplication
@EnableAgentMcpServer
@EnableAgents
class MyMcpServerApplication

fun main(args: Array<String>) {
    runApplication<MyMcpServerApplication>(*args)
}
```

---

## ğŸ¯ Getting Started Recommendations

### **New to Agents?**
1. Start with **Horoscope News Agent** (Java or Kotlin)
2. Compare the Java vs Kotlin implementations
3. Experiment with different prompts and see how the agent plans different workflows
4. Try different logging themes to make development more fun!

### **Spring Developer?**
1. Examine the **Star News Finder** for Spring integration patterns
2. Look at the configuration classes in **Researcher** and **Fact Checker**
3. Study how agents work as Spring beans
4. Explore the different application modes and Maven profiles
5. See how themes and MCP servers are configured

### **Kotlin Enthusiast?**
1. Start with **Star News Finder** for basic Kotlin patterns
2. Progress to **Researcher** for multi-model patterns
3. Explore **Fact Checker** for functional DSL approaches

### **AI/ML Developer?**
1. Study prompt engineering techniques in any example
2. Examine the **Researcher** for multi-model consensus patterns
3. Look at **Fact Checker** for confidence scoring and source evaluation
4. Explore MCP integration for tool composition

---

## ğŸš¨ Common Issues & Solutions

| Problem | Solution |
|---------|----------|
| **"No API keys found"** | Set `OPENAI_API_KEY` or `ANTHROPIC_API_KEY` |
| **Wrong examples load** | Use correct script: `kotlin/shell.sh` vs `java/shell.sh` |
| **Build failures** | Run `./mvnw clean install` (Unix/macOS) or `mvnw.cmd clean install` (Windows) from project root |
| **Tests fail** | Check API keys are set in test environment |
| **Application class not found** | Check Maven profile matches application class |
| **MCP server fails to start** | Check port availability and Docker Desktop status |
| **WARNING: Only Basic Agent features** | Use `--docker-tools` parameter to enable Docker integration |

---

## ğŸ“ Project Structure

```
embabel-agent-examples/
â”œâ”€â”€ examples-kotlin/                 # ğŸ† Kotlin implementations
â”‚   â”œâ”€â”€ src/main/kotlin/com/embabel/example/
â”‚   â”‚   â”œâ”€â”€ AgentShellApplication.kt         # Basic shell mode
â”‚   â”‚   â”œâ”€â”€ AgentShellMcpClientApplication.kt # Shell + MCP client
â”‚   â”‚   â”œâ”€â”€ AgentMcpServerApplication.kt     # MCP server mode  
â”‚   â”‚   â”œâ”€â”€ horoscope/              # ğŸŒŸ Beginner: Star news agent
â”‚   â”‚   â”œâ”€â”€ researcher/             # ğŸ”¬ Expert: Multi-LLM researcher
â”‚   â”‚   â””â”€â”€ factchecker/            # âœ… Expert: Fact checker (DSL)
â”‚   â”œâ”€â”€ pom.xml                     # Maven profiles for each mode
â”‚   â””â”€â”€ README.md                   # ğŸ“– Kotlin-specific documentation
â”œâ”€â”€ examples-common/                 # ğŸ”§ Shared services & utilities
â”œâ”€â”€ scripts/                        # ğŸš€ Quick-start scripts
â”‚   â”œâ”€â”€ kotlin/
â”‚   â”‚   â”œâ”€â”€ shell.sh               # Launch shell (with --docker-tools option)
â”‚   â”‚   â””â”€â”€ mcp_server.sh          # Launch MCP server
â”‚   â”œâ”€â”€ support/                   # Shared script utilities
â”‚   â””â”€â”€ README.md                  # ğŸ“– Scripts documentation
â””â”€â”€ pom.xml                         # Parent Maven configuration
```

---

## ğŸ“„ License

Licensed under the Apache License 2.0. See [LICENSE](LICENSE) for details.

**ğŸ‰ Happy coding with Spring Framework and agentic AI!**

### ğŸŒŸ May the Force be with your agents! ğŸŒŸ


================================================
FILE: examples-kotlin/pom.xml
================================================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.embabel.example</groupId>
        <artifactId>example-agent-parent</artifactId>
        <version>0.2.0-SNAPSHOT</version>
    </parent>
    <artifactId>example-agent-kotlin</artifactId>
    <name>Embabel Agent Kotlin Examples</name>
    <description>Agent Examples for Kotlin Developers</description>

    <dependencies>

        <dependency>
            <groupId>com.embabel.example</groupId>
            <artifactId>examples-common</artifactId>
            <version>${project.version}</version>
        </dependency>

        <!-- Ollama is always included as an option for local model hosting -->
        <dependency>
            <groupId>com.embabel.agent</groupId>
            <artifactId>embabel-agent-starter-ollama</artifactId>
        </dependency>

        <dependency>
            <groupId>com.embabel.agent</groupId>
            <artifactId>embabel-agent-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.jetbrains.kotlin</groupId>
                <artifactId>kotlin-maven-plugin</artifactId>
            </plugin>

            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.embabel.example.KotlinAgentShellApplicationKt</mainClass>
                </configuration>
                <version>${spring-boot.version}</version>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

    <profiles>
        <profile>
            <id>openai-models</id>
            <activation>
                <property>
                    <name>env.OPENAI_API_KEY</name>
                </property>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-openai</artifactId>
                </dependency>
            </dependencies>
        </profile>
        <profile>
            <id>anthropic-models</id>
            <activation>
                <property>
                    <name>env.ANTHROPIC_API_KEY</name>
                </property>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-anthropic</artifactId>
                </dependency>
            </dependencies>
        </profile>
        <profile>
            <id>docker-models</id>
            <activation>
                <property>
                    <name>env.DOCKER_MODELS_AVAILABLE</name>
                </property>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-dockermodels</artifactId>
                </dependency>
            </dependencies>
        </profile>
        <profile>
            <id>enable-shell-mcp-client</id>
            <activation>
                <activeByDefault>true</activeByDefault>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-shell</artifactId>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                        <configuration>
                            <mainClass>com.embabel.example.KotlinAgentShellApplicationKt</mainClass>
                        </configuration>
                        <version>${spring-boot.version}</version>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>enable-shell</id>
            <activation>
                <activeByDefault>false</activeByDefault>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-shell</artifactId>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                        <configuration>
                            <mainClass>com.embabel.example.KotlinAgentSimpleShellApplicationKt</mainClass>
                        </configuration>
                        <version>${spring-boot.version}</version>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>enable-agent-mcp-server</id>
            <activation>
                <activeByDefault>false</activeByDefault>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>com.embabel.agent</groupId>
                    <artifactId>embabel-agent-starter-mcpserver</artifactId>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                        <configuration>
                            <mainClass>com.embabel.example.KotlinAgentMcpServerApplicationKt</mainClass>
                        </configuration>
                        <version>${spring-boot.version}</version>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>
</project>



================================================
FILE: examples-kotlin/src/main/kotlin/com/embabel/example/KotlinAgentMcpServerApplication.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example

import com.embabel.agent.config.annotation.EnableAgents
import com.embabel.agent.config.annotation.McpServers
import org.springframework.boot.autoconfigure.SpringBootApplication
import org.springframework.boot.context.properties.ConfigurationPropertiesScan
import org.springframework.boot.runApplication

/**
 * Spring Boot application that runs Embabel agents as an MCP (Model Context Protocol) server.
 *
 * This application exposes agents as MCP-compatible tools that can be consumed by
 * AI assistants like Claude Desktop, IDEs, or other MCP clients. The server
 * implements the JSON-RPC based MCP protocol for tool discovery and execution.
 *
 */
@SpringBootApplication
@ConfigurationPropertiesScan(
    basePackages = ["com.embabel.example"]
)
@EnableAgents(
    mcpServers = [McpServers.DOCKER_DESKTOP, McpServers.DOCKER],
)
class KotlinAgentMcpServerApplication

/**
 * Application entry point that starts the MCP server.
 *
 * Initializes Spring Boot with MCP server configuration and begins
 * listening for JSON-RPC requests from MCP clients.
 *
 * @param args Command line arguments passed to the application
 */
fun main(args: Array<String>) {
    runApplication<KotlinAgentMcpServerApplication>(*args)
}



================================================
FILE: examples-kotlin/src/main/kotlin/com/embabel/example/KotlinAgentShellApplication.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example

import com.embabel.agent.config.annotation.EnableAgents
import com.embabel.agent.config.annotation.LoggingThemes
import com.embabel.agent.config.annotation.McpServers
import org.springframework.boot.autoconfigure.SpringBootApplication
import org.springframework.boot.context.properties.ConfigurationPropertiesScan
import org.springframework.boot.runApplication

/**
 * Spring Boot application that runs Embabel agents in interactive shell mode.
 *
 * This application provides a command-line interface for testing and interacting
 * with agents. The shell allows executing agent commands, entering chat mode,
 * and debugging agent workflows.
 *
 * ## Example Usage
 * ```
 * shell:> execute "Find news for Alice who is a Gemini"
 * shell:> chat
 * shell:> help
 * ```
 *
 * @see EnableAgents
 */
@SpringBootApplication
@ConfigurationPropertiesScan(
    basePackages = ["com.embabel.example"]
)
@EnableAgents(
    loggingTheme = LoggingThemes.STAR_WARS,
    mcpServers = [McpServers.DOCKER_DESKTOP, McpServers.DOCKER],
)
class KotlinAgentShellApplication

/**
 * Application entry point that bootstraps the Spring Boot application.
 *
 * Initializes the Spring context with agent auto-configuration and
 * starts the interactive shell interface.
 *
 * @param args Command line arguments passed to the application
 */
fun main(args: Array<String>) {
    runApplication<KotlinAgentShellApplication>(*args)
}



================================================
FILE: examples-kotlin/src/main/kotlin/com/embabel/example/KotlinAgentSimpleShellApplication.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example

import com.embabel.agent.config.annotation.EnableAgents
import com.embabel.agent.config.annotation.LoggingThemes
import org.springframework.boot.autoconfigure.SpringBootApplication
import org.springframework.boot.context.properties.ConfigurationPropertiesScan
import org.springframework.boot.runApplication

/**
 * Spring Boot application that runs Embabel agents in interactive shell mode.
 *
 * This application provides a command-line interface for testing and interacting
 * with agents. The shell allows executing agent commands, entering chat mode,
 * and debugging agent workflows.
 *
 * ## Example Usage
 * ```
 * shell:> execute "Find news for Alice who is a Gemini"
 * shell:> chat
 * shell:> help
 * ```
 *
 * @see EnableAgents
 */
@SpringBootApplication
@ConfigurationPropertiesScan(
    basePackages = ["com.embabel.example"]
)
@EnableAgents(
    loggingTheme = LoggingThemes.SEVERANCE,
)
class KotlinAgentShellMcpClientApplication

/**
 * Application entry point that bootstraps the Spring Boot application.
 *
 * Initializes the Spring context with agent auto-configuration and
 * starts the interactive shell interface.
 *
 * @param args Command line arguments passed to the application
 */
fun main(args: Array<String>) {
    runApplication<KotlinAgentShellMcpClientApplication>(*args)
}



================================================
FILE: examples-kotlin/src/main/kotlin/com/embabel/example/factchecker/factChecker.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.factchecker

import com.embabel.agent.api.common.createObject
import com.embabel.agent.api.dsl.agent
import com.embabel.agent.api.dsl.aggregate
import com.embabel.agent.api.dsl.parallelMap
import com.embabel.agent.api.models.AnthropicModels
import com.embabel.agent.core.Agent
import com.embabel.agent.core.CoreToolGroups
import com.embabel.agent.domain.io.UserInput
import com.embabel.agent.domain.library.InternetResource
import com.embabel.agent.domain.library.InternetResources
import com.embabel.common.ai.model.LlmOptions
import com.embabel.common.core.types.ZeroToOne
import com.fasterxml.jackson.annotation.JsonPropertyDescription
import org.springframework.boot.context.properties.ConfigurationProperties
import org.springframework.context.annotation.Bean
import org.springframework.context.annotation.Configuration
import org.springframework.context.annotation.Profile

data class FactualAssertion(val standaloneAssertion: String)

data class FactualAssertions(val factualAssertions: List<FactualAssertion>)

data class RationalizedFactualAssertions(
    val factualAssertions: List<FactualAssertion>,
    @param:JsonPropertyDescription("factual assertions that were merged")
    val numberMerged: Int,
)

data class AssertionCheck(
    val assertion: String,
    val isTrue: Boolean,
    @param:JsonPropertyDescription("confidence in your judgment as to whether the assertion true or false. From 0-1")
    val confidence: ZeroToOne,
    @param:JsonPropertyDescription("reasoning for your scoring")
    val reasoning: String,
    override val links: List<InternetResource>,
) : InternetResources

data class FactCheck(
    val checks: List<AssertionCheck>,
)

@ConfigurationProperties("embabel.fact-checker")
data class FactCheckerProperties(
    val reasoningWordCount: Int = 30,
    val trustedSources: List<String> = listOf(
        "Wikipedia",
        "Wikidata",
        "Britannica",
        "BBC",
        "Reuters",
        "ABC Australia",
    ),
    val untrustedSources: List<String> = listOf(
        "Reddit",
        "4chan",
        "Twitter",
    )
)

@Configuration
@Profile("!test")
class FactCheckerAgentConfiguration {
    @Bean
    fun factChecker(factCheckerProperties: FactCheckerProperties): Agent {
        return factCheckerAgent(
            llms = listOf(
                LlmOptions(AnthropicModels.CLAUDE_35_HAIKU).withTemperature(.3),
                LlmOptions(AnthropicModels.CLAUDE_35_HAIKU).withTemperature(.0),
            ),
            properties = factCheckerProperties,
        )
    }
}


/**
 * Naming agent that generates names for a company or project.
 */
fun factCheckerAgent(
    llms: List<LlmOptions>,
    properties: FactCheckerProperties,
) = agent(
    name = "FactChecker",
    description = "Check content for factual accuracy",
) {

    flow {

        aggregate<UserInput, FactualAssertions, RationalizedFactualAssertions>(
            transforms = llms.map { llm ->
                { context ->
                    context.ai().withLlm(llm).withToolGroup(CoreToolGroups.WEB).createObject(
                        """
            Given the following content, identify any factual assertions.
            Phrase them as standalone assertions.
            Do not duplicate assertions.
            Use the minimum number of assertions possible, with no overlap.

            # Content
            ${context.input.content}
            """.trimIndent()
                    )
                }
            },
            merge = { list, context ->
                context.ai().withDefaultLlm().createObject<RationalizedFactualAssertions>(
                    """
                    Given the following factual assertions, merge them into a single list if
                    any are the same. Condense into one assertion if one assertion negates another.
                    Count the number you merged.

                    # Assertions
                    ${list.flatMap { it.factualAssertions }.joinToString("\n") { "- " + it.standaloneAssertion }}
                    """.trimIndent()
                )
            },
        )
    }

    transformation<RationalizedFactualAssertions, FactCheck> { operationContext ->
        val promptRunner = operationContext.ai()
            .withAutoLlm()
            .withTools(
                CoreToolGroups.WEB, CoreToolGroups.BROWSER_AUTOMATION,
            )
        val checks = operationContext.input.factualAssertions.parallelMap(operationContext) { assertion ->
            promptRunner.createObject<AssertionCheck>(
                """
                Given the following assertion, check if it is true or false and explain why in ${properties.reasoningWordCount} words
                Express your confidence in your determination as a number between 0 and 1.
                Use web tools.

                Be guided by the following regarding sources:
                - Trusted sources: ${properties.trustedSources.joinToString(", ")}
                - Untrusted sources: ${properties.untrustedSources.joinToString(", ")}
                Assertion: <${assertion.standaloneAssertion}>
                """
            )
        }
        FactCheck(checks)
    }

    goal(
        name = "factCheckingDone",
        description = "Content was fact checked",
        satisfiedBy = FactCheck::class,
    )

}



================================================
FILE: examples-kotlin/src/main/kotlin/com/embabel/example/horoscope/StarNewsFinder.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope

import com.embabel.agent.api.annotation.*
import com.embabel.agent.api.common.OperationContext
import com.embabel.agent.api.common.createObject
import com.embabel.agent.api.common.createObjectIfPossible
import com.embabel.agent.api.models.OpenAiModels
import com.embabel.agent.core.CoreToolGroups
import com.embabel.agent.domain.io.UserInput
import com.embabel.agent.domain.library.HasContent
import com.embabel.agent.domain.library.Person
import com.embabel.agent.domain.library.RelevantNewsStories
import com.embabel.common.ai.model.LlmOptions
import com.embabel.ux.form.Text
import com.fasterxml.jackson.annotation.JsonClassDescription
import com.fasterxml.jackson.annotation.JsonPropertyDescription
import com.fasterxml.jackson.databind.annotation.JsonDeserialize
import org.springframework.beans.factory.annotation.Value

/**
 * Data class representing astrological details for a person.
 * Used to capture star sign information through a form interface.
 */
@JsonClassDescription("Astrological details for a person")
data class Starry(
    @Text(label = "Star sign")
    val sign: String,
)

/**
 * Data class representing a person with their astrological details.
 * Implements the Person interface to maintain compatibility with the agent framework's
 * person-related operations.
 */
@JsonClassDescription("Person with astrology details")
@JsonDeserialize(`as` = StarPerson::class)
data class StarPerson(
    override val name: String,
    @get:JsonPropertyDescription("Star sign")
    val sign: String,
) : Person

/**
 * Data class containing a person's horoscope summary.
 * Acts as a container for the horoscope text retrieved from the HoroscopeService.
 */
data class Horoscope(
    val summary: String,
)

/**
 * Data class representing the final output of the agent's workflow.
 * Implements HasContent interface to provide standardized access to the text content.
 */
data class Writeup(
    override val content: String,
) : HasContent

/**
 * An agent that finds personalized news stories based on a person's star sign.
 *
 * This agent demonstrates the workflow of:
 * 1. Extracting person information from user input
 * 2. Obtaining astrological details
 * 3. Retrieving a horoscope
 * 4. Finding relevant news stories based on the horoscope
 * 5. Creating a personalized writeup combining the horoscope and news
 *
 * The agent leverages Spring dependency injection for services and uses
 * the annotation-driven programming model with @Agent and @Action annotations
 * to define its capabilities and workflow.
 */
@Agent(
    description = "Find news based on a person's star sign",
    scan = true,
    beanName = "KotlinStarNewsFinder",
)
class StarNewsFinder(
    private val horoscopeService: HoroscopeService,
    @param:Value("\${star-news-finder.model:gpt-4.1-mini}")
//    @Value("\${star-news-finder.model:ai/llama3.2}")

    private val model: String = OpenAiModels.GPT_41_NANO,
    @param:Value("\${star-news-finder.story.count:5}")
    private val storyCount: Int,
    @param:Value("\${star-news-finder.word.count:100}")
    private val wordCount: Int,
) {

    /**
     * Extracts a person entity from user input by parsing the text for a name.
     *
     * This method uses a lightweight LLM model (GPT-41-NANO) to efficiently extract
     * just the person's name from the user's input text. It's an entry point for
     * the agent workflow when only basic person information is available.
     *
     * @param userInput The user's text input
     * @return A Person object if extraction is successful, null otherwise
     */
    @Action
    fun extractPerson(userInput: UserInput, context: OperationContext): Person? =
        // All prompts are typesafe
        context.ai().withDefaultLlm().createObjectIfPossible(
            """
            Create a person from this user input, extracting their name:
            ${userInput.content}
            """.trimIndent()
        )

    /**
     * Collects astrological details for a person through a form interface.
     *
     * This method is marked with a high cost (100.0) to indicate that it should
     * only be used when no other path is available in the agent's planning process.
     * The high cost discourages the agent from asking for user input unless necessary.
     *
     * @param person The person for whom to collect star sign information
     * @return A Starry object containing the person's star sign
     */
    @Action(cost = 100.0) // Make it costly so it won't be used in a plan unless there's no other path
    internal fun makeStarry(
        person: Person,
    ): Starry =
        fromForm("Let's get some astrological details for ${person.name}")

    /**
     * Combines a person and their astrological details into a StarPerson object.
     *
     * This method serves as a data transformation step in the agent workflow,
     * creating a specialized person object that includes star sign information.
     *
     * @param person The basic person information
     * @param starry The astrological details
     * @return A StarPerson object combining both sets of information
     */
    @Action
    fun assembleStarPerson(
        person: Person,
        starry: Starry,
    ): StarPerson {
        return StarPerson(
            name = person.name,
            sign = starry.sign,
        )
    }

    /**
     * Extracts both person information and star sign directly from user input.
     *
     * This method provides an alternative entry point to the agent workflow,
     * allowing the extraction of both name and star sign in a single step when
     * that information is present in the user's input.
     *
     * @param userInput The user's text input
     * @return A StarPerson object if extraction is successful, null otherwise
     */
    @Action
    fun extractStarPerson(userInput: UserInput, context: OperationContext): StarPerson? =
        context.ai().withAutoLlm().createObjectIfPossible(
            """
            Create a person from this user input, extracting their name and star sign:
            ${userInput.content}
            """.trimIndent()
        )

    /**
     * Retrieves a daily horoscope for a person based on their star sign.
     *
     * This method calls the injected HoroscopeService to get the actual horoscope text,
     * wrapping it in a Horoscope data class for use in subsequent steps.
     *
     * @param starPerson The person with their star sign information
     * @return A Horoscope object containing the daily horoscope text
     */
    @Action
    fun retrieveHoroscope(starPerson: StarPerson) =
        Horoscope(horoscopeService.dailyHoroscope(starPerson.sign))

    /**
     * Finds news stories relevant to a person's horoscope using web search tools.
     *
     * This method requires web tools (specified by toolGroups) to search for and
     * summarize news stories that relate to themes in the person's horoscope.
     * It uses the LLM to interpret the horoscope, generate appropriate search
     * queries, and summarize the results.
     *
     * @param person The person with their star sign
     * @param horoscope The person's daily horoscope
     * @return A collection of relevant news stories with summaries and URLs
     */
    // toolGroups specifies tools that are required for this action to run
    @Action(toolGroups = [CoreToolGroups.WEB, CoreToolGroups.BROWSER_AUTOMATION])
    internal fun findNewsStories(
        person: StarPerson,
        horoscope: Horoscope,
        context: OperationContext
    ): RelevantNewsStories =
        context.ai().withLlm(model).createObject(
            """
            ${person.name} is an astrology believer with the sign ${person.sign}.
            Their horoscope for today is:
                <horoscope>${horoscope.summary}</horoscope>
            Given this, use web tools and generate search queries
            to find $storyCount relevant news stories summarize them in a few sentences.
            Include the URL for each story.
            Do not look for another horoscope reading or return results directly about astrology;
            find stories relevant to the reading above.

            For example:
            - If the horoscope says that they may
            want to work on relationships, you could find news stories about
            novel gifts
            - If the horoscope says that they may want to work on their career,
            find news stories about training courses.
            """.trimIndent()
        )

    /**
     * Creates a personalized writeup combining the horoscope and relevant news stories.
     *
     * This method is the final step in the agent's workflow, marked with @AchievesGoal
     * to indicate that it fulfills the agent's primary purpose. It uses the LLM with
     * increased temperature (0.9) to generate creative content that combines the
     * horoscope interpretation with the found news stories in an amusing way.
     *
     * @param person The person with their star sign
     * @param relevantNewsStories The collection of news stories found
     * @param horoscope The person's daily horoscope
     * @return A Writeup containing the formatted text combining horoscope and news
     */
    // The @AchievesGoal annotation indicates that completing this action
    // achieves the given goal, so the agent flow can be complete
    @AchievesGoal(
        description = "Create an amusing writeup for the target person based on their horoscope",
        export = Export(
            remote = true,
            name = "StarNewsWriteup",
            startingInputTypes = [StarPerson::class],
        )
    )
    @Action
    fun starNewsWriteup(
        person: StarPerson,
        relevantNewsStories: RelevantNewsStories,
        horoscope: Horoscope,
        context: OperationContext
    ): Writeup =
        context.ai().withLlm(
            llm = LlmOptions.withModel(model).withTemperature(0.9)
        ).createObject(
            """
        Take the following news stories and write up something
        amusing for the target person in $wordCount words.

        Begin by summarizing their horoscope in a concise, amusing way, then
        talk about the news. End with a surprising signoff.

        ${person.name} is an astrology believer with the sign ${person.sign}.
        Their horoscope for today is:
            <horoscope>${horoscope.summary}</horoscope>
        Relevant news stories are:
        ${relevantNewsStories.items.joinToString("\n") { "- ${it.url}: ${it.summary}" }}

        Format it as Markdown with links.
        """.trimIndent()
        )

}



================================================
FILE: examples-kotlin/src/main/kotlin/com/embabel/example/researcher/Researcher.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.researcher

import com.embabel.agent.api.annotation.*
import com.embabel.agent.api.common.OperationContext
import com.embabel.agent.api.common.create
import com.embabel.agent.api.models.AnthropicModels
import com.embabel.agent.api.models.OpenAiModels
import com.embabel.agent.core.CoreToolGroups
import com.embabel.agent.domain.io.UserInput
import com.embabel.agent.domain.library.ResearchReport
import com.embabel.agent.prompt.PromptUtils
import com.embabel.agent.prompt.ResponseFormat
import com.embabel.agent.prompt.persona.Persona
import com.embabel.common.ai.model.LlmOptions
import com.embabel.common.ai.model.ModelProvider.Companion.CHEAPEST_ROLE
import com.embabel.common.ai.prompt.PromptContributor
import com.embabel.common.ai.prompt.PromptContributorConsumer
import com.embabel.common.core.types.Timestamped
import org.slf4j.LoggerFactory
import org.springframework.boot.context.properties.ConfigurationProperties
import java.time.Instant

data class SingleLlmReport(
    val report: ResearchReport,
    val model: String,
) : Timestamped {
    override val timestamp: Instant = Instant.now()
}

data class Critique(
    val accepted: Boolean,
    val reasoning: String,
)


@ConfigurationProperties(prefix = "embabel.examples.researcher")
class ResearcherProperties(
    val responseFormat: ResponseFormat = ResponseFormat.MARKDOWN,
    val maxWordCount: Int = 300,
    val claudeModelName: String = AnthropicModels.CLAUDE_35_HAIKU,
    val openAiModelName: String = OpenAiModels.GPT_41_MINI,
    val criticModeName: String = OpenAiModels.GPT_41,
    val mergeModelName: String = OpenAiModels.GPT_41_MINI,
    personaName: String = "Sherlock",
    personaDescription: String = "A resourceful researcher agent that can perform deep web research on a topic. Nothing escapes Sherlock",
    personaVoice: String = "Your voice is dry and in the style of Sherlock Holmes. Occasionally you address the user as Watson",
    personaObjective: String = "To clarify all points the user has brought up",
) : PromptContributorConsumer {
    // Create a Persona instance rather than extending it
    val persona = Persona(personaName, personaDescription, personaVoice, personaObjective)

    override val promptContributors: List<PromptContributor>
        get() = listOf(
            responseFormat,
            persona,
        )
}

enum class Category {
    QUESTION,
    DISCUSSION,
}

data class Categorization(
    val category: Category,
)

/**
 * Researcher agent that implements the Embabel model for autonomous research.
 *
 * This agent demonstrates several key aspects of the Embabel framework:
 * 1. Multi-model approach - using both GPT-4 and Claude models for research
 * 2. Self-critique and improvement - evaluating reports and redoing research if needed
 * 3. Parallel execution - running multiple research actions concurrently
 * 4. Workflow control with conditions - using satisfactory/unsatisfactory conditions
 * 5. Model merging - combining results from different LLMs for better output
 *
 * The agent follows a structured workflow:
 * - First categorizes user input as a question or discussion topic
 * - Performs research using multiple LLM models in parallel
 * - Merges the research reports from different models
 * - Self-critiques the merged report
 * - If unsatisfactory, reruns research with specific models
 * - Delivers the final research report when satisfactory
 */
@Agent(
    description = "Perform deep web research on a topic",
)
class Researcher(
    val properties: ResearcherProperties,
) {

    private val logger = LoggerFactory.getLogger(Researcher::class.java)

    init {
        logger.info("Researcher agent initialized: $properties")
    }

    /**
     * Categorizes the user input to determine the appropriate research approach.
     * Uses the cheapest LLM model to efficiently classify the input.
     *
     * @param userInput The user's query or topic for research
     * @return Categorization of the input as either a QUESTION or DISCUSSION
     */
    @Action
    fun categorize(
        userInput: UserInput,
        context: OperationContext,
    ): Categorization = context.ai()
        .withLlmByRole(CHEAPEST_ROLE)
        .create(
            """
        Categorize the following user input:

        Topic:
        <${userInput.content}>
    """.trimIndent()
        )

    /**
     * Performs research using the GPT-4 model.
     * This is one of two parallel research paths (along with Claude).
     *
     * @param userInput The user's query or topic
     * @param categorization The categorization of the input
     * @param context The operation context for accessing tools and services
     * @return A research report with the GPT-4 model's findings
     */
    // These need a different output binding or only one will run
    @Action(
        post = [REPORT_SATISFACTORY],
        canRerun = true,
        outputBinding = "gpt4Report",
        toolGroups = [CoreToolGroups.WEB, CoreToolGroups.BROWSER_AUTOMATION]
    )
    fun researchWithGpt4(
        userInput: UserInput,
        categorization: Categorization,
        context: OperationContext,
    ): SingleLlmReport = researchWith(
        userInput = userInput,
        categorization = categorization,
        critique = null,
        llm = LlmOptions(properties.openAiModelName),
        context = context,
    )

    /**
     * Redoes research with GPT-4 after receiving an unsatisfactory critique.
     * This demonstrates the agent's ability to improve based on feedback.
     *
     * @param userInput The user's query or topic
     * @param categorization The categorization of the input
     * @param critique The critique of the previous report explaining why it was unsatisfactory
     * @param context The operation context for accessing tools and services
     * @return An improved research report with the GPT-4 model's findings
     */
    @Action(
        pre = [REPORT_UNSATISFACTORY],
        post = [REPORT_SATISFACTORY],
        canRerun = true,
        outputBinding = "gpt4Report",
        toolGroups = [CoreToolGroups.WEB, CoreToolGroups.BROWSER_AUTOMATION]
    )
    fun redoResearchWithGpt4(
        userInput: UserInput,
        categorization: Categorization,
        critique: Critique,
        context: OperationContext,
    ): SingleLlmReport = researchWith(
        userInput = userInput,
        categorization = categorization,
        critique = critique,
        llm = LlmOptions(properties.openAiModelName),
        context = context,
    )

    /**
     * Performs research using the Claude model.
     * This is one of two parallel research paths (along with GPT-4).
     *
     * @param userInput The user's query or topic
     * @param categorization The categorization of the input
     * @param context The operation context for accessing tools and services
     * @return A research report with the Claude model's findings
     */
    @Action(
        post = [REPORT_SATISFACTORY],
        outputBinding = "claudeReport",
        canRerun = true,
        toolGroups = [CoreToolGroups.WEB, CoreToolGroups.BROWSER_AUTOMATION]
    )
    fun researchWithClaude(
        userInput: UserInput,
        categorization: Categorization,
        context: OperationContext,
    ): SingleLlmReport = researchWith(
        userInput = userInput,
        categorization = categorization,
        critique = null,
        llm = LlmOptions(properties.claudeModelName),
        context = context,
    )

    /**
     * Redoes research with Claude after receiving an unsatisfactory critique.
     * This demonstrates the agent's ability to improve based on feedback.
     *
     * @param userInput The user's query or topic
     * @param categorization The categorization of the input
     * @param critique The critique of the previous report explaining why it was unsatisfactory
     * @param context The operation context for accessing tools and services
     * @return An improved research report with the Claude model's findings
     */
    @Action(
        pre = [REPORT_UNSATISFACTORY],
        post = [REPORT_SATISFACTORY],
        outputBinding = "claudeReport",
        canRerun = true,
        toolGroups = [CoreToolGroups.WEB, CoreToolGroups.BROWSER_AUTOMATION]
    )
    fun redoResearchWithClaude(
        userInput: UserInput,
        categorization: Categorization,
        critique: Critique,
        context: OperationContext,
    ): SingleLlmReport = researchWith(
        userInput = userInput,
        categorization = categorization,
        critique = critique,
        llm = LlmOptions(properties.claudeModelName),
        context = context,
    )

    /**
     * Common implementation for research with different models.
     * Routes to the appropriate research method based on categorization.
     *
     * @param userInput The user's query or topic
     * @param categorization The categorization of the input
     * @param critique Optional critique from a previous attempt
     * @param llm The LLM options including model selection
     * @param context The operation context for accessing tools and services
     * @return A research report with the specified model's findings
     */
    private fun researchWith(
        userInput: UserInput,
        categorization: Categorization,
        critique: Critique?,
        llm: LlmOptions,
        context: OperationContext,
    ): SingleLlmReport {
        val researchReport = when (
            categorization.category
        ) {
            Category.QUESTION -> answerQuestion(userInput, llm, critique, context)
            Category.DISCUSSION -> research(userInput, llm, critique, context)
        }
        return SingleLlmReport(
            report = researchReport,
            model = llm.criteria.toString(),
        )
    }

    /**
     * Generates a research report that answers a specific question.
     * Uses web tools to find precise answers with citations.
     *
     * @param userInput The user's question
     * @param llm The LLM options including model selection
     * @param critique Optional critique from a previous attempt
     * @param context The operation context for accessing tools and services
     * @return A research report answering the question
     */
    private fun answerQuestion(
        userInput: UserInput,
        llm: LlmOptions,
        critique: Critique?,
        context: OperationContext,
    ): ResearchReport = context.promptRunner(
        llm = llm,
        promptContributors = properties.promptContributors,
    ).create(
        """
        Use the web and browser tools to answer the given question.

        You must try to find the answer on the web, and be definite, not vague.

        Write a detailed report in at most ${properties.maxWordCount} words.
        If you can answer the question more briefly, do so.
        Including a number of links that are relevant to the topic.

        Example:
        ${PromptUtils.jsonExampleOf<ResearchReport>()}

        Question:
        <${userInput.content}>

        ${
            critique?.reasoning?.let {
                "Critique of previous answer:\n<$it>"
            }
        }
    """.trimIndent()
    )

    /**
     * Generates a research report on a discussion topic.
     * Uses web tools to gather information and provide a comprehensive overview.
     *
     * @param userInput The user's topic for research
     * @param llm The LLM options including model selection
     * @param critique Optional critique from a previous attempt
     * @param context The operation context for accessing tools and services
     * @return A research report on the topic
     */
    private fun research(
        userInput: UserInput,
        llm: LlmOptions,
        critique: Critique?,
        context: OperationContext,
    ): ResearchReport = context.promptRunner(
        llm = llm,
        promptContributors = properties.promptContributors,
    ).create(
        """
        Use the web and browser tools to perform deep research on the given topic.

        Write a detailed report in ${properties.maxWordCount} words,
        including a number of links that are relevant to the topic.

        Topic:
        <${userInput.content}>

         ${
            critique?.reasoning?.let {
                "Critique of previous answer:\n<$it>"
            }
        }
    """.trimIndent()
    )

    /**
     * Evaluates the quality of the merged research report.
     * This implements the self-critique capability of the Embabel model.
     *
     * @param userInput The user's original query or topic
     * @param mergedReport The combined report to evaluate
     * @return A critique with acceptance status and reasoning
     */
    @Action(post = [REPORT_SATISFACTORY], canRerun = true)
    fun critiqueMergedReport(
        userInput: UserInput,
        @RequireNameMatch mergedReport: ResearchReport,
        context: OperationContext,
    ): Critique = context.ai().withLlm(properties.criticModeName)
        .create(
            """
            Is this research report satisfactory? Consider the following question:
            <${userInput.content}>
            The report is satisfactory if it answers the question with adequate references.
            It is possible that the question does not have a clear answer, in which
            case the report is satisfactory if it provides a reasonable discussion of the topic.

            ${mergedReport.infoString(verbose = true)}
        """.trimIndent(),
        )

    /**
     * Combines the research reports from different models into a single, improved report.
     * This demonstrates the multi-model approach of the Embabel framework.
     *
     * @param userInput The user's original query or topic
     * @param gpt4Report The research report from the GPT-4 model
     * @param claudeReport The research report from the Claude model
     * @return A merged research report combining the best insights from both models
     */
    @Action(
        post = [REPORT_SATISFACTORY],
        outputBinding = "mergedReport",
        canRerun = true,
    )
    fun mergeReports(
        userInput: UserInput,
        @RequireNameMatch gpt4Report: SingleLlmReport,
        @RequireNameMatch claudeReport: SingleLlmReport,
        context: OperationContext,
    ): ResearchReport {
        val reports = listOf(
            gpt4Report,
            claudeReport,
        )
        return context.promptRunner(
            llm = LlmOptions(properties.criticModeName),
            promptContributors = properties.promptContributors,
        ).create(
            """
        Merge the following research reports into a single report taking the best of each.
        Consider the user direction: <${userInput.content}>

        ${reports.joinToString("\n\n") { "Report from ${it.model}\n${it.report.infoString(verbose = true)}" }}
    """.trimIndent()
        )
    }

    /**
     * Condition that determines if a report is satisfactory.
     * Used to control workflow progression.
     *
     * @param critique The critique of the report
     * @return True if the report is accepted as satisfactory
     */
    @Condition(name = REPORT_SATISFACTORY)
    fun makesTheGrade(
        critique: Critique,
    ): Boolean = critique.accepted

    /**
     * Condition that determines if a report is unsatisfactory.
     * Used to trigger rework of research.
     *
     * @param critique The critique of the report
     * @return True if the report is rejected as unsatisfactory
     */
    // TODO should be able to use !
    @Condition(name = REPORT_UNSATISFACTORY)
    fun rejected(
        critique: Critique,
    ): Boolean = !critique.accepted

    /**
     * Final action that accepts the research report as the agent's output.
     * This marks the successful completion of the research task.
     *
     * @param mergedReport The final merged research report
     * @param critique The positive critique confirming the report is satisfactory
     * @return The final research report
     */
    @AchievesGoal(
        description = "Completes a research or question answering task, producing a research report",
    )
    // TODO this won't complete without the output binding to a new thing.
    // This makes some sense but seems a bit surprising
    @Action(pre = [REPORT_SATISFACTORY], outputBinding = "finalResearchReport")
    fun acceptReport(
        @RequireNameMatch mergedReport: ResearchReport,
        critique: Critique,
    ) = mergedReport

    companion object {
        /** Condition name for when a report is satisfactory */
        const val REPORT_SATISFACTORY = "reportSatisfactory"

        /** Condition name for when a report is unsatisfactory */
        const val REPORT_UNSATISFACTORY = "reportUnsatisfactory"
    }
}



================================================
FILE: examples-kotlin/src/main/resources/application-observability.yml
================================================
# Observability configuration for Spring AI with tracing and logging
# This is a concern of the application, not the library and will be removed in future versions
spring:
  ai:
    chat:
      client:
        observations:
          log-prompt: false             # Enable ChatClient prompt logging
      observations:
        log-prompt: false               # Enable ChatModel prompt logging
        log-completion: false           # Enable ChatModel response logging
        include-error-logging: true     # Include error details
# Observability and tracing configuration
management:
  tracing:
    enabled: true
    sampling:
      probability: 1.0                 # Sample 100% of traces (use 0.1 for production)

  # Zipkin configuration
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans



================================================
FILE: examples-kotlin/src/main/resources/application.properties
================================================
spring.application.name=embabel-examples

embabel.models.default-llm=gpt-4.1-mini
embabel.models.llms.cheapest=gpt-4.1-nano


================================================
FILE: examples-kotlin/src/test/kotlin/com/embabel/example/horoscope/StarNewsFinderTest.kt
================================================
/*
 * Copyright 2024-2025 Embabel Software, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.embabel.example.horoscope

import com.embabel.agent.domain.library.NewsStory
import com.embabel.agent.domain.library.RelevantNewsStories
import com.embabel.agent.testing.unit.FakeOperationContext
import com.embabel.agent.testing.unit.UnitTestUtils
import com.embabel.example.horoscope.Horoscope
import com.embabel.example.horoscope.StarNewsFinder
import com.embabel.example.horoscope.StarPerson
import io.mockk.mockk
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test

class FakeHoroscopeService : HoroscopeService {

    override fun dailyHoroscope(sign: String): String {
        return "you will be chased by wolves"
    }
}


/**
 * Demonstrates unit testing of an agent
 */
class StarNewsFinderTest {

    @Nested
    inner class Writeup {

        @Test
        fun `writeup prompt must contain key data`() {
            val context = FakeOperationContext()
            val runner = context.promptRunner()

            context.expectResponse(Writeup("Things are gonna get frosty"))

            val wordCount = 100
            val starNewsFinder = StarNewsFinder(
                horoscopeService = mockk(),
                storyCount = 5,
                wordCount = wordCount,
            )
            val cockatoos =
                NewsStory(
                    url = "https://fake.com.au", title = "Cockatoo behavior",
                    summary = "Cockatoos are eating cabbages"
                )
            val emus =
                NewsStory(
                    url = "https://morefake.com.au", title = "Emu movements",
                    summary = "Emus are massing"
                )
            val starPerson = StarPerson(name = "Lynda", sign = "Scorpio")
            val relevantNewsStories = RelevantNewsStories(listOf(cockatoos, emus))

            starNewsFinder.starNewsWriteup(
                person = starPerson,
                relevantNewsStories = relevantNewsStories,
                horoscope = Horoscope("This is a good day for you"),
                context = context
            )

            val prompt = context.llmInvocations.first().messages.first().content
            val toolGroups = context.llmInvocations.first().interaction.toolGroups

            assertTrue(prompt.contains(starPerson.name))
            assertTrue(prompt.contains("Scorpio"))
            assertTrue(prompt.contains(cockatoos.summary))
            assertTrue(prompt.contains(emus.summary))
            assertTrue(prompt.contains(wordCount.toString()))
            assertTrue(
                toolGroups.isEmpty(),
                "The LLM should not have been given any tool groups",
            )
        }
    }

}



================================================
FILE: scripts/README.md
================================================
# Shell Scripts

This directory contains convenient shell scripts to run Embabel Agent examples in different modes.

## ğŸš€ Quick Start Scripts

### **Basic Shell Mode**
Run the application in interactive shell mode with basic agent features:

```bash
# Kotlin examples
cd kotlin && ./shell.sh          # Unix/Linux/macOS
cd kotlin && shell.cmd           # Windows

# Java examples  
cd java && ./shell.sh            # Unix/Linux/macOS
cd java && shell.cmd             # Windows
```

**Features Available:**
- âœ… Interactive command-line interface
- âœ… Basic agent workflows
- âœ… Web search and content generation
- âœ… Star Wars or Severance themed logging
- âš ï¸ **Limited toolset** - No Docker integration

### **Enhanced Shell Mode with Docker Tools**
Run the application with advanced Docker integration capabilities:

```bash
# Kotlin examples
cd kotlin && ./shell.sh --docker-tools     # Unix/Linux/macOS
cd kotlin && shell.cmd --docker-tools      # Windows

# Java examples
cd java && ./shell.sh --docker-tools       # Unix/Linux/macOS  
cd java && shell.cmd --docker-tools        # Windows
```

**Additional Features:**
- âœ… All basic shell features
- âœ… **Docker Desktop MCP integration**
- âœ… Container execution capabilities
- âœ… Advanced tool composition
- âœ… Expanded agent capabilities

### **MCP Server Mode**
Run agents as an MCP (Model Context Protocol) server:

```bash
# Kotlin examples
cd kotlin && ./mcp_server.sh     # Unix/Linux/macOS
cd kotlin && mcp_server.cmd      # Windows

# Java examples
cd java && ./mcp_server.sh       # Unix/Linux/macOS
cd java && mcp_server.cmd        # Windows
```

**Features:**
- ğŸ”§ Exposes agents as MCP-compatible tools
- ğŸŒ JSON-RPC communication via Server-Sent Events
- ğŸ”— Integration with Claude Desktop and other MCP clients
- ğŸ³ Docker Desktop integration included

---

## ğŸ¯ When to Use Each Mode

| Mode | Use Case | Best For |
|------|----------|----------|
| **Basic Shell** | Learning, development, testing | New users, simple workflows |
| **Shell + Docker Tools** | Advanced development, container workflows | Complex agents, Docker integration |
| **MCP Server** | Integration with external tools | Production use, Claude Desktop |

---

## ğŸ› ï¸ Script Architecture

All shell scripts follow a **Template Method Pattern** using shared components:

```
scripts/
â”œâ”€â”€ kotlin/
â”‚   â”œâ”€â”€ shell.sh              # Unified shell launcher with --docker-tools support
â”‚   â””â”€â”€ mcp_server.sh         # MCP server launcher
â”œâ”€â”€ java/
â”‚   â”œâ”€â”€ shell.sh              # Unified shell launcher with --docker-tools support  
â”‚   â””â”€â”€ mcp_server.sh         # MCP server launcher
â””â”€â”€ support/
    â”œâ”€â”€ shell_template.bat     # Shared shell logic (Windows)
    â”œâ”€â”€ agent.bat             # Application launcher (Windows)
    â”œâ”€â”€ agent.sh              # Application launcher (Unix)
    â””â”€â”€ check_env.sh/.bat     # Environment validation
```

### **How the Template System Works:**

1. **Language-specific scripts** (`kotlin/shell.cmd`, `java/shell.cmd`) set the application path
2. **Shared template** (`support/shell_template.bat`) handles parameter parsing and warnings
3. **Common launcher** (`support/agent.bat`) validates environment and runs Maven

This follows **Domain-Driven Design** principles with clear separation of concerns.

---

## ğŸ”§ Environment Requirements

### **API Keys** (Required)
Set at least one API key before running:

```bash
# OpenAI (recommended)
export OPENAI_API_KEY="your_openai_key"

# Or Anthropic Claude
export ANTHROPIC_API_KEY="your_anthropic_key"

# Or both for maximum compatibility
export OPENAI_API_KEY="your_openai_key"
export ANTHROPIC_API_KEY="your_anthropic_key"
```

### **Docker Integration** (Optional)
For `--docker-tools` functionality:

1. **Install Docker Desktop**
2. **Enable MCP Server** in Docker Desktop settings
3. **Pull required models:**
   ```bash
   docker login
   docker mcp gateway run
   ```

---

## ğŸš¨ Warning System

The scripts include **color-coded warnings** to help you understand feature availability:

**Without `--docker-tools`:**
```
ğŸ”´ WARNING: Only Basic Agent features will be available
ğŸŸ¡ Use --docker-tools parameter to enable advanced Docker integration features
```

**With `--docker-tools`:**
```
âœ… Starting application with profile: enable-shell-mcp-client
âœ… Application path: ../../examples-kotlin
```

---

## ğŸ› Troubleshooting

| Issue | Solution |
|-------|----------|
| **"Environment check failed"** | Set `OPENAI_API_KEY` or `ANTHROPIC_API_KEY` |
| **"AGENT_APPLICATION must be set"** | Use provided scripts, don't call `agent.bat` directly |
| **"POM file not found"** | Run from correct directory (`scripts/kotlin` or `scripts/java`) |
| **Red warning appears** | Add `--docker-tools` parameter for full features |
| **Docker tools fail** | Check Docker Desktop is running and MCP server is enabled |

---

## ğŸ“ Advanced Usage

### **Custom Maven Profiles**
The scripts use these Maven profiles under the hood:

- `enable-shell` - Basic shell mode
- `enable-shell-mcp-client` - Shell with Docker integration  
- `enable-agent-mcp-server` - MCP server mode

### **Manual Execution**
You can also run applications directly with Maven:

```bash
# From examples-kotlin/ or examples-java/
mvn -P enable-shell spring-boot:run
mvn -P enable-shell-mcp-client spring-boot:run  
mvn -P enable-agent-mcp-server spring-boot:run
```

---

## ğŸ“Š Script Comparison

| Script | Platform | Parameters | Profile Used |
|---------|----------|------------|--------------|
| `shell.sh` | Unix/Linux/macOS | `[--docker-tools]` | `enable-shell` or `enable-shell-mcp-client` |
| `shell.cmd` | Windows | `[--docker-tools]` | `enable-shell` or `enable-shell-mcp-client` |
| `mcp_server.sh` | Unix/Linux/macOS | None | `enable-agent-mcp-server` |
| `mcp_server.cmd` | Windows | None | `enable-agent-mcp-server` |

---

## ğŸ¤ Contributing

When adding new scripts:

1. **Follow the template pattern** - Use `shell_template.bat` for shared logic
2. **Add parameter validation** - Check for required environment variables
3. **Include helpful warnings** - Guide users toward correct usage
4. **Support both platforms** - Provide both `.sh` and `.cmd` versions
5. **Test thoroughly** - Verify on different operating systems

---

## ğŸ“„ License

Licensed under the Apache License 2.0. See [LICENSE](../LICENSE) for details.


================================================
FILE: scripts/java/mcp_server.cmd
================================================
@echo off
setlocal

set AGENT_APPLICATION=..\..\examples-java
set MAVEN_PROFILE=enable-agent-mcp-server

call ..\support\agent.bat

endlocal


================================================
FILE: scripts/java/mcp_server.sh
================================================
#!/usr/bin/env bash

export AGENT_APPLICATION=../../examples-java
export MAVEN_PROFILE=enable-agent-mcp-server

../support/agent.sh



================================================
FILE: scripts/java/shell.cmd
================================================
@echo off
setlocal

REM Check for help flag
if "%~1"=="--help" goto show_help
if "%~1"=="-h" goto show_help

set AGENT_APPLICATION=..\..\examples-java

call ..\support\shell_template.bat %*

endlocal
exit /b 0

:show_help
echo.
echo Java Agent Shell - Available Options:
echo.
echo   --help, -h              Show this help message
echo   --observability         Enable observability features (Zipkin tracing)
echo   --no-docker-tools       Disable Docker tool integration (basic features only)
echo.
echo Examples:
echo   shell.cmd
echo   shell.cmd --observability
echo   shell.cmd --observability --no-docker-tools
echo.
exit /b 0
endlocal



================================================
FILE: scripts/java/shell.sh
================================================
#!/usr/bin/env bash

# Resolve the directory this script is in
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Set the path relative to this script's directory
export AGENT_APPLICATION="$SCRIPT_DIR/../../examples-java"

# Check for help flag
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo
    echo "Java Agent Shell - Available Options:"
    echo
    echo "  --help, -h              Show this help message"
    echo "  --observability         Enable observability features (Zipkin tracing)"
    echo "  --no-docker-tools       Disable Docker tool integration (basic features only)"
    echo
    echo "Examples:"
    echo "  ./shell.sh"
    echo "  ./shell.sh --observability"
    echo "  ./shell.sh --observability --no-docker-tools"
    echo
    exit 0
fi

# Call the shell_template.sh relative to this script's location
"$SCRIPT_DIR/../support/shell_template.sh" "$@"



================================================
FILE: scripts/kotlin/mcp_server.cmd
================================================
@echo off
setlocal

set AGENT_APPLICATION=..\..\examples-kotlin
set MAVEN_PROFILE=enable-agent-mcp-server

call ..\support\agent.bat

endlocal


================================================
FILE: scripts/kotlin/mcp_server.sh
================================================
#!/usr/bin/env bash

export AGENT_APPLICATION=../../examples-kotlin
export MAVEN_PROFILE=enable-agent-mcp-server

../support/agent.sh



================================================
FILE: scripts/kotlin/shell.cmd
================================================
@echo off
setlocal

REM Check for help flag
if "%~1"=="--help" goto show_help
if "%~1"=="-h" goto show_help

set AGENT_APPLICATION=..\..\examples-kotlin

call ..\support\shell_template.bat %*

endlocal
exit /b 0

:show_help
echo.
echo Kotlin Agent Shell - Available Options:
echo.
echo   --help, -h              Show this help message
echo   --observability         Enable observability features (Zipkin tracing)
echo   --no-docker-tools       Disable Docker tool integration (basic features only)
echo.
echo Examples:
echo   shell.cmd
echo   shell.cmd --observability
echo   shell.cmd --observability --no-docker-tools
echo.
exit /b 0
endlocal



================================================
FILE: scripts/kotlin/shell.sh
================================================
#!/usr/bin/env bash

# Resolve the directory this script is in
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Set the path relative to this script's directory
export AGENT_APPLICATION="$SCRIPT_DIR/../../examples-kotlin"

# Check for help flag
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo
    echo "Kotlin Agent Shell - Available Options:"
    echo
    echo "  --help, -h              Show this help message"
    echo "  --observability         Enable observability features (Zipkin tracing)"
    echo "  --no-docker-tools       Disable Docker tool integration (basic features only)"
    echo
    echo "Examples:"
    echo "  ./shell.sh"
    echo "  ./shell.sh --observability"
    echo "  ./shell.sh --observability --no-docker-tools"
    echo
    exit 0
fi

# Call the shell_template.sh relative to this script's location
"$SCRIPT_DIR/../support/shell_template.sh" "$@"



================================================
FILE: scripts/support/agent.bat
================================================
@echo off
setlocal

set "SCRIPT_DIR=%~dp0"
set "ENV_SCRIPT=%SCRIPT_DIR%check_env.bat"

call "%SCRIPT_DIR%check_env.bat"

if errorlevel 1 (
    echo Environment check failed. Exiting...
    exit /b 1
)

if not defined AGENT_APPLICATION (
    echo ERROR: AGENT_APPLICATION environment variable is NOT set
    echo Please set it like: set AGENT_APPLICATION=path\to\your\project
    exit /b 1
)

if not defined MAVEN_PROFILE (
    echo ERROR: MAVEN_PROFILE environment variable is NOT set
    echo Please set it in the calling script
    exit /b 1
)

set "POM_FILE=%AGENT_APPLICATION%\pom.xml"

REM Display what we're running
echo Starting application with profile: %MAVEN_PROFILE%
echo Application path: %AGENT_APPLICATION%

if defined SPRING_PROFILES_ACTIVE (
    echo Spring profiles: %SPRING_PROFILES_ACTIVE%
)

REM Run Maven Spring Boot application
call ..\..\mvnw -U -P %MAVEN_PROFILE% -f "%POM_FILE%" -Dmaven.test.skip=true -Dspring.profiles.active=%SPRING_PROFILES_ACTIVE% clean spring-boot:run

endlocal



================================================
FILE: scripts/support/agent.sh
================================================
#!/bin/bash

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ENV_SCRIPT="$SCRIPT_DIR/check_env.sh"

# Call the environment check script
if [ -f "$ENV_SCRIPT" ]; then
    source "$ENV_SCRIPT"
    if [ $? -ne 0 ]; then
        echo "Environment check failed. Exiting..."
        exit 1
    fi
else
    echo "Warning: Environment check script not found at $ENV_SCRIPT"
fi

# Check if AGENT_APPLICATION environment variable is set
if [ -z "$AGENT_APPLICATION" ]; then
    echo "ERROR: AGENT_APPLICATION environment variable is NOT set"
    echo "Please set it like: export AGENT_APPLICATION=/path/to/your/project"
    exit 1
fi

# Check if MAVEN_PROFILE environment variable is set
if [ -z "$MAVEN_PROFILE" ]; then
    echo "ERROR: MAVEN_PROFILE environment variable is NOT set"
    echo "Please set it in the calling script"
    exit 1
fi

# Set the POM file path
POM_FILE="$AGENT_APPLICATION/pom.xml"

# Check if the POM file exists
if [ ! -f "$POM_FILE" ]; then
    echo "ERROR: POM file not found at $POM_FILE"
    exit 1
fi

# Display what we're running
echo "Starting application with profile: $MAVEN_PROFILE"
echo "Application path: $AGENT_APPLICATION"

if [ -n "$SPRING_PROFILES_ACTIVE" ]; then
    echo "Spring profiles: $SPRING_PROFILES_ACTIVE"
fi

# Run Maven Spring Boot application
$SCRIPT_DIR/../../mvnw -U -P "$MAVEN_PROFILE" -f "$POM_FILE" -Dmaven.test.skip=true -Dspring.profiles.active=$SPRING_PROFILES_ACTIVE clean spring-boot:run



================================================
FILE: scripts/support/check_env.bat
================================================
@echo off
:: Check environment variables
echo Checking environment variables...
set OPENAI_KEY_MISSING=false
set ANTHROPIC_KEY_MISSING=false

if "%OPENAI_API_KEY%"=="" (
    echo OPENAI_API_KEY environment variable is not set
    echo OpenAI models will not be available
    set OPENAI_KEY_MISSING=true
) else (
    echo OPENAI_API_KEY set: OpenAI models are available
)

if "%ANTHROPIC_API_KEY%"=="" (
    echo ANTHROPIC_API_KEY environment variable is not set
    echo Claude models will not be available
    set ANTHROPIC_KEY_MISSING=true
) else (
    echo ANTHROPIC_API_KEY set: Claude models are available
)

if "%OPENAI_KEY_MISSING%"=="true" if "%ANTHROPIC_KEY_MISSING%"=="true" (
    echo Ollama models will be used if available
    echo Please check Ollama installation and set default model in application.properties
    echo For example: embabel.models.default-llm=llama3.1:8b
)


================================================
FILE: scripts/support/check_env.sh
================================================

# Check environment variables

echo "Checking environment variables..."

OPENAI_KEY_MISSING=false
ANTHROPIC_KEY_MISSING=false

if [ -z "${OPENAI_API_KEY}" ]; then
    echo "OPENAI_API_KEY environment variable is not set"
    echo "OpenAI models will not be available"
    echo "Get an API key at https://platform.openai.com/api-keys"
    echo "Please set it with: export OPENAI_API_KEY=your_api_key"
    OPENAI_KEY_MISSING=true
else
    echo "OPENAI_API_KEY set: OpenAI models are available"
fi

if [ -z "${ANTHROPIC_API_KEY}" ]; then
    echo "ANTHROPIC_API_KEY environment variable is not set"
    echo "Claude models will not be available"
    echo "Get an API key at https://www.anthropic.com/api"
    echo "Please set it with: export ANTHROPIC_API_KEY=your_api_key"
    ANTHROPIC_KEY_MISSING=true
else
    echo "ANTHROPIC_API_KEY set: Claude models are available"
fi

if [ "$OPENAI_KEY_MISSING" = true ] && [ "$ANTHROPIC_KEY_MISSING" = true ]; then
    echo "ERROR: Both OPENAI_API_KEY and ANTHROPIC_API_KEY are missing."
    echo "At least one API key is required to use language models."
    echo "Please set at least one of these keys before running the application."
    exit 1
fi



================================================
FILE: scripts/support/shell_template.bat
================================================
@echo off
setlocal
REM This script requires AGENT_APPLICATION to be set by the calling script
if not defined AGENT_APPLICATION (
    echo ERROR: AGENT_APPLICATION must be set by calling script
    exit /b 1
)

REM Default: Docker tools enabled (reversed from original logic)
set MAVEN_PROFILE=enable-shell-mcp-client

REM Default: No observability profile
set SPRING_PROFILES_ACTIVE=

REM Check for optional parameters
:parse_args
if "%~1"=="" goto end_parse
if "%~1"=="--no-docker-tools" (
    set MAVEN_PROFILE=enable-shell
    shift
    goto parse_args
)
if "%~1"=="--observability" (
    set SPRING_PROFILES_ACTIVE=observability
    shift
    goto parse_args
)
REM Skip unknown parameters
shift
goto parse_args

:end_parse

REM Display startup message about Docker tools status
if "%MAVEN_PROFILE%"=="enable-shell-mcp-client" (
    powershell -Command "Write-Host 'INFO: Docker tools are enabled (default behavior)' -ForegroundColor Green"
    powershell -Command "Write-Host 'Use --no-docker-tools to disable Docker integration if needed' -ForegroundColor Cyan"
    echo.
)

REM Display feature availability warning when tools are disabled
if "%MAVEN_PROFILE%"=="enable-shell" (
    powershell -Command "Write-Host 'WARNING: Only Basic Agent features will be available' -ForegroundColor Red"
    powershell -Command "Write-Host 'Docker tools have been disabled. Remove --no-docker-tools to enable advanced features' -ForegroundColor Yellow"
    echo.
)

REM Display observability status
if defined SPRING_PROFILES_ACTIVE (
    powershell -Command "Write-Host 'INFO: Observability profile is enabled' -ForegroundColor Magenta"
    powershell -Command "Write-Host 'Make sure to run docker compose up to start Zipkin trace collector' -ForegroundColor Cyan"
    echo.
)

call %~dp0..\support\agent.bat
endlocal



================================================
FILE: scripts/support/shell_template.sh
================================================
#!/usr/bin/env bash
# This script requires AGENT_APPLICATION to be set by the calling script
if [ -z "$AGENT_APPLICATION" ]; then
    echo "ERROR: AGENT_APPLICATION must be set by calling script"
    exit 1
fi

# Default: Docker tools enabled (reversed from original logic)
export MAVEN_PROFILE=enable-shell-mcp-client

# Default: No observability profile
export SPRING_PROFILES_ACTIVE=""

# Check for optional parameters
while [[ $# -gt 0 ]]; do
    case $1 in
        --no-docker-tools)
            export MAVEN_PROFILE=enable-shell
            shift
            ;;
        --observability)
            export SPRING_PROFILES_ACTIVE=observability
            shift
            ;;
        *)
            # Skip unknown parameters
            shift
            ;;
    esac
done

# Display startup message about Docker tools status
if [ "$MAVEN_PROFILE" = "enable-shell-mcp-client" ]; then
    echo -e "\033[32mINFO: Docker tools are enabled (default behavior)\033[0m"
    echo -e "\033[36mUse --no-docker-tools to disable Docker integration if needed\033[0m"
    echo
fi

# Display feature availability warning when tools are disabled
if [ "$MAVEN_PROFILE" = "enable-shell" ]; then
    echo -e "\033[31mWARNING: Only Basic Agent features will be available\033[0m"
    echo -e "\033[33mDocker tools have been disabled. Remove --no-docker-tools to enable advanced features\033[0m"
    echo
fi

# Display observability status
if [ -n "$SPRING_PROFILES_ACTIVE" ]; then
    echo -e "\033[35mINFO: Observability profile is enabled\033[0m"
    echo -e "\033[36mMake sure to run 'docker compose up' to start Zipkin trace collector\033[0m"
    echo
fi

# Get the directory where this script is located and call agent.sh
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
"$SCRIPT_DIR/../support/agent.sh"



================================================
FILE: .embabel/make_scripts_executable.cmd
================================================
@echo off

REM Simple script to make Embabel Agent shell scripts executable
REM No complex variables - just straightforward commands

echo ğŸ”§ Making Embabel Agent shell scripts executable...

cd ..

REM Check if we're in the right directory
if not exist "scripts" (
    echo âŒ ERROR: scripts directory not found
    echo Please run this from the project root directory
    exit /b 1
)

REM Check if in git repository
git status >nul 2>&1
if errorlevel 1 (
    echo âŒ ERROR: Not in a git repository
    exit /b 1
)

echo.
echo ğŸ“‚ Processing scripts...

REM Process each known script individually
if exist "scripts\kotlin\shell.sh" (
    echo Making executable: scripts/kotlin/shell.sh
    git update-index --chmod=+x "scripts/kotlin/shell.sh"
) else (
    echo âš ï¸  Not found: scripts/kotlin/shell.sh
)

if exist "scripts\kotlin\mcp_server.sh" (
    echo Making executable: scripts/kotlin/mcp_server.sh
    git update-index --chmod=+x "scripts/kotlin/mcp_server.sh"
) else (
    echo âš ï¸  Not found: scripts/kotlin/mcp_server.sh
)

if exist "scripts\java\shell.sh" (
    echo Making executable: scripts/java/shell.sh
    git update-index --chmod=+x "scripts/java/shell.sh"
) else (
    echo âš ï¸  Not found: scripts/java/shell.sh
)

if exist "scripts\java\mcp_server.sh" (
    echo Making executable: scripts/java/mcp_server.sh
    git update-index --chmod=+x "scripts/java/mcp_server.sh"
) else (
    echo âš ï¸  Not found: scripts/java/mcp_server.sh
)

if exist "scripts\support\agent.sh" (
    echo Making executable: scripts/support/agent.sh
    git update-index --chmod=+x "scripts/support/agent.sh"
) else (
    echo âš ï¸  Not found: scripts/support/agent.sh
)

if exist "scripts\support\check_env.sh" (
    echo Making executable: scripts/support/check_env.sh
    git update-index --chmod=+x "scripts/support/check_env.sh"
) else (
    echo âš ï¸  Not found: scripts/support/check_env.sh
)

if exist "scripts\support\shell_template.sh" (
    echo Making executable: scripts/support/shell_template.sh
    git update-index --chmod=+x "scripts/support/shell_template.sh"
) else (
    echo âš ï¸  Not found: scripts/support/shell_template.sh
)

echo.
echo âœ… Processing complete!

REM Check if there are changes to commit
git diff --cached --quiet
if errorlevel 1 (
    echo.
    echo ğŸ“‹ Scripts now marked as executable:
    git diff --cached --name-only
    
    echo.
    echo ğŸ’¡ Next steps:
    echo    git commit -m "Make shell scripts executable"
    echo    git push
    
    echo.
    echo ğŸ‰ Users will get executable scripts when they clone the repository!
) else (
    echo.
    echo â„¹ï¸  All scripts were already executable - no changes needed
)

echo.
echo ğŸ§ª Users can test with:
echo    cd scripts\kotlin ^&^& bash shell.sh --docker-tools
echo    cd scripts\java ^&^& bash shell.sh --docker-tools


================================================
FILE: .github/workflows/maven.yml
================================================
# This workflow will build a Java / Kotlin project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Build

on:
  push:
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Configure Testcontainers
        run: |
          mkdir -p /home/runner
          echo "testcontainers.reuse.enable=true" > /home/runner/.testcontainers.properties
      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -U -B test verify



================================================
FILE: .mvn/wrapper/maven-wrapper.properties
================================================
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
wrapperVersion=3.9.6
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.6/apache-maven-3.9.6-bin.zip


